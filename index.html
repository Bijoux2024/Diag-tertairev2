<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagTertiaire - Pré-diagnostic énergétique tertiaire</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root {
        --color-action: #2563EB;
        --color-action-hover: #1D4ED8;
        --color-action-light: #EFF6FF;
        --color-neutral-50: #F8FAFC;
        --color-neutral-100: #F1F5F9;
        --color-neutral-200: #E2E8F0;
        --color-neutral-300: #CBD5E1;
        --color-neutral-400: #94A3B8;
        --color-neutral-500: #64748B;
        --color-neutral-600: #475569;
        --color-neutral-700: #334155;
        --color-neutral-800: #1E293B;
        --color-neutral-900: #0F172A;
        --color-success: #10B981;
        --color-warning: #F59E0B;
        --color-error: #EF4444;
        --color-info: #3B82F6;
        --color-owner: #2563EB;
        --color-tenant: #8B5CF6;
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
        --space-2xl: 3rem;
        --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --shadow-cta: 0 4px 14px 0 rgba(37, 99, 235, 0.25);
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: var(--font-sans);
        background-color: var(--color-neutral-50);
        color: var(--color-neutral-700);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        line-height: 1.6;
      }
      .fade-in { animation: fadeIn 0.4s ease-out forwards; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .blur-overlay { filter: blur(5px); pointer-events: none; user-select: none; }
      @media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { background: white; }
        nav { display: none; }
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script id="diag-copy" type="application/json">
    {
      "common": {
        "ctaPrimaryLabel": "Lancer le diagnostic",
        "ctaSecondaryApproach": "Voir l'approche",
        "ctaSecondaryExample": "Voir un exemple de rapport",
        "accordionCollapsedLabel": "Voir le détail",
        "accordionExpandedLabel": "Masquer le détail"
      },
      "home": {
        "hero": {
          "title": "Anticipez vos économies d'énergie en 3 minutes",
          "subtitle": "Un pré-diagnostic gratuit pour identifier vos gisements d'économies et prioriser vos actions",
          "badges": [
            "Temps estimé 3 minutes",
            "Sans inscription",
            "Email requis pour recevoir le rapport"
          ]
        },
        "segmentation": {
          "title": "Qui êtes-vous ?",
          "owner": {
            "label": "Propriétaire",
            "desc": "Valorisez votre patrimoine, réduisez vos charges"
          },
          "tenant": {
            "label": "Locataire exploitant",
            "desc": "Maîtrisez vos coûts, optimisez vos usages"
          }
        },
        "whoIsItFor": {
          "title": "Pour qui ?",
          "items": [
            "Propriétaires de locaux tertiaires",
            "Locataires exploitants",
            "Gestionnaires de patrimoine",
            "Professionnels de l'immobilier"
          ]
        },
        "whatYouGet": {
          "title": "Ce que vous obtenez",
          "items": [
            "Estimation de votre consommation énergétique",
            "Comparaison avec des références sectorielles",
            "Top 3 des actions prioritaires",
            "Projection des économies sur 5 et 10 ans"
          ]
        },
        "howItWorks": {
          "title": "Comment ça marche ?",
          "steps": [
            "Renseignez vos données (activité, surface, énergie)",
            "Recevez votre pré-diagnostic par email",
            "Identifiez vos actions prioritaires",
            "Préparez votre audit ou vos travaux"
          ]
        },
        "whatIsItFor": {
          "title": "À quoi ça sert concrètement ?",
          "items": [
            "Cadrer un besoin avant audit détaillé",
            "Prioriser les premières actions",
            "Préparer une discussion avec un expert",
            "Arbitrer un budget de rénovation"
          ]
        }
      },
      "approche": {
        "hero": {
          "title": "Notre approche",
          "subtitle": "Un pré-diagnostic transparent, basé sur des références publiques"
        },
        "whatYouProvide": {
          "title": "Ce que vous renseignez",
          "items": [
            "Activité principale du site",
            "Surface et nombre de niveaux",
            "Consommations énergétiques (si disponibles)",
            "Travaux déjà réalisés"
          ]
        },
        "whatWeDeliver": {
          "title": "Ce que nous produisons",
          "items": [
            "Estimation de votre intensité énergétique (kWh/m²/an)",
            "Positionnement par rapport à des références sectorielles",
            "Répartition indicative par postes (chauffage, éclairage, etc.)",
            "Top 3 des actions avec gains et ROI indicatifs"
          ]
        },
        "howWePrioritize": {
          "title": "Comment on priorise",
          "items": [
            "Impact énergétique (économies potentielles)",
            "Faisabilité technique",
            "Retour sur investissement",
            "Exclusion des actions déjà réalisées"
          ]
        },
        "transparency": {
          "title": "Transparence et limites",
          "items": [
            "Pré-diagnostic, non substituable à un audit",
            "Benchmarks issus de données publiques",
            "Répartition par postes indicative (non mesurée)",
            "Gains et ROI indicatifs à confirmer"
          ]
        }
      },
      "rapportPublic": {
        "hero": {
          "title": "À quoi ressemble le rapport ?",
          "subtitle": "Un exemple concret pour comprendre ce que vous recevrez"
        },
        "reportPreview": {
          "title": "Aperçu du rapport",
          "annotations": [
            "Vue d'ensemble",
            "Top actions",
            "Projection et plan"
          ]
        },
        "overview": {
          "title": "Ce que vous verrez",
          "items": [
            "Votre consommation totale et intensité énergétique",
            "Comparaison avec des bâtiments similaires",
            "Répartition indicative par postes",
            "Score de confiance des données"
          ]
        },
        "actions": {
          "title": "Actions prioritaires",
          "items": [
            "Top 3 des actions adaptées à votre profil",
            "Gains énergétiques et économies estimées",
            "Fourchette de coûts et ROI indicatif",
            "Aides mobilisables (CEE, MaPrimeRénov'...)"
          ]
        },
        "projection": {
          "title": "Projection et plan",
          "items": [
            "Économies cumulées sur 5 et 10 ans",
            "Plan d'action en 4 étapes",
            "Segmentation propriétaire / locataire",
            "Hypothèses et limites du calcul"
          ]
        }
      }
    }
    </script>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useRef, useMemo } = React;

      const DIAG_COPY = (() => {
        try {
          const scriptEl = document.getElementById('diag-copy');
          if (!scriptEl) return {};
          return JSON.parse(scriptEl.textContent);
        } catch (e) {
          console.error('DIAG_COPY parse error', e);
          return {};
        }
      })();

      const getCopy = (path) => {
        const parts = path.split('.');
        let current = DIAG_COPY;
        for (let i = 0; i < parts.length; i++) {
          if (current && typeof current === 'object' && parts[i] in current) {
            current = current[parts[i]];
          } else {
            return path;
          }
        }
        return current;
      };

      const CONFIG = {
        VERSION: '1.0.0',
        ASSET_BASE: './assets/',
        TRACKING_ENABLED: true
      };

      const track = (event, data = {}) => {
        if (!CONFIG.TRACKING_ENABLED) return;
        console.log('[TRACK]', event, data);
      };

      const Icon = ({ icon, className = "" }) => (
        <iconify-icon icon={icon} className={className} />
      );

      const Button = ({ children, onClick, variant = 'primary', className = '', fullWidth = false }) => {
        const variants = {
          primary: 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl',
          secondary: 'text-neutral-600 hover:text-neutral-900 underline',
          ghost: 'bg-neutral-100 text-neutral-700 hover:bg-neutral-200'
        };
        return (
          <button 
            onClick={onClick}
            className={`px-6 py-3 rounded-lg font-semibold transition-all duration-200 ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`}
            style={variant === 'primary' ? { boxShadow: 'var(--shadow-cta)' } : {}}
          >
            {children}
          </button>
        );
      };

      const Badge = ({ children, icon }) => (
        <span className="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
          {icon && <Icon icon={icon} className="text-base" />}
          {children}
        </span>
      );

      const Accordion = ({ title, children, defaultOpen = false }) => {
        const [isOpen, setIsOpen] = useState(defaultOpen);
        return (
          <div className="border border-neutral-200 rounded-lg overflow-hidden hover:border-neutral-300 transition-colors">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full px-6 py-4 bg-white hover:bg-neutral-50 flex items-center justify-between text-left transition-colors"
            >
              <span className="font-semibold text-neutral-900">{title}</span>
              <span className="text-sm text-neutral-500 flex items-center gap-2">
                {isOpen ? getCopy('common.accordionExpandedLabel') : getCopy('common.accordionCollapsedLabel')}
                <Icon icon={isOpen ? "solar:alt-arrow-up-linear" : "solar:alt-arrow-down-linear"} className="text-lg" />
              </span>
            </button>
            {isOpen && (
              <div className="px-6 py-4 bg-neutral-50 border-t border-neutral-100">
                {children}
              </div>
            )}
          </div>
        );
      };

      const Section = ({ title, children, className = '', background = 'white' }) => {
        const bgClasses = {
          white: 'bg-white',
          neutral: 'bg-neutral-50',
          blue: 'bg-blue-50'
        };
        return (
          <section className={`py-16 px-4 ${bgClasses[background]} ${className}`}>
            <div className="max-w-4xl mx-auto">
              {title && <h2 className="text-3xl md:text-4xl font-bold text-neutral-900 mb-12 text-center">{title}</h2>}
              {children}
            </div>
          </section>
        );
      };

      const ReportPreview = ({ annotations }) => (
        <div className="relative bg-gradient-to-br from-neutral-100 to-neutral-200 rounded-xl p-8 aspect-[4/3] flex items-center justify-center">
          <div className="text-center">
            <Icon icon="solar:document-text-linear" className="text-8xl text-neutral-400 mb-4" />
            <p className="text-neutral-600 font-medium">Aperçu du rapport</p>
            <p className="text-xs text-neutral-400 mt-2">Screenshot à venir</p>
          </div>
          {annotations && annotations.map((label, i) => (
            <div 
              key={i}
              className="absolute w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-lg"
              style={{
                top: `${15 + i * 30}%`,
                left: `${10 + i * 30}%`
              }}
            >
              {i + 1}
            </div>
          ))}
        </div>
      );

      const PageHome = ({ navigate }) => {
        const [selectedRole, setSelectedRole] = useState(null);

        useEffect(() => {
          track('view_home');
        }, []);

        return (
          <div className="fade-in">
            <section className="py-20 px-4 bg-gradient-to-b from-neutral-50 via-white to-neutral-50">
              <div className="max-w-5xl mx-auto text-center">
                <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold text-neutral-900 mb-6 leading-tight">
                  {getCopy('home.hero.title')}
                </h1>
                <p className="text-xl md:text-2xl text-neutral-600 mb-8 max-w-3xl mx-auto leading-relaxed">
                  {getCopy('home.hero.subtitle')}
                </p>
                <div className="flex flex-wrap justify-center gap-3 mb-10">
                  {getCopy('home.hero.badges').slice(0, 3).map((badge, i) => (
                    <Badge key={i}>{badge}</Badge>
                  ))}
                </div>
                <Button 
                  variant="primary"
                  onClick={() => {
                    track('cta_primary_home');
                    navigate('diagnostic');
                  }}
                  className="mb-6 text-lg px-10 py-4"
                >
                  {getCopy('common.ctaPrimaryLabel')}
                </Button>
                <div>
                  <Button 
                    variant="secondary"
                    onClick={() => navigate('rapportPublic')}
                  >
                    {getCopy('common.ctaSecondaryExample')}
                  </Button>
                </div>
              </div>
            </section>

            <Section title={getCopy('home.segmentation.title')} background="neutral">
              <div className="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                {['owner', 'tenant'].map((type) => (
                  <button
                    key={type}
                    onClick={() => setSelectedRole(type)}
                    className={`p-6 rounded-xl border-2 transition-all text-left ${
                      selectedRole === type 
                        ? type === 'owner' 
                          ? 'border-blue-600 bg-blue-50' 
                          : 'border-purple-600 bg-purple-50'
                        : 'border-neutral-200 hover:border-neutral-300 bg-white'
                    }`}
                  >
                    <Icon 
                      icon={type === 'owner' ? 'solar:home-linear' : 'solar:case-linear'} 
                      className={`text-3xl mb-3 ${
                        selectedRole === type 
                          ? type === 'owner' ? 'text-blue-600' : 'text-purple-600'
                          : 'text-neutral-400'
                      }`}
                    />
                    <h3 className="font-semibold text-lg mb-2 text-neutral-900">
                      {getCopy(`home.segmentation.${type}.label`)}
                    </h3>
                    <p className="text-sm text-neutral-600">
                      {getCopy(`home.segmentation.${type}.desc`)}
                    </p>
                  </button>
                ))}
              </div>
            </Section>

            <Section title={getCopy('home.whoIsItFor.title')} background="white">
              <ul className="space-y-4 max-w-2xl mx-auto">
                {getCopy('home.whoIsItFor.items').map((item, i) => (
                  <li key={i} className="flex items-center gap-4 text-lg text-neutral-700">
                    <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                      <Icon icon="solar:check-circle-bold" className="text-blue-600 text-xl" />
                    </div>
                    {item}
                  </li>
                ))}
              </ul>
            </Section>

            <Section title={getCopy('home.whatYouGet.title')} background="neutral">
              <div className="grid md:grid-cols-2 gap-6">
                {getCopy('home.whatYouGet.items').map((item, i) => (
                  <div key={i} className="p-6 bg-white rounded-xl border border-neutral-200 hover:border-blue-200 transition-colors">
                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                      <Icon icon="solar:shield-check-bold" className="text-blue-600 text-2xl" />
                    </div>
                    <p className="text-neutral-700 leading-relaxed">{item}</p>
                  </div>
                ))}
              </div>
            </Section>

            <Section title={getCopy('home.howItWorks.title')} background="white">
              <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                {getCopy('home.howItWorks.steps').map((step, i) => (
                  <div key={i} className="text-center">
                    <div className="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-2xl flex items-center justify-center text-2xl font-bold mx-auto mb-4 shadow-lg">
                      {i + 1}
                    </div>
                    <p className="text-neutral-700 leading-relaxed">{step}</p>
                  </div>
                ))}
              </div>
            </Section>

            <Section title={getCopy('home.whatIsItFor.title')} background="neutral">
              <ul className="space-y-4 max-w-2xl mx-auto">
                {getCopy('home.whatIsItFor.items').map((item, i) => (
                  <li key={i} className="flex items-start gap-4 text-lg text-neutral-700">
                    <div className="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <Icon icon="solar:lightbulb-bolt-linear" className="text-yellow-600 text-xl" />
                    </div>
                    {item}
                  </li>
                ))}
              </ul>
            </Section>

            <section className="py-20 px-4 bg-gradient-to-br from-blue-600 to-blue-700 text-white">
              <div className="max-w-3xl mx-auto text-center">
                <h2 className="text-3xl md:text-4xl font-bold mb-6">Prêt à démarrer ?</h2>
                <p className="text-lg text-blue-100 mb-8">Lancez votre pré-diagnostic en 3 minutes</p>
                <Button 
                  variant="primary"
                  onClick={() => navigate('diagnostic')}
                  className="bg-white text-blue-600 hover:bg-neutral-100 shadow-2xl text-lg px-10 py-4"
                >
                  {getCopy('common.ctaPrimaryLabel')}
                </Button>
              </div>
            </section>

            <footer className="py-8 px-4 bg-neutral-900 text-neutral-400 text-sm text-center">
              <p className="mb-2">DiagTertiaire - Pré-diagnostic énergétique</p>
              <button 
                onClick={() => navigate('pro')}
                className="text-neutral-500 hover:text-neutral-300 underline transition-colors"
              >
                Espace Pro
              </button>
            </footer>
          </div>
        );
      };

      const PageApproche = ({ navigate }) => {
        useEffect(() => {
          track('view_approche');
        }, []);

        return (
          <div className="fade-in">
            <section className="py-20 px-4 bg-gradient-to-b from-blue-600 to-blue-700 text-white">
              <div className="max-w-4xl mx-auto text-center">
                <h1 className="text-4xl md:text-5xl font-bold mb-4">
                  {getCopy('approche.hero.title')}
                </h1>
                <p className="text-xl text-blue-100">
                  {getCopy('approche.hero.subtitle')}
                </p>
              </div>
            </section>

            <Section title={getCopy('approche.whatYouProvide.title')} background="white">
              <ul className="space-y-4 max-w-2xl mx-auto">
                {getCopy('approche.whatYouProvide.items').map((item, i) => (
                  <li key={i} className="flex items-center gap-4 text-lg text-neutral-700">
                    <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                      <Icon icon="solar:document-add-linear" className="text-green-600 text-xl" />
                    </div>
                    {item}
                  </li>
                ))}
              </ul>
            </Section>

            <Section title={getCopy('approche.whatWeDeliver.title')} background="neutral">
              <ul className="space-y-4 max-w-2xl mx-auto">
                {getCopy('approche.whatWeDeliver.items').map((item, i) => (
                  <li key={i} className="flex items-center gap-4 text-lg text-neutral-700">
                    <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                      <Icon icon="solar:chart-2-linear" className="text-blue-600 text-xl" />
                    </div>
                    {item}
                  </li>
                ))}
              </ul>
            </Section>

            <Section title={getCopy('approche.howWePrioritize.title')} background="white">
              <div className="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                {getCopy('approche.howWePrioritize.items').map((item, i) => (
                  <div key={i} className="p-6 bg-neutral-50 rounded-xl border border-neutral-200">
                    <div className="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center mb-4 font-bold">
                      {i + 1}
                    </div>
                    <p className="text-neutral-700 leading-relaxed">{item}</p>
                  </div>
                ))}
              </div>
            </Section>

            <Section title={getCopy('approche.transparency.title')} background="neutral">
              <div className="space-y-4 max-w-3xl mx-auto">
                {getCopy('approche.transparency.items').map((item, i) => (
                  <Accordion key={i} title={item}>
                    <p className="text-sm text-neutral-600 leading-relaxed">
                      Cette approche permet d'obtenir un ordre de grandeur fiable pour prioriser vos actions, tout en assumant les limites d'un pré-diagnostic.
                    </p>
                  </Accordion>
                ))}
              </div>
            </Section>

            <section className="py-16 px-4 bg-white">
              <div className="max-w-3xl mx-auto text-center">
                <h2 className="text-3xl font-bold text-neutral-900 mb-6">Prêt à tester ?</h2>
                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                  <Button 
                    variant="primary"
                    onClick={() => navigate('diagnostic')}
                  >
                    {getCopy('common.ctaPrimaryLabel')}
                  </Button>
                  <Button 
                    variant="secondary"
                    onClick={() => navigate('rapportPublic')}
                  >
                    {getCopy('common.ctaSecondaryExample')}
                  </Button>
                </div>
              </div>
            </section>

            <footer className="py-8 px-4 bg-neutral-900 text-neutral-400 text-sm text-center">
              <button 
                onClick={() => navigate('home')}
                className="text-neutral-500 hover:text-neutral-300 underline"
              >
                Retour à l'accueil
              </button>
            </footer>
          </div>
        );
      };

      const PageRapportPublic = ({ navigate }) => {
        useEffect(() => {
          track('view_rapport_public');
        }, []);

        return (
          <div className="fade-in">
            <section className="py-20 px-4 bg-gradient-to-b from-neutral-50 to-white">
              <div className="max-w-4xl mx-auto text-center">
                <h1 className="text-4xl md:text-5xl font-bold text-neutral-900 mb-4">
                  {getCopy('rapportPublic.hero.title')}
                </h1>
                <p className="text-xl text-neutral-600 mb-12">
                  {getCopy('rapportPublic.hero.subtitle')}
                </p>
              </div>
            </section>

            <Section background="white">
              <div className="mb-12">
                <h3 className="text-2xl font-bold text-neutral-900 mb-8 text-center">
                  {getCopy('rapportPublic.reportPreview.title')}
                </h3>
                <ReportPreview annotations={getCopy('rapportPublic.reportPreview.annotations')} />
                <div className="mt-6 grid md:grid-cols-3 gap-4 max-w-2xl mx-auto">
                  {getCopy('rapportPublic.reportPreview.annotations').map((label, i) => (
                    <div key={i} className="flex items-center gap-3 text-sm text-neutral-600">
                      <div className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                        {i + 1}
                      </div>
                      {label}
                    </div>
                  ))}
                </div>
              </div>
            </Section>

            <Section title={getCopy('rapportPublic.overview.title')} background="neutral">
              <div className="space-y-4 max-w-3xl mx-auto">
                {getCopy('rapportPublic.overview.items').map((item, i) => (
                  <Accordion key={i} title={item}>
                    <p className="text-sm text-neutral-600 leading-relaxed">
                      Ces informations vous permettent de comprendre où vous vous situez par rapport aux références de votre secteur.
                    </p>
                  </Accordion>
                ))}
              </div>
            </Section>

            <Section title={getCopy('rapportPublic.actions.title')} background="white">
              <div className="space-y-4 max-w-3xl mx-auto">
                {getCopy('rapportPublic.actions.items').map((item, i) => (
                  <Accordion key={i} title={item}>
                    <p className="text-sm text-neutral-600 leading-relaxed">
                      Chaque action est accompagnée d'estimations de gains et de coûts pour vous aider à prioriser.
                    </p>
                  </Accordion>
                ))}
              </div>
            </Section>

            <Section title={getCopy('rapportPublic.projection.title')} background="neutral">
              <div className="space-y-4 max-w-3xl mx-auto">
                {getCopy('rapportPublic.projection.items').map((item, i) => (
                  <Accordion key={i} title={item}>
                    <p className="text-sm text-neutral-600 leading-relaxed">
                      Ces projections vous donnent une vision à moyen et long terme de vos économies potentielles.
                    </p>
                  </Accordion>
                ))}
              </div>
            </Section>

            <section className="py-16 px-4 bg-blue-600 text-white">
              <div className="max-w-3xl mx-auto text-center">
                <h2 className="text-3xl font-bold mb-4">Envie de votre propre rapport ?</h2>
                <p className="text-lg text-blue-100 mb-8">Lancez votre diagnostic personnalisé maintenant</p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                  <Button 
                    variant="primary"
                    onClick={() => navigate('diagnostic')}
                    className="bg-white text-blue-600 hover:bg-neutral-100 shadow-2xl"
                  >
                    {getCopy('common.ctaPrimaryLabel')}
                  </Button>
                  <Button 
                    variant="secondary"
                    onClick={() => navigate('approche')}
                    className="text-white hover:text-blue-100"
                  >
                    {getCopy('common.ctaSecondaryApproach')}
                  </Button>
                </div>
              </div>
            </section>

            <section className="py-8 px-4 bg-neutral-50 border-t border-neutral-200">
              <div className="max-w-4xl mx-auto">
                <p className="text-xs text-neutral-500 text-center leading-relaxed">
                  Pré-diagnostic indicatif basé sur des données publiques. Non substituable à un audit énergétique réglementaire.
                </p>
              </div>
            </section>

            <footer className="py-8 px-4 bg-neutral-900 text-neutral-400 text-sm text-center">
              <button 
                onClick={() => navigate('home')}
                className="text-neutral-500 hover:text-neutral-300 underline"
              >
                Retour à l'accueil
              </button>
            </footer>
          </div>
        );
      };

      const App = () => {
        const [currentPage, setCurrentPage] = useState('home');

        const navigate = (page) => {
          setCurrentPage(page);
          window.scrollTo({ top: 0, behavior: 'smooth' });
          track('navigate', { to: page });
        };

        return (
          <div className="min-h-screen">
            <nav className="bg-white border-b border-neutral-200 px-4 py-4 sticky top-0 z-50 no-print shadow-sm">
              <div className="max-w-7xl mx-auto flex items-center justify-between">
                <button 
                  onClick={() => navigate('home')}
                  className="text-2xl font-bold text-blue-600 hover:text-blue-700 transition-colors"
                >
                  DiagTertiaire
                </button>
                <div className="flex gap-8 text-sm font-medium">
                  <button 
                    onClick={() => navigate('home')}
                    className={`transition-colors ${currentPage === 'home' ? 'text-blue-600' : 'text-neutral-600 hover:text-neutral-900'}`}
                  >
                    Accueil
                  </button>
                  <button 
                    onClick={() => navigate('approche')}
                    className={`transition-colors ${currentPage === 'approche' ? 'text-blue-600' : 'text-neutral-600 hover:text-neutral-900'}`}
                  >
                    Approche
                  </button>
                  <button 
                    onClick={() => navigate('rapportPublic')}
                    className={`transition-colors ${currentPage === 'rapportPublic' ? 'text-blue-600' : 'text-neutral-600 hover:text-neutral-900'}`}
                  >
                    Exemple
                  </button>
                </div>
              </div>
            </nav>

            <main>
              {currentPage === 'home' && <PageHome navigate={navigate} />}
              {currentPage === 'approche' && <PageApproche navigate={navigate} />}
              {currentPage === 'rapportPublic' && <PageRapportPublic navigate={navigate} />}
              {currentPage === 'diagnostic' && (
                <div className="py-20 px-4">
                  <div className="max-w-2xl mx-auto text-center">
                    <h1 className="text-3xl font-bold text-neutral-900 mb-4">Diagnostic</h1>
                    <p className="text-neutral-600 mb-8">Formulaire à implémenter (Phase 2)</p>
                    <Button variant="secondary" onClick={() => navigate('home')}>
                      Retour à l'accueil
                    </Button>
                  </div>
                </div>
              )}
              {currentPage === 'pro' && (
                <div className="py-20 px-4">
                  <div className="max-w-2xl mx-auto text-center">
                    <h1 className="text-3xl font-bold text-neutral-900 mb-4">Espace Pro</h1>
                    <p className="text-neutral-600 mb-8">Page à implémenter (Phase 5)</p>
                    <Button variant="secondary" onClick={() => navigate('home')}>
                      Retour à l'accueil
                    </Button>
                  </div>
                </div>
              )}
            </main>
          </div>
        );
      };

// ⛔ Ne pas fermer le script ici.
// Le rendu React est déplacé à la toute fin du fichier.
/* ═══════════════════════════════════════════════════════════════════════════
   PHASE 3 : MOTEUR DE CALCUL - TABLES MÉTIER
   
   4 tables avec source_level obligatoire :
   1. energy_prices - Conversion € → kWh
   2. benchmarks_intensity - Médiane + Q1/Q3 par activité
   3. usage_breakdowns - Répartition postes (indicatif)
   4. actions_library - 12 actions minimum
   
   ═══════════════════════════════════════════════════════════════════════════ */

/* ─────────────────────────────────────────────────────────────────────────
   TABLE 1 : ENERGY_PRICES
   ───────────────────────────────────────────────────────────────────────── */

const ENERGY_PRICES = {
  version_tag: 'v1.0-2026',
  last_updated: '2026-02-23',
  
  electricity: {
    price_default_eur_kwh: 0.1940,
    price_min_eur_kwh: 0.15,
    price_max_eur_kwh: 0.30,
    unit: '€/kWh TTC',
    source_level: 'pending_expert',
    source_ref: 'À confirmer : prix TTC professionnel moyen ou tarif HT officiel',
    source_note: 'Valeur provisoire 0.194 €/kWh TTC, à valider avec expert',
    validity_limits: 'Tertiaire < 36 kVA, périmètre France métropolitaine',
    subscription_excluded: true
  },
  
  gas: {
    price_default_eur_kwh: 0.10514,
    price_min_eur_kwh: 0.09630,
    price_max_eur_kwh: 0.12291,
    unit: '€/kWh TTC',
    source_level: 'source_strong',
    source_ref: 'CRE - Prix repère gaz professionnel 2025, profil chauffage',
    source_note: 'Tarif TTC confirmé, applicable TPE/PME tertiaire',
    validity_limits: 'Profil chauffage, < 150 MWh/an',
    subscription_excluded: true
  }
};

/* ─────────────────────────────────────────────────────────────────────────
   TABLE 2 : BENCHMARKS_INTENSITY
   
   Intensité énergétique (kWh/m²/an) par activité
   Médiane + plage Q1/Q3 pour positionnement
   ───────────────────────────────────────────────────────────────────────── */

const BENCHMARKS_INTENSITY = {
  version_tag: 'v1.0-2026',
  last_updated: '2026-02-23',
  
  offices: {
    median_kwh_m2_an: 180,
    low_kwh_m2_an: 140,      // Q1
    high_kwh_m2_an: 240,     // Q3
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'source_partial',
    source_ref: 'ADEME - Consommations énergétiques tertiaire 2020',
    source_note: 'Bureaux chauffés, médiane France métropolitaine',
    validity_limits: 'Bureaux standards, hors data centers'
  },
  
  retail: {
    median_kwh_m2_an: 350,
    low_kwh_m2_an: 280,
    high_kwh_m2_an: 450,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'source_partial',
    source_ref: 'CEREN 2019 - Commerce',
    source_note: 'Moyenne commerce alimentaire + non alimentaire',
    validity_limits: 'Commerce de détail, hors grandes surfaces alimentaires'
  },
  
  hotel: {
    median_kwh_m2_an: 280,
    low_kwh_m2_an: 220,
    high_kwh_m2_an: 360,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'source_partial',
    source_ref: 'ADEME - Hôtellerie',
    source_note: 'Hôtel 2-3 étoiles avec restauration',
    validity_limits: 'Hôtellerie standard, hors palace et hôtel budget'
  },
  
  restaurant: {
    median_kwh_m2_an: 400,
    low_kwh_m2_an: 320,
    high_kwh_m2_an: 520,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'hypothesis',
    source_ref: 'Estimation produit',
    source_note: 'Inclut process cuisson important, valeur à confirmer par expert',
    validity_limits: 'Restaurant service à table, hors fast-food'
  },
  
  health_local: {
    median_kwh_m2_an: 200,
    low_kwh_m2_an: 160,
    high_kwh_m2_an: 260,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'pending_expert',
    source_ref: 'À confirmer',
    source_note: 'Périmètre cabinet médical/dentaire local, hors hôpital et clinique',
    validity_limits: 'Santé ambulatoire uniquement'
  },
  
  education: {
    median_kwh_m2_an: 150,
    low_kwh_m2_an: 110,
    high_kwh_m2_an: 200,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'source_partial',
    source_ref: 'ADEME - Établissements scolaires',
    source_note: 'Médiane écoles primaires et collèges',
    validity_limits: 'Enseignement primaire/secondaire, hors université'
  },
  
  light_warehouse: {
    median_kwh_m2_an: 90,
    low_kwh_m2_an: 60,
    high_kwh_m2_an: 130,
    unit: 'kWhEF/m²/an',
    energy_scope: 'final_energy',
    stat_type: 'median_q1_q3',
    source_level: 'source_partial',
    source_ref: 'CEREN - Entrepôts logistiques',
    source_note: 'Entrepôt peu chauffé, éclairage industriel standard',
    validity_limits: 'Logistique légère, hors entrepôts frigorifiques'
  }
};

/* ─────────────────────────────────────────────────────────────────────────
   TABLE 3 : USAGE_BREAKDOWNS
   
   Répartition indicative par postes (%)
   IMPORTANT : Non mesurée sur site, usage pédagogique + calcul gains
   ───────────────────────────────────────────────────────────────────────── */

const USAGE_BREAKDOWNS = {
  version_tag: 'v1.0-2026',
  last_updated: '2026-02-23',
  
  offices: {
    heating_pct: 45,
    cooling_pct: 8,
    vent_aux_pct: 12,
    lighting_pct: 18,
    dhw_pct: 5,
    cooking_pct: 0,
    other_specific_pct: 12,
    breakdown_mode: 'coarse_statistical',
    source_level: 'source_partial',
    source_ref: 'ADEME - Répartition usages bureaux tertiaire',
    source_note: 'Répartition statistique moyenne, non mesurée sur site',
    validity_limits: 'Bureaux standards chauffés, périmètre indicatif'
  },
  
  retail: {
    heating_pct: 30,
    cooling_pct: 10,
    vent_aux_pct: 8,
    lighting_pct: 35,
    dhw_pct: 3,
    cooking_pct: 0,
    other_specific_pct: 14,
    breakdown_mode: 'coarse_statistical',
    source_level: 'source_partial',
    source_ref: 'CEREN - Commerce',
    source_note: 'Éclairage vitrine important, répartition indicative',
    validity_limits: 'Commerce de détail, hors alimentaire spécialisé'
  },
  
  hotel: {
    heating_pct: 40,
    cooling_pct: 5,
    vent_aux_pct: 10,
    lighting_pct: 15,
    dhw_pct: 20,
    cooking_pct: 5,
    other_specific_pct: 5,
    breakdown_mode: 'coarse_statistical',
    source_level: 'source_partial',
    source_ref: 'ADEME - Hôtellerie',
    source_note: 'ECS importante (chambres + cuisine), répartition indicative',
    validity_limits: 'Hôtel avec restauration'
  },
  
  restaurant: {
    heating_pct: 25,
    cooling_pct: 5,
    vent_aux_pct: 15,
    lighting_pct: 10,
    dhw_pct: 10,
    cooking_pct: 30,
    other_specific_pct: 5,
    breakdown_mode: 'coarse_statistical',
    source_level: 'hypothesis',
    source_ref: 'Estimation produit',
    source_note: 'Process cuisson important, à confirmer par expert',
    validity_limits: 'Restaurant service, hors fast-food'
  },
  
  health_local: {
    heating_pct: 50,
    cooling_pct: 5,
    vent_aux_pct: 10,
    lighting_pct: 15,
    dhw_pct: 10,
    cooking_pct: 0,
    other_specific_pct: 10,
    breakdown_mode: 'heating_vs_other',
    source_level: 'pending_expert',
    source_ref: 'À confirmer',
    source_note: 'Répartition simplifiée chauffage/autres, détail à valider',
    validity_limits: 'Cabinet médical/dentaire local'
  },
  
  education: {
    heating_pct: 55,
    cooling_pct: 2,
    vent_aux_pct: 8,
    lighting_pct: 20,
    dhw_pct: 5,
    cooking_pct: 0,
    other_specific_pct: 10,
    breakdown_mode: 'coarse_statistical',
    source_level: 'source_partial',
    source_ref: 'ADEME - Établissements scolaires',
    source_note: 'Occupation partielle année, chauffage dominant',
    validity_limits: 'Enseignement primaire/secondaire'
  },
  
  light_warehouse: {
    heating_pct: 35,
    cooling_pct: 0,
    vent_aux_pct: 5,
    lighting_pct: 40,
    dhw_pct: 2,
    cooking_pct: 0,
    other_specific_pct: 18,
    breakdown_mode: 'coarse_statistical',
    source_level: 'source_partial',
    source_ref: 'CEREN - Entrepôts',
    source_note: 'Éclairage dominant, peu chauffé',
    validity_limits: 'Entrepôt logistique standard'
  }
};

/* ─────────────────────────────────────────────────────────────────────────
   TABLE 4 : ACTIONS_LIBRARY
   
   12 actions minimum avec gains/CAPEX/ROI
   Chaque action a un source_level par composant
   ───────────────────────────────────────────────────────────────────────── */

const ACTIONS_LIBRARY = {
  version_tag: 'v1.0-2026',
  last_updated: '2026-02-23',
  
  actions: [
    {
      id: 'ACT01',
      name: 'Réglage horaires et abaissement chauffage',
      category: 'heating',
      trigger_rules: ['heating_post > 30%', 'no_regulation_done'],
      gain_scope: 'heating_post',
      gain_pct_low: 0.08,
      gain_pct_med: 0.12,
      gain_pct_high: 0.18,
      capex_low: 0,
      capex_med: 500,
      capex_high: 1500,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: [],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Réglages chauffage tertiaire',
      source_level_capex: 'hypothesis',
      source_ref_capex: 'Estimation produit - main d\'œuvre réglage',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT02',
      name: 'Régulation centrale chauffage (sonde + programmation)',
      category: 'heating',
      trigger_rules: ['heating_post > 30%', 'no_regulation_done'],
      gain_scope: 'heating_post',
      gain_pct_low: 0.10,
      gain_pct_med: 0.15,
      gain_pct_high: 0.25,
      capex_low: 1500,
      capex_med: 4000,
      capex_high: 8000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Régulation centrale',
      source_level_capex: 'source_partial',
      source_ref_capex: 'Retours installateurs + ADEME',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT03',
      name: 'Robinets thermostatiques (zonage)',
      category: 'heating',
      trigger_rules: ['heating_post > 25%', 'surface > 200'],
      gain_scope: 'heating_post',
      gain_pct_low: 0.05,
      gain_pct_med: 0.10,
      gain_pct_high: 0.15,
      capex_low: 30,
      capex_med: 50,
      capex_high: 80,
      capex_unit: '€/radiateur',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Robinets thermostatiques',
      source_level_capex: 'source_strong',
      source_ref_capex: 'Prix marché constatés 2025',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT04',
      name: 'Désembouage et équilibrage réseau chauffage',
      category: 'heating',
      trigger_rules: ['heating_post > 30%', 'age_building > 15'],
      gain_scope: 'heating_post',
      gain_pct_low: 0.05,
      gain_pct_med: 0.08,
      gain_pct_high: 0.12,
      capex_low: 1000,
      capex_med: 2500,
      capex_high: 5000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: [],
      source_level_gain: 'hypothesis',
      source_ref_gain: 'Retours terrain installateurs',
      source_level_capex: 'source_partial',
      source_ref_capex: 'Devis moyens constatés',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT05',
      name: 'Ventilation horloge (arrêt hors occupation)',
      category: 'ventilation',
      trigger_rules: ['vent_aux_post > 8%', 'no_regulation_done'],
      gain_scope: 'vent_aux_post',
      gain_pct_low: 0.15,
      gain_pct_med: 0.25,
      gain_pct_high: 0.40,
      capex_low: 500,
      capex_med: 1500,
      capex_high: 3000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Ventilation tertiaire',
      source_level_capex: 'hypothesis',
      source_ref_capex: 'Estimation horloge + installation',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT06',
      name: 'Ventilation asservie présence',
      category: 'ventilation',
      trigger_rules: ['vent_aux_post > 8%', 'offices or education'],
      gain_scope: 'vent_aux_post',
      gain_pct_low: 0.20,
      gain_pct_med: 0.30,
      gain_pct_high: 0.45,
      capex_low: 2000,
      capex_med: 5000,
      capex_high: 10000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Détection présence ventilation',
      source_level_capex: 'hypothesis',
      source_ref_capex: 'Estimation sondes + GTB',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT07',
      name: 'Ventilation asservie CO2 / humidité',
      category: 'ventilation',
      trigger_rules: ['vent_aux_post > 10%', 'high_occupancy'],
      gain_scope: 'vent_aux_post',
      gain_pct_low: 0.15,
      gain_pct_med: 0.25,
      gain_pct_high: 0.35,
      capex_low: 3000,
      capex_med: 7000,
      capex_high: 15000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - VAV CO2',
      source_level_capex: 'hypothesis',
      source_ref_capex: 'Estimation sondes qualité air + régulation',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT08',
      name: 'Relamping LED complet',
      category: 'lighting',
      trigger_rules: ['lighting_post > 15%', 'no_led_done'],
      gain_scope: 'lighting_post',
      gain_pct_low: 0.40,
      gain_pct_med: 0.55,
      gain_pct_high: 0.70,
      capex_low: 15,
      capex_med: 25,
      capex_high: 40,
      capex_unit: '€/m²',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_strong',
      source_ref_gain: 'ADEME - LED tertiaire, gains mesurés',
      source_level_capex: 'source_strong',
      source_ref_capex: 'Prix marché LED 2025',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT09',
      name: 'Éclairage détection présence et zonage',
      category: 'lighting',
      trigger_rules: ['lighting_post > 15%', 'offices or education'],
      gain_scope: 'lighting_post',
      gain_pct_low: 0.15,
      gain_pct_med: 0.25,
      gain_pct_high: 0.35,
      capex_low: 10,
      capex_med: 20,
      capex_high: 35,
      capex_unit: '€/m²',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Détection présence éclairage',
      source_level_capex: 'source_partial',
      source_ref_capex: 'Prix détecteurs + installation',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT10',
      name: 'Calorifugeage conduites ECS',
      category: 'dhw',
      trigger_rules: ['dhw_post > 8%', 'no_dhw_done'],
      gain_scope: 'dhw_post',
      gain_pct_low: 0.10,
      gain_pct_med: 0.15,
      gain_pct_high: 0.25,
      capex_low: 500,
      capex_med: 1500,
      capex_high: 3000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Calorifugeage ECS',
      source_level_capex: 'source_partial',
      source_ref_capex: 'Prix isolants + MO',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT11',
      name: 'Isolation ballon ECS',
      category: 'dhw',
      trigger_rules: ['dhw_post > 8%', 'no_dhw_done'],
      gain_scope: 'dhw_post',
      gain_pct_low: 0.08,
      gain_pct_med: 0.12,
      gain_pct_high: 0.20,
      capex_low: 200,
      capex_med: 500,
      capex_high: 1000,
      capex_unit: '€',
      roi_method: 'simple_payback',
      aid_tags: ['CEE'],
      source_level_gain: 'source_partial',
      source_ref_gain: 'ADEME - Isolation ballons',
      source_level_capex: 'hypothesis',
      source_ref_capex: 'Estimation jaquette isolante',
      source_level_roi: 'hypothesis'
    },
    
    {
      id: 'ACT12',
      name: 'Isolation toiture (si travaux prévus)',
      category: 'envelope',
      trigger_rules: ['heating_post > 35%', 'no_envelope_done', 'age_building > 15'],
      gain_scope: 'heating_post',
      gain_pct_low: 0.15,
      gain_pct_med: 0.22,
      gain_pct_high: 0.30,
      capex_low: 40,
      capex_med: 70,
      capex_high: 120,
      capex_unit: '€/m²',
      roi_method: 'simple_payback',
      aid_tags: ['CEE', 'MaPrimeRenov'],
      source_level_gain: 'source_strong',
      source_ref_gain: 'ADEME - Isolation toiture tertiaire',
      source_level_capex: 'source_partial',
      source_ref_capex: 'Prix marché isolation + MO',
      source_level_roi: 'hypothesis'
    }
  ]
};

/* ═══════════════════════════════════════════════════════════════════════════
   EXPORTS POUR INTÉGRATION
   ═══════════════════════════════════════════════════════════════════════════ */

// Ces tables sont prêtes à être utilisées dans buildReportData()

/* ═══════════════════════════════════════════════════════════════════════════
   PHASE 3 : MOTEUR DE CALCUL - PIPELINE COMPLET
   
   Pipeline :
   1. Normalisation inputs
   2. Conversion € → kWh (avec option B : déduction abonnement)
   3. Calcul intensité kWh/m²/an
   4. Benchmark vs activité (+ mix si applicable)
   5. Répartition postes (usage_breakdowns)
   6. Déclenchement actions (règles + exclusions)
   7. Calcul gains/économies/ROI (par poste si applicable)
   8. Tri actions (impact + faisabilité)
   9. Output payload standardisé avec unités partout
   
   ═══════════════════════════════════════════════════════════════════════════ */

/* ─────────────────────────────────────────────────────────────────────────
   HELPERS : CONVERSION € → kWh (OPTION B)
   ───────────────────────────────────────────────────────────────────────── */

const convertEuroToKwh = (energy, formData) => {
  const isElec = energy === 'elec';
  const priceDefault = isElec 
    ? ENERGY_PRICES.electricity.price_default_eur_kwh
    : ENERGY_PRICES.gas.price_default_eur_kwh;
  
  const kwh = formData[`${energy}Kwh`];
  const euro = formData[`${energy}Euro`];
  const includesSubscription = formData[`${energy}IncludesSubscription`];
  const subscriptionYearly = formData[`${energy}SubscriptionYearly`];
  
  // Priorité 1 : kWh saisis
  if (kwh && parseFloat(kwh) > 0) {
    return {
      value: parseFloat(kwh),
      method: 'kwh_provided',
      price_used: null
    };
  }
  
  // Priorité 2 : Conversion depuis €
  if (euro && parseFloat(euro) > 0) {
    let montantEnergie = parseFloat(euro);
    
    // Option B : Déduction abonnement si renseigné
    if (includesSubscription && subscriptionYearly && parseFloat(subscriptionYearly) > 0) {
      montantEnergie = Math.max(montantEnergie - parseFloat(subscriptionYearly), 0);
    }
    
    const kwhEstimated = montantEnergie / priceDefault;
    
    return {
      value: Math.round(kwhEstimated),
      method: includesSubscription && subscriptionYearly 
        ? 'euro_converted_subscription_deducted'
        : 'euro_converted_default_price',
      price_used: priceDefault
    };
  }
  
  return {
    value: 0,
    method: 'none',
    price_used: null
  };
};

/* ─────────────────────────────────────────────────────────────────────────
   HELPERS : BENCHMARK & MIX USAGE
   ───────────────────────────────────────────────────────────────────────── */

const getBenchmark = (activity, mixOfficesPct, mixRetailPct) => {
  // Si usage mixte, pondération
  if (activity === 'mixed') {
    const officesData = BENCHMARKS_INTENSITY.offices;
    const retailData = BENCHMARKS_INTENSITY.retail;
    
    const pOffices = parseFloat(mixOfficesPct) / 100;
    const pRetail = parseFloat(mixRetailPct) / 100;
    
    return {
      median_kwh_m2_an: Math.round(
        officesData.median_kwh_m2_an * pOffices + 
        retailData.median_kwh_m2_an * pRetail
      ),
      low_kwh_m2_an: Math.round(
        officesData.low_kwh_m2_an * pOffices + 
        retailData.low_kwh_m2_an * pRetail
      ),
      high_kwh_m2_an: Math.round(
        officesData.high_kwh_m2_an * pOffices + 
        retailData.high_kwh_m2_an * pRetail
      ),
      source_level: 'hypothesis',
      source_ref: 'Pondération offices + retail',
      is_mixed: true
    };
  }
  
  // Activité simple
  const benchmark = BENCHMARKS_INTENSITY[activity];
  if (!benchmark) {
    return {
      median_kwh_m2_an: 200,
      low_kwh_m2_an: 150,
      high_kwh_m2_an: 280,
      source_level: 'hypothesis',
      source_ref: 'Fallback générique',
      is_mixed: false
    };
  }
  
  return { ...benchmark, is_mixed: false };
};

const getUsageBreakdown = (activity, mixOfficesPct, mixRetailPct) => {
  // Si usage mixte, pondération
  if (activity === 'mixed') {
    const officesData = USAGE_BREAKDOWNS.offices;
    const retailData = USAGE_BREAKDOWNS.retail;
    
    const pOffices = parseFloat(mixOfficesPct) / 100;
    const pRetail = parseFloat(mixRetailPct) / 100;
    
    return {
      heating_pct: Math.round(officesData.heating_pct * pOffices + retailData.heating_pct * pRetail),
      cooling_pct: Math.round(officesData.cooling_pct * pOffices + retailData.cooling_pct * pRetail),
      vent_aux_pct: Math.round(officesData.vent_aux_pct * pOffices + retailData.vent_aux_pct * pRetail),
      lighting_pct: Math.round(officesData.lighting_pct * pOffices + retailData.lighting_pct * pRetail),
      dhw_pct: Math.round(officesData.dhw_pct * pOffices + retailData.dhw_pct * pRetail),
      cooking_pct: Math.round(officesData.cooking_pct * pOffices + retailData.cooking_pct * pRetail),
      other_specific_pct: Math.round(officesData.other_specific_pct * pOffices + retailData.other_specific_pct * pRetail),
      source_level: 'hypothesis',
      source_ref: 'Pondération offices + retail',
      breakdown_mode: 'coarse_statistical'
    };
  }
  
  // Activité simple
  const breakdown = USAGE_BREAKDOWNS[activity];
  if (!breakdown) {
    return {
      heating_pct: 45,
      cooling_pct: 5,
      vent_aux_pct: 10,
      lighting_pct: 20,
      dhw_pct: 5,
      cooking_pct: 0,
      other_specific_pct: 15,
      source_level: 'hypothesis',
      source_ref: 'Fallback générique',
      breakdown_mode: 'coarse_statistical'
    };
  }
  
  return breakdown;
};

/* ─────────────────────────────────────────────────────────────────────────
   HELPERS : ACTIONS & GAINS
   ───────────────────────────────────────────────────────────────────────── */

const calculateActionGain = (action, totalKwh, breakdown, avgPrice) => {
  let baseKwh = totalKwh;
  
  // Si gain sur poste spécifique
  if (action.gain_scope !== 'total' && action.gain_scope.endsWith('_post')) {
    const postKey = action.gain_scope.replace('_post', '_pct');
    const postPct = breakdown[postKey] || 0;
    baseKwh = totalKwh * (postPct / 100);
  }
  
  // Calcul gain (médian)
  const gainKwh = Math.round(baseKwh * action.gain_pct_med);
  const gainEuro = Math.round(gainKwh * avgPrice);
  
  // CAPEX (médian)
  let capex = action.capex_med;
  
  // Si capex par m² ou par unité, estimer
  if (action.capex_unit === '€/m²') {
    // Faudrait la surface, on va faire simple
    capex = action.capex_med * 100; // Estimation 100m² par défaut
  }
  
  // ROI
  const roi_years = gainEuro > 0 ? Math.round((capex / gainEuro) * 10) / 10 : null;
  
  return {
    gainKwh,
    gainEuro,
    capex,
    roi_years
  };
};

const filterAndScoreActions = (formData, totalKwh, breakdown, avgPrice) => {
  const worksDone = formData.worksDone || [];
  
  // Filtrer actions déjà réalisées
  let eligibleActions = ACTIONS_LIBRARY.actions.filter(action => {
    // Exclusion par catégorie
    if (worksDone.includes('led') && action.category === 'lighting') return false;
    if (worksDone.includes('regulation') && action.id === 'ACT01') return false;
    if (worksDone.includes('regulation') && action.id === 'ACT02') return false;
    if (worksDone.includes('hvac_new') && action.category === 'heating') return false;
    if (worksDone.includes('envelope') && action.category === 'envelope') return false;
    if (worksDone.includes('dhw') && action.category === 'dhw') return false;
    
    return true;
  });
  
  // Calculer gains + score pour chaque action
  const scoredActions = eligibleActions.map(action => {
    const calc = calculateActionGain(action, totalKwh, breakdown, avgPrice);
    
    // Score de priorité (impact + ROI)
    let priorityScore = 0;
    
    // Impact (€ économies)
    priorityScore += calc.gainEuro / 100;
    
    // ROI (meilleur = plus de points)
    if (calc.roi_years && calc.roi_years > 0) {
      priorityScore += Math.max(0, 10 - calc.roi_years);
    }
    
    return {
      ...action,
      ...calc,
      priorityScore
    };
  });
  
  // Tri par priorité
  scoredActions.sort((a, b) => b.priorityScore - a.priorityScore);
  
  // Ne garder qu'1 action par famille
  const families = {};
  const topActions = [];
  
  for (const action of scoredActions) {
    if (!families[action.category]) {
      families[action.category] = true;
      topActions.push(action);
      if (topActions.length >= 3) break;
    }
  }
  
  return topActions;
};

/* ─────────────────────────────────────────────────────────────────────────
   HELPERS : GAINS COMPOSÉS + CAP
   ───────────────────────────────────────────────────────────────────────── */

const calculateCompositeSavings = (actions) => {
  // Gains composés : 1 - Π(1 - g_i)
  let composite = 1;
  
  for (const action of actions) {
    const gainPct = action.gainKwh > 0 ? action.gain_pct_med : 0;
    composite *= (1 - gainPct);
  }
  
  const totalGainPct = 1 - composite;
  
  // Cap max 65%
  return Math.min(totalGainPct, CONFIG.MAX_TOTAL_SAVINGS_PCT);
};

/* ─────────────────────────────────────────────────────────────────────────
   WARNINGS STANDARDISÉS
   ───────────────────────────────────────────────────────────────────────── */

const generateWarnings = (formData, conversionResults) => {
  const warnings = [];
  
  // Warning prix implicite
  ['elec', 'gas'].forEach(energy => {
    const kwh = formData[`${energy}Kwh`];
    const euro = formData[`${energy}Euro`];
    
    if (kwh && euro) {
      const implicitPrice = parseFloat(euro) / parseFloat(kwh);
      const priceMin = energy === 'elec' ? 0.10 : 0.05;
      const priceMax = energy === 'elec' ? 0.35 : 0.20;
      
      if (implicitPrice < priceMin || implicitPrice > priceMax) {
        warnings.push({
          code: 'PRICE_IMPLIED_OUT_OF_RANGE',
          severity: 'warning',
          message: `${energy === 'elec' ? 'Électricité' : 'Gaz'} : prix implicite ${implicitPrice.toFixed(3)} €/kWh inhabituel`,
          energy
        });
      }
    }
  });
  
  // Warning abonnement
  ['elec', 'gas'].forEach(energy => {
    if (formData[`${energy}IncludesSubscription`] && !formData[`${energy}SubscriptionYearly`]) {
      warnings.push({
        code: 'SUBSCRIPTION_INCLUDED_NO_VALUE',
        severity: 'warning',
        message: `${energy === 'elec' ? 'Électricité' : 'Gaz'} : abonnement inclus mais montant non renseigné`,
        energy
      });
    }
  });
  
  // Warning mix usage (ne devrait pas arriver car validation formulaire)
  if (formData.activity === 'mixed') {
    const total = parseFloat(formData.mixOfficesPct || 0) + parseFloat(formData.mixRetailPct || 0);
    if (Math.abs(total - 100) > 0.5) {
      warnings.push({
        code: 'MIX_SUM_NOT_100',
        severity: 'error',
        message: 'Mix usage ne totalise pas 100%'
      });
    }
  }
  
  return warnings;
};

/* ─────────────────────────────────────────────────────────────────────────
   SCORE CONFIANCE
   ───────────────────────────────────────────────────────────────────────── */

const calculateConfidenceScore = (formData, conversionResults) => {
  let score = 100;
  
  // Pénalité si conversion depuis €
  if (conversionResults.elec?.method?.includes('euro_converted')) score -= 15;
  if (conversionResults.gas?.method?.includes('euro_converted')) score -= 15;
  
  // Pénalité si aucune donnée énergie
  if (conversionResults.elec?.value === 0 && conversionResults.gas?.value === 0) score -= 50;
  
  // Bonus si kWh fournis
  if (conversionResults.elec?.method === 'kwh_provided') score += 5;
  if (conversionResults.gas?.method === 'kwh_provided') score += 5;
  
  // Pénalité si pending_expert sur activité
  const benchmark = getBenchmark(formData.activity, formData.mixOfficesPct, formData.mixRetailPct);
  if (benchmark.source_level === 'pending_expert') score -= 20;
  
  score = Math.max(0, Math.min(100, score));
  
  // Niveau
  let level = 'strong';
  if (score < 50) level = 'low';
  else if (score < 75) level = 'medium';
  
  return {
    score,
    level,
    label: level === 'strong' ? 'Fort' : level === 'medium' ? 'Moyen' : 'Faible'
  };
};

/* ─────────────────────────────────────────────────────────────────────────
   FONCTION PRINCIPALE : buildReportData()
   ───────────────────────────────────────────────────────────────────────── */

const buildReportData = (formData) => {
  const reportId = `DIAG-${Date.now()}`;
  const generatedAt = new Date().toISOString();
  
  // ──────────────────────────────────────────────────────────────────────
  // 1. NORMALISATION INPUTS
  // ──────────────────────────────────────────────────────────────────────
  const surface = parseFloat(formData.surface) || 0;
  const activity = formData.activity || 'offices';
  const mixOfficesPct = activity === 'mixed' ? (formData.mixOfficesPct || 50) : 0;
  const mixRetailPct = activity === 'mixed' ? (formData.mixRetailPct || 50) : 0;
  
  // Garde-fou surface
  if (surface <= 0) {
    throw new Error('Surface invalide (doit être > 0)');
  }
  
  // ──────────────────────────────────────────────────────────────────────
  // 2. CONVERSION € → kWh
  // ──────────────────────────────────────────────────────────────────────
  const elecConversion = formData.elecUsed ? convertEuroToKwh('elec', formData) : { value: 0, method: 'not_used' };
  const gasConversion = formData.gasUsed ? convertEuroToKwh('gas', formData) : { value: 0, method: 'not_used' };
  
  const totalKwh = elecConversion.value + gasConversion.value;
  
  // Garde-fou NaN
  if (isNaN(totalKwh) || !isFinite(totalKwh)) {
    throw new Error('Calcul consommation invalide (NaN ou Infinity)');
  }
  
  // ──────────────────────────────────────────────────────────────────────
  // 3. INTENSITÉ kWh/m²/an
  // ──────────────────────────────────────────────────────────────────────
  const intensity_kwh_m2_an = surface > 0 ? Math.round(totalKwh / surface) : 0;
  
  // ──────────────────────────────────────────────────────────────────────
  // 4. BENCHMARK
  // ──────────────────────────────────────────────────────────────────────
  const benchmark = getBenchmark(activity, mixOfficesPct, mixRetailPct);
  
  let benchmarkPosition = 'in_range';
  if (intensity_kwh_m2_an < benchmark.low_kwh_m2_an) benchmarkPosition = 'below_range';
  else if (intensity_kwh_m2_an > benchmark.high_kwh_m2_an) benchmarkPosition = 'above_range';
  if (intensity_kwh_m2_an > benchmark.high_kwh_m2_an * 1.2) benchmarkPosition = 'far_above_range';
  
  // ──────────────────────────────────────────────────────────────────────
  // 5. RÉPARTITION POSTES
  // ──────────────────────────────────────────────────────────────────────
  const breakdown = getUsageBreakdown(activity, mixOfficesPct, mixRetailPct);
  
  const breakdownKwh = {
    heating: Math.round(totalKwh * breakdown.heating_pct / 100),
    cooling: Math.round(totalKwh * breakdown.cooling_pct / 100),
    vent_aux: Math.round(totalKwh * breakdown.vent_aux_pct / 100),
    lighting: Math.round(totalKwh * breakdown.lighting_pct / 100),
    dhw: Math.round(totalKwh * breakdown.dhw_pct / 100),
    cooking: Math.round(totalKwh * breakdown.cooking_pct / 100),
    other_specific: Math.round(totalKwh * breakdown.other_specific_pct / 100)
  };
  
  // ──────────────────────────────────────────────────────────────────────
  // 6-8. ACTIONS + GAINS + TRI
  // ──────────────────────────────────────────────────────────────────────
  const avgPrice = 0.15; // Prix moyen pondéré élec/gaz simplifié
  const topActions = filterAndScoreActions(formData, totalKwh, breakdown, avgPrice);
  
  const compositeSavingsPct = calculateCompositeSavings(topActions);
  const annualSavingsKwh = Math.round(totalKwh * compositeSavingsPct);
  const annualSavingsEuro = Math.round(annualSavingsKwh * avgPrice);
  
  // ──────────────────────────────────────────────────────────────────────
  // 9. PROJECTIONS
  // ──────────────────────────────────────────────────────────────────────
  const projection5y = {
    savings_euro: annualSavingsEuro * 5,
    unit: '€',
    period: '5 ans'
  };
  
  const projection10y = {
    savings_euro: annualSavingsEuro * 10,
    unit: '€',
    period: '10 ans'
  };
  
  // ──────────────────────────────────────────────────────────────────────
  // WARNINGS & CONFIANCE
  // ──────────────────────────────────────────────────────────────────────
  const warnings = generateWarnings(formData, { elec: elecConversion, gas: gasConversion });
  const confidence = calculateConfidenceScore(formData, { elec: elecConversion, gas: gasConversion });
  
  // ──────────────────────────────────────────────────────────────────────
  // PAYLOAD STANDARDISÉ AVEC UNITÉS PARTOUT
  // ──────────────────────────────────────────────────────────────────────
  return {
    report_id: reportId,
    version_tag: 'v1.0-2026',
    generated_at: generatedAt,
    
    // Inputs summary
    inputs_summary: {
      email: formData.email,
      role: formData.role,
      site_name: formData.siteName,
      postal_code: formData.postalCode,
      activity: activity,
      surface: { value: surface, unit: 'm²' },
      levels: { value: parseInt(formData.levels) || 1, unit: 'niveaux' },
      mix_offices_pct: activity === 'mixed' ? mixOfficesPct : null,
      mix_retail_pct: activity === 'mixed' ? mixRetailPct : null,
      works_done: formData.worksDone || []
    },
    
    // Calculation results
    calculation_results: {
      elec_kwh_an: { value: elecConversion.value, unit: 'kWh/an', method: elecConversion.method },
      gas_kwh_an: { value: gasConversion.value, unit: 'kWh/an', method: gasConversion.method },
      total_kwh_an: { value: totalKwh, unit: 'kWh/an' },
      intensity_kwh_m2_an: { value: intensity_kwh_m2_an, unit: 'kWh/m²/an' },
      total_cost_euro_an: { value: Math.round(totalKwh * avgPrice), unit: '€/an', price_avg: avgPrice }
    },
    
    // Benchmark
    benchmark_result: {
      position: benchmarkPosition,
      site_intensity: { value: intensity_kwh_m2_an, unit: 'kWh/m²/an' },
      benchmark_median: { value: benchmark.median_kwh_m2_an, unit: 'kWh/m²/an' },
      benchmark_low: { value: benchmark.low_kwh_m2_an, unit: 'kWh/m²/an' },
      benchmark_high: { value: benchmark.high_kwh_m2_an, unit: 'kWh/m²/an' },
      source_level: benchmark.source_level,
      source_ref: benchmark.source_ref
    },
    
    // Usage breakdown
    usage_breakdown: {
      breakdown_pct: breakdown,
      breakdown_kwh: breakdownKwh,
      source_level: breakdown.source_level,
      source_ref: breakdown.source_ref,
      breakdown_mode: breakdown.breakdown_mode
    },
    
    // Top actions
    top_actions: topActions.map(a => ({
      id: a.id,
      name: a.name,
      category: a.category,
      gain_kwh_an: { value: a.gainKwh, unit: 'kWh/an' },
      gain_euro_an: { value: a.gainEuro, unit: '€/an' },
      capex: { value: a.capex, unit: '€' },
      roi_years: { value: a.roi_years, unit: 'ans' },
      source_level_gain: a.source_level_gain,
      source_level_capex: a.source_level_capex,
      aid_tags: a.aid_tags
    })),
    
    // Projections
    projection_5y: projection5y,
    projection_10y: projection10y,
    
    // Composite savings
    composite_savings: {
      total_pct: { value: Math.round(compositeSavingsPct * 100), unit: '%' },
      annual_kwh: { value: annualSavingsKwh, unit: 'kWh/an' },
      annual_euro: { value: annualSavingsEuro, unit: '€/an' }
    },
    
    // Metadata
    confidence: confidence,
    warnings: warnings,
    
    // Hypothèses & limites
    assumptions: [
      'Pré-diagnostic, non substituable à un audit énergétique réglementaire',
      'Benchmarks issus de données publiques statistiques',
      'Répartition par postes indicative (non mesurée sur site)',
      `Conversion € → kWh basée sur prix simplifiés (élec ${ENERGY_PRICES.electricity.price_default_eur_kwh} €/kWh, gaz ${ENERGY_PRICES.gas.price_default_eur_kwh} €/kWh)`,
      'Gains et ROI indicatifs à confirmer avant travaux',
      'Aides indicatives à vérifier selon éligibilité réelle'
    ],
    
    limits: [
      'Résultats dépendants de la qualité des données saisies',
      'Hypothèses sur usages et horaires non vérifiées',
      'Pas de prise en compte de l\'état réel des équipements',
      'Gains cumulés plafonnés à 65% (anti-surpromesse)',
      'CAPEX et aides à confirmer par devis professionnel'
    ]
  };
};

/* ═══════════════════════════════════════════════════════════════════════════
   EXPORT POUR INTÉGRATION
   ═══════════════════════════════════════════════════════════════════════════ */

// Fonction prête à être utilisée :
// const reportPayload = buildReportData(formData);

/* ═══════════════════════════════════════════════════════════════════════════
   PHASE 2 : FORMULAIRE DIAGNOSTIC COMPLET
   
   Flow : Multi-étapes → Validation stricte → Calcul → Email gate → Rapport
   
   Étapes :
   1. Identification (email, rôle, site, CP, activité)
   2. Bâtiment & Usage (surface, niveaux, mix usage si mixte)
   3. Énergies (élec + gaz : kWh/€/abonnement)
   4. Travaux déjà réalisés
   5. Email Gate (après calcul, avant rapport)
   6. Rapport complet
   
   ═══════════════════════════════════════════════════════════════════════════ */

/* ─────────────────────────────────────────────────────────────────────────
   CONSTANTES FORMULAIRE
   ───────────────────────────────────────────────────────────────────────── */

const ACTIVITIES = [
  { 
    id: 'offices', 
    label: 'Bureaux', 
    icon: 'solar:buildings-2-linear',
    // Valeurs provisoires + source_level
    refKwh: 180,
    source_level: 'source_partial',
    source_ref: 'ADEME - Consommations énergétiques tertiaire 2020',
    source_note: 'Médiane bureaux chauffés, périmètre France métropolitaine'
  },
  { 
    id: 'retail', 
    label: 'Commerce / Retail', 
    icon: 'solar:shop-linear',
    refKwh: 350,
    source_level: 'source_partial',
    source_ref: 'CEREN 2019 - Commerce',
    source_note: 'Moyenne commerce alimentaire + non alimentaire'
  },
  { 
    id: 'hotel', 
    label: 'Hôtel', 
    icon: 'solar:bed-linear',
    refKwh: 280,
    source_level: 'source_partial',
    source_ref: 'ADEME - Hôtellerie',
    source_note: 'Médiane hôtel 2-3 étoiles avec restauration'
  },
  { 
    id: 'restaurant', 
    label: 'Restaurant', 
    icon: 'solar:chef-hat-linear',
    refKwh: 400,
    source_level: 'hypothesis',
    source_ref: 'Estimation produit',
    source_note: 'Inclut cuisson process, valeur à confirmer'
  },
  { 
    id: 'health_local', 
    label: 'Santé (cabinet, local)', 
    icon: 'solar:heart-pulse-linear',
    refKwh: 200,
    source_level: 'pending_expert',
    source_ref: 'À confirmer',
    source_note: 'Périmètre cabinet médical/dentaire, hors hôpital'
  },
  { 
    id: 'education', 
    label: 'Enseignement', 
    icon: 'solar:book-linear',
    refKwh: 150,
    source_level: 'source_partial',
    source_ref: 'ADEME - Établissements scolaires',
    source_note: 'Médiane écoles primaires/collèges'
  },
  { 
    id: 'light_warehouse', 
    label: 'Entrepôt logistique', 
    icon: 'solar:box-linear',
    refKwh: 90,
    source_level: 'source_partial',
    source_ref: 'CEREN - Entrepôts',
    source_note: 'Entrepôt peu chauffé, éclairage industriel'
  },
  { 
    id: 'mixed', 
    label: 'Usage mixte', 
    icon: 'solar:transfer-horizontal-linear',
    refKwh: 0, // Calculé dynamiquement
    source_level: 'hypothesis',
    source_ref: 'Pondération offices + retail',
    source_note: 'Mix bureaux/commerce selon % saisis'
  }
];

const ROLES = [
  { id: 'owner', label: 'Propriétaire', icon: 'solar:home-linear' },
  { id: 'tenant', label: 'Locataire exploitant', icon: 'solar:case-linear' }
];

const WORKS_DONE = [
  { id: 'led', label: 'LED (relamping complet)', category: 'lighting' },
  { id: 'regulation', label: 'Régulation / Pilotage chauffage', category: 'heating' },
  { id: 'hvac_new', label: 'Chauffage/CVC rénové récemment', category: 'heating' },
  { id: 'envelope', label: 'Enveloppe rénovée (isolation)', category: 'envelope' },
  { id: 'dhw', label: 'ECS traitée (calorifugeage, etc.)', category: 'dhw' }
];

const DEFAULT_FORM_DATA = {
  // Étape 1 : Identification
  email: '',
  role: '',
  siteName: '',
  postalCode: '',
  activity: '',
  
  // Étape 2 : Bâtiment & Usage
  surface: '',
  levels: '',
  mixOfficesPct: 50, // Si activity === 'mixed'
  mixRetailPct: 50,  // Si activity === 'mixed'
  
  // Étape 3 : Énergies
  elecUsed: false,
  elecKwh: '',
  elecEuro: '',
  elecPriceKwh: '',
  elecIncludesSubscription: false,
  elecSubscriptionYearly: '',
  
  gasUsed: false,
  gasKwh: '',
  gasEuro: '',
  gasPriceKwh: '',
  gasIncludesSubscription: false,
  gasSubscriptionYearly: '',
  
  // Étape 4 : Travaux
  worksDone: [],
  
  // Méta
  contactOptIn: false // Opt-in contact expert (facultatif)
};

/* ─────────────────────────────────────────────────────────────────────────
   VALIDATION HELPERS
   ───────────────────────────────────────────────────────────────────────── */

const validateEmail = (email) => {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
};

const validatePostalCode = (code) => {
  return /^\d{5}$/.test(code);
};

const validateNumber = (value, min = 0, max = Infinity) => {
  const num = parseFloat(value);
  return !isNaN(num) && num >= min && num <= max;
};

const validateMixUsage = (officesPct, retailPct) => {
  const total = parseFloat(officesPct || 0) + parseFloat(retailPct || 0);
  // Tolérance arrondi <= 0.5 puis normalisation
  return Math.abs(total - 100) <= 0.5;
};

const normalizeMixUsage = (officesPct, retailPct) => {
  const total = parseFloat(officesPct || 0) + parseFloat(retailPct || 0);
  if (total === 0) return { officesPct: 50, retailPct: 50 };
  return {
    officesPct: Math.round((officesPct / total) * 100 * 10) / 10,
    retailPct: Math.round((retailPct / total) * 100 * 10) / 10
  };
};

const validateEnergyData = (formData) => {
  const errors = [];
  
  // Au moins une énergie doit être renseignée
  if (!formData.elecUsed && !formData.gasUsed) {
    errors.push('Au moins une énergie (électricité ou gaz) doit être renseignée');
    return errors;
  }
  
  // Si élec utilisée, au moins kWh ou €
  if (formData.elecUsed) {
    const hasElecData = formData.elecKwh || formData.elecEuro;
    if (!hasElecData) {
      errors.push('Électricité : renseignez au moins les kWh ou le montant en €');
    }
  }
  
  // Si gaz utilisé, au moins kWh ou €
  if (formData.gasUsed) {
    const hasGasData = formData.gasKwh || formData.gasEuro;
    if (!hasGasData) {
      errors.push('Gaz : renseignez au moins les kWh ou le montant en €');
    }
  }
  
  // Validation cohérence prix implicite (warning, non bloquant)
  if (formData.elecKwh && formData.elecEuro) {
    const implicitPrice = parseFloat(formData.elecEuro) / parseFloat(formData.elecKwh);
    if (implicitPrice < 0.10 || implicitPrice > 0.35) {
      errors.push({
        type: 'warning',
        code: 'PRICE_IMPLIED_OUT_OF_RANGE',
        message: 'Électricité : le prix implicite semble inhabituel (vérifiez vos données)'
      });
    }
  }
  
  if (formData.gasKwh && formData.gasEuro) {
    const implicitPrice = parseFloat(formData.gasEuro) / parseFloat(formData.gasKwh);
    if (implicitPrice < 0.05 || implicitPrice > 0.20) {
      errors.push({
        type: 'warning',
        code: 'PRICE_IMPLIED_OUT_OF_RANGE',
        message: 'Gaz : le prix implicite semble inhabituel (vérifiez vos données)'
      });
    }
  }
  
  // Warning abonnement coché mais vide
  if (formData.elecIncludesSubscription && !formData.elecSubscriptionYearly) {
    errors.push({
      type: 'warning',
      code: 'SUBSCRIPTION_INCLUDED_NO_VALUE',
      message: 'Électricité : abonnement coché mais montant non renseigné (estimation moins précise)'
    });
  }
  
  if (formData.gasIncludesSubscription && !formData.gasSubscriptionYearly) {
    errors.push({
      type: 'warning',
      code: 'SUBSCRIPTION_INCLUDED_NO_VALUE',
      message: 'Gaz : abonnement coché mais montant non renseigné (estimation moins précise)'
    });
  }
  
  return errors;
};

/* ─────────────────────────────────────────────────────────────────────────
   COMPOSANTS FORMULAIRE
   ───────────────────────────────────────────────────────────────────────── */

// Stepper (barre de progression)
const Stepper = ({ currentStep, totalSteps }) => {
  const steps = Array.from({ length: totalSteps }, (_, i) => i + 1);
  
  return (
    <div className="mb-8">
      <div className="flex items-center justify-center gap-2">
        {steps.map((step) => (
          <div key={step} className="flex items-center">
            <div 
              className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold transition-colors ${
                step < currentStep 
                  ? 'bg-green-500 text-white' 
                  : step === currentStep
                    ? 'bg-blue-600 text-white'
                    : 'bg-neutral-200 text-neutral-500'
              }`}
            >
              {step < currentStep ? '✓' : step}
            </div>
            {step < totalSteps && (
              <div 
                className={`w-12 h-1 ${
                  step < currentStep ? 'bg-green-500' : 'bg-neutral-200'
                }`}
              />
            )}
          </div>
        ))}
      </div>
      <p className="text-center text-sm text-neutral-500 mt-4">
        Étape {currentStep} sur {totalSteps}
      </p>
    </div>
  );
};

// Input générique
const FormInput = ({ 
  label, 
  value, 
  onChange, 
  type = 'text', 
  placeholder = '', 
  required = false,
  error = null,
  suffix = null,
  helper = null 
}) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-neutral-700 mb-2">
      {label} {required && <span className="text-red-500">*</span>}
    </label>
    <div className="relative">
      <input
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
          error 
            ? 'border-red-300 focus:ring-red-500' 
            : 'border-neutral-300 focus:ring-blue-500'
        }`}
      />
      {suffix && (
        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500 text-sm">
          {suffix}
        </span>
      )}
    </div>
    {helper && <p className="text-xs text-neutral-500 mt-1">{helper}</p>}
    {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
  </div>
);

// Select générique
const FormSelect = ({ 
  label, 
  value, 
  onChange, 
  options, 
  required = false,
  error = null,
  placeholder = 'Sélectionnez...'
}) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-neutral-700 mb-2">
      {label} {required && <span className="text-red-500">*</span>}
    </label>
    <select
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
        error 
          ? 'border-red-300 focus:ring-red-500' 
          : 'border-neutral-300 focus:ring-blue-500'
      }`}
    >
      <option value="">{placeholder}</option>
      {options.map((opt) => (
        <option key={opt.id} value={opt.id}>
          {opt.label}
        </option>
      ))}
    </select>
    {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
  </div>
);

// Radio cards
const RadioCards = ({ options, selected, onChange, columns = 2 }) => (
  <div className={`grid md:grid-cols-${columns} gap-4`}>
    {options.map((option) => (
      <button
        type="button"
        key={option.id}
        onClick={() => onChange(option.id)}
        className={`p-4 rounded-xl border-2 transition-all text-left ${
          selected === option.id
            ? 'border-blue-600 bg-blue-50'
            : 'border-neutral-200 hover:border-neutral-300'
        }`}
      >
        {option.icon && (
          <iconify-icon 
            icon={option.icon} 
            className={`text-2xl mb-2 block ${selected === option.id ? 'text-blue-600' : 'text-neutral-500'}`}
          />
        )}
        <div className="font-semibold text-neutral-900 mb-1">{option.label}</div>
        {option.desc && <div className="text-sm text-neutral-600">{option.desc}</div>}
      </button>
    ))}
  </div>
);

// Checkbox
const Checkbox = ({ label, checked, onChange, helper = null }) => (
  <label className="flex items-start gap-3 cursor-pointer">
    <input
      type="checkbox"
      checked={checked}
      onChange={(e) => onChange(e.target.checked)}
      className="mt-1 w-5 h-5 rounded border-neutral-300 text-blue-600 focus:ring-blue-500"
    />
    <div>
      <span className="text-neutral-700">{label}</span>
      {helper && <p className="text-xs text-neutral-500 mt-1">{helper}</p>}
    </div>
  </label>
);

// Checkboxes groupe
const CheckboxGroup = ({ options, selected, onChange }) => (
  <div className="space-y-3">
    {options.map((option) => (
      <Checkbox
        key={option.id}
        label={option.label}
        checked={selected.includes(option.id)}
        onChange={(checked) => {
          if (checked) {
            onChange([...selected, option.id]);
          } else {
            onChange(selected.filter(id => id !== option.id));
          }
        }}
      />
    ))}
  </div>
);

// Slider mix usage
const MixSlider = ({ officesPct, retailPct, onChange }) => {
  const handleOfficeChange = (value) => {
    const newOfficesPct = parseFloat(value);
    const newRetailPct = 100 - newOfficesPct;
    onChange({ officesPct: newOfficesPct, retailPct: newRetailPct });
  };
  
  const isValid = validateMixUsage(officesPct, retailPct);
  
  return (
    <div className="mb-6">
      <label className="block text-sm font-medium text-neutral-700 mb-4">
        Répartition des usages <span className="text-red-500">*</span>
      </label>
      
      <div className="space-y-4">
        {/* Slider */}
        <div className="px-2">
          <input
            type="range"
            min="0"
            max="100"
            step="1"
            value={officesPct}
            onChange={(e) => handleOfficeChange(e.target.value)}
            className="w-full"
          />
        </div>
        
        {/* Valeurs */}
        <div className="grid grid-cols-2 gap-4">
          <div className="p-4 bg-blue-50 rounded-lg text-center">
            <div className="text-3xl font-bold text-blue-600">{Math.round(officesPct)}%</div>
            <div className="text-sm text-neutral-600 mt-1">Bureaux</div>
          </div>
          <div className="p-4 bg-purple-50 rounded-lg text-center">
            <div className="text-3xl font-bold text-purple-600">{Math.round(retailPct)}%</div>
            <div className="text-sm text-neutral-600 mt-1">Commerce</div>
          </div>
        </div>
        
        {!isValid && (
          <p className="text-xs text-red-500">
            La somme doit être égale à 100%
          </p>
        )}
      </div>
    </div>
  );
};

/* ─────────────────────────────────────────────────────────────────────────
   ÉTAPES FORMULAIRE
   ───────────────────────────────────────────────────────────────────────── */

// Étape 1 : Identification
const Step1Identification = ({ formData, setFormData, onNext }) => {
  const [errors, setErrors] = useState({});
  
  const validate = () => {
    const newErrors = {};
    
    if (!validateEmail(formData.email)) {
      newErrors.email = 'Email invalide';
    }
    if (!formData.role) {
      newErrors.role = 'Veuillez sélectionner votre rôle';
    }
    if (!formData.siteName || formData.siteName.length < 2) {
      newErrors.siteName = 'Nom du site requis (min 2 caractères)';
    }
    if (!validatePostalCode(formData.postalCode)) {
      newErrors.postalCode = 'Code postal invalide (5 chiffres)';
    }
    if (!formData.activity) {
      newErrors.activity = 'Veuillez sélectionner une activité';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };
  
  const handleNext = () => {
    if (validate()) {
      track('diagnostic_step1_completed');
      onNext();
    }
  };
  
  return (
    <div className="max-w-2xl mx-auto">
      <h2 className="text-2xl font-bold text-neutral-900 mb-2">Identification</h2>
      <p className="text-neutral-600 mb-8">Commençons par quelques informations de base</p>
      
      <FormInput
        label="Email"
        value={formData.email}
        onChange={(v) => setFormData({ ...formData, email: v })}
        type="email"
        placeholder="vous@entreprise.com"
        required
        error={errors.email}
        helper="Requis pour recevoir le rapport par email"
      />
      
      <div className="mb-4">
        <label className="block text-sm font-medium text-neutral-700 mb-2">
          Vous êtes <span className="text-red-500">*</span>
        </label>
        <RadioCards
          options={ROLES.map(r => ({ ...r, desc: null }))}
          selected={formData.role}
          onChange={(v) => setFormData({ ...formData, role: v })}
        />
        {errors.role && <p className="text-xs text-red-500 mt-2">{errors.role}</p>}
      </div>
      
      <FormInput
        label="Nom du site ou société"
        value={formData.siteName}
        onChange={(v) => setFormData({ ...formData, siteName: v })}
        placeholder="Mon bâtiment tertiaire"
        required
        error={errors.siteName}
      />
      
      <FormInput
        label="Code postal"
        value={formData.postalCode}
        onChange={(v) => setFormData({ ...formData, postalCode: v })}
        placeholder="75001"
        required
        error={errors.postalCode}
      />
      
      <FormSelect
        label="Activité principale"
        value={formData.activity}
        onChange={(v) => setFormData({ ...formData, activity: v })}
        options={ACTIVITIES}
        required
        error={errors.activity}
        placeholder="Sélectionnez une activité"
      />
      
      <div className="flex justify-end mt-8">
        <button
          onClick={handleNext}
          className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
        >
          Continuer →
        </button>
      </div>
    </div>
  );
};

// Étape 2 : Bâtiment & Usage
const Step2Building = ({ formData, setFormData, onNext, onBack }) => {
  const [errors, setErrors] = useState({});
  const isMixed = formData.activity === 'mixed';
  
  const validate = () => {
    const newErrors = {};
    
    if (!validateNumber(formData.surface, 1)) {
      newErrors.surface = 'Surface invalide (doit être > 0)';
    }
    if (!validateNumber(formData.levels, 1)) {
      newErrors.levels = 'Nombre de niveaux invalide (doit être >= 1)';
    }
    
    if (isMixed && !validateMixUsage(formData.mixOfficesPct, formData.mixRetailPct)) {
      newErrors.mix = 'La somme bureaux + commerce doit être égale à 100%';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };
  
  const handleNext = () => {
    if (validate()) {
      // Normalisation mix usage si besoin
      if (isMixed) {
        const normalized = normalizeMixUsage(formData.mixOfficesPct, formData.mixRetailPct);
        setFormData({ ...formData, ...normalized });
      }
      track('diagnostic_step2_completed');
      onNext();
    }
  };
  
  return (
    <div className="max-w-2xl mx-auto">
      <h2 className="text-2xl font-bold text-neutral-900 mb-2">Bâtiment & Usage</h2>
      <p className="text-neutral-600 mb-8">Caractéristiques de votre site</p>
      
      <FormInput
        label="Surface totale"
        value={formData.surface}
        onChange={(v) => setFormData({ ...formData, surface: v })}
        type="number"
        placeholder="300"
        suffix="m²"
        required
        error={errors.surface}
      />
      
      <FormInput
        label="Nombre de niveaux"
        value={formData.levels}
        onChange={(v) => setFormData({ ...formData, levels: v })}
        type="number"
        placeholder="2"
        required
        error={errors.levels}
      />
      
      {isMixed && (
        <>
          <MixSlider
            officesPct={formData.mixOfficesPct}
            retailPct={formData.mixRetailPct}
            onChange={({officesPct,retailPct}) => 
              setFormData({ ...formData, mixOfficesPct, retailPct })
            }
          />
          {errors.mix && <p className="text-xs text-red-500 mb-4">{errors.mix}</p>}
        </>
      )}
      
      <div className="flex justify-between mt-8">
        <button
          onClick={onBack}
          className="px-6 py-3 text-neutral-600 hover:text-neutral-900 font-semibold transition-colors"
        >
          ← Retour
        </button>
        <button
          onClick={handleNext}
          className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
        >
          Continuer →
        </button>
      </div>
    </div>
  );
};

// Étape 3 : Énergies (suite dans le prochain fichier car limite de taille)

/* ═══════════════════════════════════════════════════════════════════════════
   PHASE 2 : FORMULAIRE (PARTIE 2)
   
   Étape 3 : Énergies
   Étape 4 : Travaux déjà réalisés
   ═══════════════════════════════════════════════════════════════════════════ */

// Étape 3 : Énergies
const Step3Energies = ({ formData, setFormData, onNext, onBack }) => {
  const [errors, setErrors] = useState([]);
  
  const validate = () => {
    const validationErrors = validateEnergyData(formData);
    
    // Filtrer seulement les erreurs bloquantes
    const blockingErrors = validationErrors.filter(e => typeof e === 'string');
    
    setErrors(validationErrors);
    return blockingErrors.length === 0;
  };
  
  const handleNext = () => {
    if (validate()) {
      track('diagnostic_step3_completed', {
        elec_used: formData.elecUsed,
        gas_used: formData.gasUsed
      });
      onNext();
    }
  };
  
  const warnings = errors.filter(e => typeof e === 'object' && e.type === 'warning');
  const blockingErrors = errors.filter(e => typeof e === 'string');
  
  return (
    <div className="max-w-3xl mx-auto">
      <h2 className="text-2xl font-bold text-neutral-900 mb-2">Énergies</h2>
      <p className="text-neutral-600 mb-8">
        Renseignez vos consommations annuelles (si vous les avez)
      </p>
      
      {/* Erreurs bloquantes */}
      {blockingErrors.length > 0 && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p className="text-sm font-semibold text-red-800 mb-2">Erreurs à corriger :</p>
          <ul className="list-disc list-inside text-sm text-red-700 space-y-1">
            {blockingErrors.map((err, i) => (
              <li key={i}>{err}</li>
            ))}
          </ul>
        </div>
      )}
      
      {/* Warnings */}
      {warnings.length > 0 && (
        <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p className="text-sm font-semibold text-yellow-800 mb-2">Avertissements :</p>
          <ul className="list-disc list-inside text-sm text-yellow-700 space-y-1">
            {warnings.map((warn, i) => (
              <li key={i}>{warn.message}</li>
            ))}
          </ul>
        </div>
      )}
      
      {/* Électricité */}
      <div className="mb-8 p-6 bg-white border border-neutral-200 rounded-xl">
        <Checkbox
          label="J'utilise de l'électricité"
          checked={formData.elecUsed}
          onChange={(v) => setFormData({ ...formData, elecUsed: v })}
        />
        
        {formData.elecUsed && (
          <div className="mt-6 pl-8 border-l-4 border-blue-500 space-y-4">
            <div className="grid md:grid-cols-2 gap-4">
              <FormInput
                label="Consommation annuelle"
                value={formData.elecKwh}
                onChange={(v) => setFormData({ ...formData, elecKwh: v })}
                type="number"
                placeholder="120000"
                suffix="kWh/an"
                helper="Si vous avez cette info sur votre facture"
              />
              
              <FormInput
                label="Montant annuel TTC"
                value={formData.elecEuro}
                onChange={(v) => setFormData({ ...formData, elecEuro: v })}
                type="number"
                placeholder="23280"
                suffix="€/an"
                helper="Total TTC sur l'année"
              />
            </div>
            
            <Checkbox
              label="Mon montant inclut l'abonnement"
              checked={formData.elecIncludesSubscription}
              onChange={(v) => setFormData({ ...formData, elecIncludesSubscription: v })}
              helper="Si vous cochez cette case et renseignez l'abonnement, on l'enlèvera pour estimer la consommation"
            />
            
            {formData.elecIncludesSubscription && (
              <FormInput
                label="Abonnement annuel"
                value={formData.elecSubscriptionYearly}
                onChange={(v) => setFormData({ ...formData, elecSubscriptionYearly: v })}
                type="number"
                placeholder="150"
                suffix="€/an"
                helper="Montant de l'abonnement seul (hors consommation)"
              />
            )}
          </div>
        )}
      </div>
      
      {/* Gaz */}
      <div className="mb-8 p-6 bg-white border border-neutral-200 rounded-xl">
        <Checkbox
          label="J'utilise du gaz"
          checked={formData.gasUsed}
          onChange={(v) => setFormData({ ...formData, gasUsed: v })}
        />
        
        {formData.gasUsed && (
          <div className="mt-6 pl-8 border-l-4 border-orange-500 space-y-4">
            <div className="grid md:grid-cols-2 gap-4">
              <FormInput
                label="Consommation annuelle"
                value={formData.gasKwh}
                onChange={(v) => setFormData({ ...formData, gasKwh: v })}
                type="number"
                placeholder="80000"
                suffix="kWh/an"
                helper="Si vous avez cette info sur votre facture"
              />
              
              <FormInput
                label="Montant annuel TTC"
                value={formData.gasEuro}
                onChange={(v) => setFormData({ ...formData, gasEuro: v })}
                type="number"
                placeholder="8000"
                suffix="€/an"
                helper="Total TTC sur l'année"
              />
            </div>
            
            <Checkbox
              label="Mon montant inclut l'abonnement"
              checked={formData.gasIncludesSubscription}
              onChange={(v) => setFormData({ ...formData, gasIncludesSubscription: v })}
              helper="Si vous cochez cette case et renseignez l'abonnement, on l'enlèvera pour estimer la consommation"
            />
            
            {formData.gasIncludesSubscription && (
              <FormInput
                label="Abonnement annuel"
                value={formData.gasSubscriptionYearly}
                onChange={(v) => setFormData({ ...formData, gasSubscriptionYearly: v })}
                type="number"
                placeholder="120"
                suffix="€/an"
                helper="Montant de l'abonnement seul (hors consommation)"
              />
            )}
          </div>
        )}
      </div>
      
      <div className="flex justify-between mt-8">
        <button
          onClick={onBack}
          className="px-6 py-3 text-neutral-600 hover:text-neutral-900 font-semibold transition-colors"
        >
          ← Retour
        </button>
        <button
          onClick={handleNext}
          className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
        >
          Continuer →
        </button>
      </div>
    </div>
  );
};

// Étape 4 : Travaux déjà réalisés
const Step4Works = ({ formData, setFormData, onNext, onBack }) => {
  const handleNext = () => {
    track('diagnostic_step4_completed', {
      works_count: formData.worksDone.length
    });
    onNext();
  };
  
  return (
    <div className="max-w-2xl mx-auto">
      <h2 className="text-2xl font-bold text-neutral-900 mb-2">Travaux déjà réalisés</h2>
      <p className="text-neutral-600 mb-8">
        Avez-vous déjà effectué certains de ces travaux ? (facultatif)
      </p>
      
      <div className="p-6 bg-white border border-neutral-200 rounded-xl">
        <CheckboxGroup
          options={WORKS_DONE}
          selected={formData.worksDone}
          onChange={(v) => setFormData({ ...formData, worksDone: v })}
        />
        
        {formData.worksDone.length === 0 && (
          <p className="text-sm text-neutral-500 mt-4 italic">
            Aucun travail sélectionné (toutes les actions seront proposées)
          </p>
        )}
      </div>
      
      <div className="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <Checkbox
          label="Je souhaite être recontacté par un expert"
          checked={formData.contactOptIn}
          onChange={(v) => setFormData({ ...formData, contactOptIn: v })}
          helper="Facultatif : un expert pourra vous aider à affiner votre projet"
        />
      </div>
      
      <div className="flex justify-between mt-8">
        <button
          onClick={onBack}
          className="px-6 py-3 text-neutral-600 hover:text-neutral-900 font-semibold transition-colors"
        >
          ← Retour
        </button>
        <button
          onClick={handleNext}
          className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-lg"
        >
          Voir mon pré-diagnostic →
        </button>
      </div>
    </div>
  );
};

/* ─────────────────────────────────────────────────────────────────────────
   CONTENEUR PRINCIPAL FORMULAIRE
   ───────────────────────────────────────────────────────────────────────── */

const DiagnosticForm = ({ onComplete }) => {
  const [currentStep, setCurrentStep] = useState(1);
  const [formData, setFormData] = useState(DEFAULT_FORM_DATA);
  
  useEffect(() => {
    track('start_diagnostic');
  }, []);
  
  const handleComplete = () => {
    track('submit_form', {
      activity: formData.activity,
      role: formData.role,
      surface: formData.surface
    });
    onComplete(formData);
  };
  
  return (
    <div className="fade-in py-12 px-4">
      <div className="max-w-4xl mx-auto">
        <Stepper currentStep={currentStep} totalSteps={4} />
        
        {currentStep === 1 && (
          <Step1Identification
            formData={formData}
            setFormData={setFormData}
            onNext={() => setCurrentStep(2)}
          />
        )}
        
        {currentStep === 2 && (
          <Step2Building
            formData={formData}
            setFormData={setFormData}
            onNext={() => setCurrentStep(3)}
            onBack={() => setCurrentStep(1)}
          />
        )}
        
        {currentStep === 3 && (
          <Step3Energies
            formData={formData}
            setFormData={setFormData}
            onNext={() => setCurrentStep(4)}
            onBack={() => setCurrentStep(2)}
          />
        )}
        
        {currentStep === 4 && (
          <Step4Works
            formData={formData}
            setFormData={setFormData}
            onNext={handleComplete}
            onBack={() => setCurrentStep(3)}
          />
        )}
      </div>
    </div>
  );
};

/* ═══════════════════════════════════════════════════════════════════════════
   EXPORT POUR INTÉGRATION
   ═══════════════════════════════════════════════════════════════════════════ */

// Ce composant est prêt à être intégré dans App avec :
// {currentPage === 'diagnostic' && <DiagnosticForm onComplete={(data) => handleDiagnosticComplete(data)} />}

  /* ═══════════════════════════════════════════════════════════════════════════
   PHASE 4 : EMAIL GATE + RAPPORT + PDF + ENVOI EMAIL
   
   Flow complet :
   1. Formulaire → Calcul (buildReportData) → reportPayload
   2. Email gate (obligatoire) :
      - Sans email : aperçu flouté
      - Avec email : rapport complet + PDF + envoi email
   3. Rapport écran : affichage du reportPayload
   4. Export PDF : génération PDF du rapport
   5. Envoi email : stub fetch() vers API
   
   ═══════════════════════════════════════════════════════════════════════════ */

/* ─────────────────────────────────────────────────────────────────────────
   COMPOSANT : EMAIL GATE
   
   Affiche après le calcul, avant le rapport complet.
   Capture l'email utilisateur pour débloquer le rapport + PDF.
   ───────────────────────────────────────────────────────────────────────── */

const EmailGate = ({ reportPayload, onEmailSubmitted }) => {
  const [email, setEmail] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState(null);

  const validateEmail = (email) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);

    // Validation
    if (!validateEmail(email)) {
      setError('Email invalide');
      return;
    }

    setIsSubmitting(true);
    track('email_submitted', { email });

    // Simulation délai (en prod : appel API réel)
    await new Promise(resolve => setTimeout(resolve, 1000));

    setIsSubmitting(false);
    onEmailSubmitted(email);
  };

  return (
    <div className="fade-in min-h-screen flex items-center justify-center px-4 py-20">
      <div className="max-w-2xl w-full">
        {/* Aperçu flouté en arrière-plan */}
        <div className="mb-8 relative">
          <div className="blur-overlay">
            <div className="bg-white rounded-xl shadow-lg p-8 border border-neutral-200">
              <div className="h-8 bg-neutral-200 rounded w-3/4 mb-4"></div>
              <div className="h-4 bg-neutral-100 rounded w-full mb-2"></div>
              <div className="h-4 bg-neutral-100 rounded w-5/6 mb-2"></div>
              <div className="h-4 bg-neutral-100 rounded w-4/6 mb-6"></div>
              <div className="grid grid-cols-3 gap-4">
                <div className="h-20 bg-neutral-100 rounded"></div>
                <div className="h-20 bg-neutral-100 rounded"></div>
                <div className="h-20 bg-neutral-100 rounded"></div>
              </div>
            </div>
          </div>

          {/* Badge overlay */}
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full border-2 border-blue-600">
              <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Icon icon="solar:lock-password-linear" className="text-4xl text-blue-600" />
              </div>

              <h2 className="text-2xl font-bold text-neutral-900 text-center mb-2">
                Votre rapport est prêt
              </h2>
              
              <p className="text-neutral-600 text-center mb-6">
                Saisissez votre email pour accéder au rapport complet et le recevoir par email
              </p>

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-neutral-700 mb-2">
                    Email
                  </label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="vous@entreprise.com"
                    className={`w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
                      error 
                        ? 'border-red-300 focus:ring-red-500' 
                        : 'border-neutral-300 focus:ring-blue-500'
                    }`}
                    disabled={isSubmitting}
                  />
                  {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
                </div>

                <button
                  type="submit"
                  disabled={isSubmitting}
                  className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-neutral-300 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
                >
                  {isSubmitting ? (
                    <>
                      <Icon icon="solar:spinner-linear" className="text-xl animate-spin" />
                      Envoi en cours...
                    </>
                  ) : (
                    <>
                      Accéder au rapport
                      <Icon icon="solar:arrow-right-linear" className="text-xl" />
                    </>
                  )}
                </button>
              </form>

              <p className="text-xs text-neutral-500 text-center mt-4">
                Vos données sont utilisées uniquement pour l'envoi du rapport
              </p>
            </div>
          </div>
        </div>

        {/* Micro-preuves */}
        <div className="flex flex-wrap justify-center gap-4 text-sm text-neutral-600">
          <div className="flex items-center gap-2">
            <Icon icon="solar:shield-check-bold" className="text-green-500" />
            <span>Données sécurisées</span>
          </div>
          <div className="flex items-center gap-2">
            <Icon icon="solar:document-text-linear" className="text-blue-500" />
            <span>PDF joint par email</span>
          </div>
          <div className="flex items-center gap-2">
            <Icon icon="solar:timer-linear" className="text-orange-500" />
            <span>Réception instantanée</span>
          </div>
        </div>
      </div>
    </div>
  );
};

/* ─────────────────────────────────────────────────────────────────────────
   COMPOSANT : RAPPORT COMPLET (ÉCRAN)
   
   Affiche le reportPayload après email gate.
   Sections : KPIs, Benchmark, Breakdown, Actions, Projections, Plan, Hypothèses
   ───────────────────────────────────────────────────────────────────────── */

const ReportScreen = ({ reportPayload, userEmail, onExportPDF }) => {
  const [isPDFGenerating, setIsPDFGenerating] = useState(false);

  const handleExportPDF = async () => {
    setIsPDFGenerating(true);
    track('pdf_export_started');
    
    try {
      await exportPDF(reportPayload, userEmail);
      track('pdf_downloaded');
    } catch (error) {
      console.error('Erreur export PDF:', error);
      alert('Erreur lors de la génération du PDF');
    } finally {
      setIsPDFGenerating(false);
    }
  };

  const calc = reportPayload.calculation_results;
  const benchmark = reportPayload.benchmark_result;
  const breakdown = reportPayload.usage_breakdown;
  const actions = reportPayload.top_actions;
  const composite = reportPayload.composite_savings;
  const confidence = reportPayload.confidence;

  // Helper : formater les nombres avec unités
  const formatValue = (obj) => {
    if (!obj || typeof obj !== 'object') return obj;
    return `${obj.value?.toLocaleString('fr-FR') || obj.value} ${obj.unit || ''}`;
  };

  // Position benchmark → label + couleur
  const benchmarkLabels = {
    below_range: { label: 'Sous la référence', color: 'text-green-600', bg: 'bg-green-50' },
    in_range: { label: 'Dans la référence', color: 'text-blue-600', bg: 'bg-blue-50' },
    above_range: { label: 'Au-dessus de la référence', color: 'text-orange-600', bg: 'bg-orange-50' },
    far_above_range: { label: 'Très au-dessus de la référence', color: 'text-red-600', bg: 'bg-red-50' }
  };

  const benchmarkInfo = benchmarkLabels[benchmark.position] || benchmarkLabels.in_range;

  // Confiance → badge
  const confidenceColors = {
    strong: 'bg-green-100 text-green-800',
    medium: 'bg-yellow-100 text-yellow-800',
    low: 'bg-red-100 text-red-800'
  };

  return (
    <div className="fade-in py-12 px-4">
      <div className="max-w-5xl mx-auto">
        
        {/* En-tête rapport */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <div className="flex items-start justify-between mb-6">
            <div>
              <h1 className="text-3xl font-bold text-neutral-900 mb-2">
                Votre pré-diagnostic énergétique
              </h1>
              <p className="text-neutral-600">
                {reportPayload.inputs_summary.site_name} • {formatValue(reportPayload.inputs_summary.surface)}
              </p>
            </div>
            <div className="text-right">
              <div className={`inline-block px-4 py-2 rounded-lg font-semibold text-sm ${confidenceColors[confidence.level]}`}>
                Confiance : {confidence.label}
              </div>
              <p className="text-xs text-neutral-500 mt-2">
                {new Date(reportPayload.generated_at).toLocaleDateString('fr-FR')}
              </p>
            </div>
          </div>

          {/* Bouton export PDF */}
          <button
            onClick={handleExportPDF}
            disabled={isPDFGenerating}
            className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-neutral-300 transition-colors flex items-center justify-center gap-2"
          >
            {isPDFGenerating ? (
              <>
                <Icon icon="solar:spinner-linear" className="text-xl animate-spin" />
                Génération du PDF...
              </>
            ) : (
              <>
                <Icon icon="solar:download-linear" className="text-xl" />
                Télécharger le rapport PDF
              </>
            )}
          </button>
        </div>

        {/* Section 1 : KPIs clés */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Vue d'ensemble</h2>
          
          <div className="grid md:grid-cols-3 gap-6">
            <div className="text-center p-6 bg-blue-50 rounded-xl">
              <div className="text-4xl font-bold text-blue-600 mb-2">
                {formatValue(calc.total_kwh_an)}
              </div>
              <p className="text-sm text-neutral-600">Consommation annuelle</p>
            </div>

            <div className="text-center p-6 bg-purple-50 rounded-xl">
              <div className="text-4xl font-bold text-purple-600 mb-2">
                {formatValue(calc.intensity_kwh_m2_an)}
              </div>
              <p className="text-sm text-neutral-600">Intensité énergétique</p>
            </div>

            <div className="text-center p-6 bg-green-50 rounded-xl">
              <div className="text-4xl font-bold text-green-600 mb-2">
                {formatValue(calc.total_cost_euro_an)}
              </div>
              <p className="text-sm text-neutral-600">Coût annuel estimé</p>
            </div>
          </div>
        </div>

        {/* Section 2 : Benchmark */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Positionnement</h2>
          
          <div className={`p-6 rounded-xl ${benchmarkInfo.bg} mb-6`}>
            <div className="flex items-center gap-3 mb-4">
              <Icon icon="solar:chart-2-bold" className={`text-3xl ${benchmarkInfo.color}`} />
              <div>
                <p className={`text-lg font-bold ${benchmarkInfo.color}`}>{benchmarkInfo.label}</p>
                <p className="text-sm text-neutral-600">
                  Votre site : {formatValue(benchmark.site_intensity)} vs Médiane : {formatValue(benchmark.benchmark_median)}
                </p>
              </div>
            </div>

            {/* Barre de positionnement */}
            <div className="relative h-12 bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded-lg overflow-hidden">
              <div className="absolute inset-0 flex items-center justify-between px-4 text-xs font-bold text-white">
                <span>{formatValue(benchmark.benchmark_low)}</span>
                <span>{formatValue(benchmark.benchmark_median)}</span>
                <span>{formatValue(benchmark.benchmark_high)}</span>
              </div>
              
              {/* Curseur position */}
<div 
  className="absolute top-0 bottom-0 w-1 bg-neutral-900"
  style={{
    left: `${Math.min(100, Math.max(0, 
      ((benchmark.site_intensity.value - benchmark.benchmark_low.value) / 
      (benchmark.benchmark_high.value - benchmark.benchmark_low.value)) * 100
    ))}%`
  }}
>
  <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-neutral-900 rounded-full"></div>
</div>
            </div>
          </div>

          <p className="text-xs text-neutral-500">
            Source : {benchmark.source_ref}
          </p>
        </div>

        {/* Section 3 : Répartition par postes */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Répartition indicative par postes</h2>
          
          <div className="space-y-4 mb-6">
            {Object.entries(breakdown.breakdown_pct).map(([key, pct]) => {
              const labels = {
                heating_pct: { label: 'Chauffage', icon: 'solar:fire-linear', color: 'bg-red-500' },
                cooling_pct: { label: 'Climatisation', icon: 'solar:snowflake-linear', color: 'bg-blue-500' },
                vent_aux_pct: { label: 'Ventilation', icon: 'solar:wind-linear', color: 'bg-cyan-500' },
                lighting_pct: { label: 'Éclairage', icon: 'solar:lightbulb-linear', color: 'bg-yellow-500' },
                dhw_pct: { label: 'Eau chaude', icon: 'solar:water-sun-linear', color: 'bg-orange-500' },
                cooking_pct: { label: 'Cuisson', icon: 'solar:chef-hat-linear', color: 'bg-purple-500' },
                other_specific_pct: { label: 'Autres usages', icon: 'solar:widget-linear', color: 'bg-gray-500' }
              };

              const info = labels[key];
              if (!info || pct === 0) return null;

              const kwh = breakdown.breakdown_kwh[key.replace('_pct', '')];

              return (
                <div key={key}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Icon icon={info.icon} className="text-xl text-neutral-600" />
                      <span className="font-medium text-neutral-700">{info.label}</span>
                    </div>
                    <span className="text-sm font-bold text-neutral-900">
                      {pct}% ({kwh?.toLocaleString('fr-FR')} kWh/an)
                    </span>
                  </div>
                  <div className="h-3 bg-neutral-100 rounded-full overflow-hidden">
                    <div 
                      className={`h-full ${info.color}`}
                      style={{width:`${pct}%`}}
                    ></div>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-xs text-yellow-800">
              <Icon icon="solar:info-circle-linear" className="inline mr-1" />
              Répartition statistique indicative (non mesurée sur site). Source : {breakdown.source_ref}
            </p>
          </div>
        </div>

        {/* Section 4 : Top 3 actions */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Actions prioritaires</h2>
          
          <div className="space-y-6">
            {actions.map((action, i) => (
              <div key={action.id} className="p-6 border-2 border-neutral-200 rounded-xl hover:border-blue-300 transition-colors">
                <div className="flex items-start gap-4">
                  <div className="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center text-xl font-bold flex-shrink-0">
                    {i + 1}
                  </div>
                  
                  <div className="flex-1">
                    <h3 className="text-lg font-bold text-neutral-900 mb-2">{action.name}</h3>
                    
                    <div className="grid md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <p className="text-xs text-neutral-500 mb-1">Gain annuel</p>
                        <p className="font-bold text-green-600">
                          {formatValue(action.gain_kwh_an)}
                        </p>
                        <p className="font-bold text-green-600">
                          {formatValue(action.gain_euro_an)}
                        </p>
                      </div>
                      
                      <div>
                        <p className="text-xs text-neutral-500 mb-1">Investissement</p>
                        <p className="font-bold text-neutral-900">
                          {formatValue(action.capex)}
                        </p>
                      </div>
                      
                      <div>
                        <p className="text-xs text-neutral-500 mb-1">Retour sur investissement</p>
                        <p className="font-bold text-blue-600">
                          {formatValue(action.roi_years)}
                        </p>
                      </div>
                    </div>

                    {action.aid_tags && action.aid_tags.length > 0 && (
                      <div className="flex flex-wrap gap-2">
                        {action.aid_tags.map(tag => (
                          <span key={tag} className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}

                    <p className="text-xs text-neutral-400 mt-2">
                      Source gains : {action.source_level_gain} • Source CAPEX : {action.source_level_capex}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Section 5 : Projections */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Projections d'économies</h2>
          
          <div className="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl mb-6">
            <p className="text-sm text-neutral-600 mb-2">Économies totales avec les 3 actions prioritaires</p>
            <div className="text-4xl font-bold text-green-600 mb-1">
              {formatValue(composite.annual_euro)}
            </div>
            <p className="text-sm text-neutral-600">
              soit {formatValue(composite.annual_kwh)} ({formatValue(composite.total_pct)})
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div className="text-center p-6 bg-blue-50 rounded-xl">
              <p className="text-sm text-neutral-600 mb-2">Économies cumulées sur 5 ans</p>
              <div className="text-3xl font-bold text-blue-600">
                {reportPayload.projection_5y.savings_euro.toLocaleString('fr-FR')} €
              </div>
            </div>

            <div className="text-center p-6 bg-purple-50 rounded-xl">
              <p className="text-sm text-neutral-600 mb-2">Économies cumulées sur 10 ans</p>
              <div className="text-3xl font-bold text-purple-600">
                {reportPayload.projection_10y.savings_euro.toLocaleString('fr-FR')} €
              </div>
            </div>
          </div>

          <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-xs text-yellow-800">
              <Icon icon="solar:info-circle-linear" className="inline mr-1" />
              Gains cumulés plafonnés à 65% pour éviter les sur-promesses. Prix énergie constant.
            </p>
          </div>
        </div>

        {/* Section 6 : Hypothèses & Limites */}
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8 border border-neutral-200">
          <h2 className="text-2xl font-bold text-neutral-900 mb-6">Hypothèses et limites</h2>
          
          <Accordion title="Hypothèses du calcul" defaultOpen={false}>
            <ul className="space-y-2 text-sm text-neutral-600">
              {reportPayload.assumptions.map((assumption, i) => (
                <li key={i} className="flex items-start gap-2">
                  <Icon icon="solar:check-circle-linear" className="text-blue-500 flex-shrink-0 mt-0.5" />
                  <span>{assumption}</span>
                </li>
              ))}
            </ul>
          </Accordion>

          <Accordion title="Limites de l'approche" defaultOpen={false}>
            <ul className="space-y-2 text-sm text-neutral-600">
              {reportPayload.limits.map((limit, i) => (
                <li key={i} className="flex items-start gap-2">
                  <Icon icon="solar:shield-warning-linear" className="text-orange-500 flex-shrink-0 mt-0.5" />
                  <span>{limit}</span>
                </li>
              ))}
            </ul>
          </Accordion>

          {reportPayload.warnings && reportPayload.warnings.length > 0 && (
            <Accordion title={`Avertissements (${reportPayload.warnings.length})`} defaultOpen={true}>
              <ul className="space-y-2">
                {reportPayload.warnings.map((warning, i) => (
                  <li key={i} className="flex items-start gap-2 text-sm">
                    <Icon icon="solar:danger-triangle-linear" className="text-yellow-500 flex-shrink-0 mt-0.5" />
                    <span className="text-neutral-700">{warning.message}</span>
                  </li>
                ))}
              </ul>
            </Accordion>
          )}
        </div>

        {/* Footer rapport */}
        <div className="bg-neutral-50 rounded-xl p-6 text-center border border-neutral-200">
          <p className="text-sm text-neutral-600 mb-2">
            Rapport ID : {reportPayload.report_id} • Version : {reportPayload.version_tag}
          </p>
          <p className="text-xs text-neutral-500">
            Ce pré-diagnostic est indicatif. Pour un audit complet, consultez un professionnel certifié.
          </p>
        </div>
      </div>
    </div>
  );
};

/* ─────────────────────────────────────────────────────────────────────────
   FONCTION : EXPORT PDF
   
   Génère un PDF du rapport et le télécharge.
   Utilise jsPDF (à charger via CDN).
   
   TODO Phase V1.1 : Migrer vers PDFShift pour meilleur rendu
   ───────────────────────────────────────────────────────────────────────── */

const exportPDF = async (reportPayload, userEmail) => {
  // Vérifier que jsPDF est chargé
  if (typeof window.jspdf === 'undefined') {
    console.error('jsPDF non chargé');
    alert('Erreur : bibliothèque PDF non disponible');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  let y = 20; // Position verticale
  const lineHeight = 7;
  const pageWidth = doc.internal.pageSize.width;
  const margin = 20;
  const contentWidth = pageWidth - 2 * margin;

  // Helper : ajouter du texte avec retour à la ligne auto
  const addText = (text, x, options = {}) => {
    const fontSize = options.fontSize || 10;
    const isBold = options.bold || false;
    const color = options.color || [0, 0, 0];
    
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', isBold ? 'bold' : 'normal');
    doc.setTextColor(...color);
    
    const lines = doc.splitTextToSize(text, contentWidth - x + margin);
    doc.text(lines, x, y);
    y += lines.length * lineHeight;
  };

  // Helper : nouvelle page si besoin
  const checkNewPage = (space = 20) => {
    if (y > doc.internal.pageSize.height - space) {
      doc.addPage();
      y = 20;
    }
  };

  // ──────────────────────────────────────────────────────────────────────
  // PAGE 1 : EN-TÊTE
  // ──────────────────────────────────────────────────────────────────────
  
  // Titre
  addText('PRÉ-DIAGNOSTIC ÉNERGÉTIQUE', margin, { fontSize: 18, bold: true, color: [37, 99, 235] });
  y += 5;
  
  // Infos site
  addText(`Site : ${reportPayload.inputs_summary.site_name}`, margin, { fontSize: 12, bold: true });
  addText(`Surface : ${reportPayload.inputs_summary.surface.value} ${reportPayload.inputs_summary.surface.unit}`, margin);
  addText(`Email : ${userEmail}`, margin);
  addText(`Date : ${new Date(reportPayload.generated_at).toLocaleDateString('fr-FR')}`, margin);
  y += 10;

  // KPIs clés
  checkNewPage();
  addText('VUE D\'ENSEMBLE', margin, { fontSize: 14, bold: true });
  y += 5;
  
  const calc = reportPayload.calculation_results;
  addText(`Consommation annuelle : ${calc.total_kwh_an.value.toLocaleString('fr-FR')} ${calc.total_kwh_an.unit}`, margin + 5);
  addText(`Intensité énergétique : ${calc.intensity_kwh_m2_an.value} ${calc.intensity_kwh_m2_an.unit}`, margin + 5);
  addText(`Coût annuel estimé : ${calc.total_cost_euro_an.value.toLocaleString('fr-FR')} ${calc.total_cost_euro_an.unit}`, margin + 5);
  y += 10;

  // ──────────────────────────────────────────────────────────────────────
  // PAGE 2 : BENCHMARK
  // ──────────────────────────────────────────────────────────────────────
  
  checkNewPage();
  addText('POSITIONNEMENT', margin, { fontSize: 14, bold: true });
  y += 5;
  
  const benchmark = reportPayload.benchmark_result;
  const benchmarkLabels = {
    below_range: 'Sous la référence',
    in_range: 'Dans la référence',
    above_range: 'Au-dessus de la référence',
    far_above_range: 'Très au-dessus de la référence'
  };
  
  addText(`Position : ${benchmarkLabels[benchmark.position]}`, margin + 5);
  addText(`Votre intensité : ${benchmark.site_intensity.value} ${benchmark.site_intensity.unit}`, margin + 5);
  addText(`Médiane secteur : ${benchmark.benchmark_median.value} ${benchmark.benchmark_median.unit}`, margin + 5);
  addText(`Plage de référence : ${benchmark.benchmark_low.value} - ${benchmark.benchmark_high.value} ${benchmark.benchmark_low.unit}`, margin + 5);
  addText(`Source : ${benchmark.source_ref}`, margin + 5, { fontSize: 8, color: [100, 100, 100] });
  y += 10;

  // ──────────────────────────────────────────────────────────────────────
  // PAGE 3 : ACTIONS PRIORITAIRES
  // ──────────────────────────────────────────────────────────────────────
  
  checkNewPage();
  addText('ACTIONS PRIORITAIRES', margin, { fontSize: 14, bold: true });
  y += 5;
  
  reportPayload.top_actions.forEach((action, i) => {
    checkNewPage(40);
    
    addText(`${i + 1}. ${action.name}`, margin + 5, { bold: true });
    addText(`   Gain annuel : ${action.gain_kwh_an.value.toLocaleString('fr-FR')} ${action.gain_kwh_an.unit} (${action.gain_euro_an.value.toLocaleString('fr-FR')} ${action.gain_euro_an.unit})`, margin + 5);
    addText(`   Investissement : ${action.capex.value.toLocaleString('fr-FR')} ${action.capex.unit}`, margin + 5);
    addText(`   ROI : ${action.roi_years.value} ${action.roi_years.unit}`, margin + 5);
    
    if (action.aid_tags && action.aid_tags.length > 0) {
      addText(`   Aides : ${action.aid_tags.join(', ')}`, margin + 5, { color: [16, 185, 129] });
    }
    
    y += 5;
  });

  // ──────────────────────────────────────────────────────────────────────
  // PAGE 4 : PROJECTIONS
  // ──────────────────────────────────────────────────────────────────────
  
  checkNewPage();
  addText('PROJECTIONS D\'ÉCONOMIES', margin, { fontSize: 14, bold: true });
  y += 5;
  
  const composite = reportPayload.composite_savings;
  addText(`Économies annuelles (3 actions) : ${composite.annual_euro.value.toLocaleString('fr-FR')} ${composite.annual_euro.unit}`, margin + 5, { bold: true });
  addText(`Soit ${composite.annual_kwh.value.toLocaleString('fr-FR')} ${composite.annual_kwh.unit} (${composite.total_pct.value}${composite.total_pct.unit})`, margin + 5);
  y += 5;
  
  addText(`Économies cumulées 5 ans : ${reportPayload.projection_5y.savings_euro.toLocaleString('fr-FR')} €`, margin + 5);
  addText(`Économies cumulées 10 ans : ${reportPayload.projection_10y.savings_euro.toLocaleString('fr-FR')} €`, margin + 5);
  y += 10;

  // ──────────────────────────────────────────────────────────────────────
  // PAGE 5 : HYPOTHÈSES & LIMITES
  // ──────────────────────────────────────────────────────────────────────
  
  checkNewPage();
  addText('HYPOTHÈSES ET LIMITES', margin, { fontSize: 14, bold: true });
  y += 5;
  
  addText('Hypothèses :', margin + 5, { bold: true, fontSize: 11 });
  reportPayload.assumptions.forEach(assumption => {
    checkNewPage(15);
    addText(`• ${assumption}`, margin + 10, { fontSize: 9 });
  });
  y += 5;
  
  addText('Limites :', margin + 5, { bold: true, fontSize: 11 });
  reportPayload.limits.forEach(limit => {
    checkNewPage(15);
    addText(`• ${limit}`, margin + 10, { fontSize: 9 });
  });
  y += 10;

  // ──────────────────────────────────────────────────────────────────────
  // FOOTER TOUTES PAGES
  // ──────────────────────────────────────────────────────────────────────
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text(
      `DiagTertiaire - Pré-diagnostic énergétique - Page ${i}/${pageCount}`,
      pageWidth / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }

  // ──────────────────────────────────────────────────────────────────────
  // SAUVEGARDE PDF
  // ──────────────────────────────────────────────────────────────────────
  
  const filename = `DiagTertiaire-${reportPayload.inputs_summary.site_name.replace(/\s+/g, '-')}-${Date.now()}.pdf`;
  doc.save(filename);
};

/* ─────────────────────────────────────────────────────────────────────────
   FONCTION : ENVOI EMAIL (STUB)
   
   Fonction stub pour envoi email avec PDF.
   À brancher sur API réelle en production.
   ───────────────────────────────────────────────────────────────────────── */

const sendReportEmail = async (email, reportPayload) => {
  // Stub : simulation d'appel API
  const payload = {
    email: email,
    report_id: reportPayload.report_id,
    site_name: reportPayload.inputs_summary.site_name,
    pdf_url: null, // En prod : générer PDF côté serveur et retourner URL
    contact_optin: reportPayload.inputs_summary.contact_optin || false
  };

  console.log('[STUB] sendReportEmail:', payload);

  try {
    // Simulation fetch vers API
    // const response = await fetch(CONFIG.API_ENDPOINT_EMAIL, {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(payload)
    // });
    // 
    // if (!response.ok) throw new Error('Erreur envoi email');
    // 
    // return await response.json();

    // Pour l'instant : simulation succès
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    return {
      success: true,
      message: 'Email envoyé (simulation)',
      email_sent_to: email
    };
    
  } catch (error) {
    console.error('Erreur sendReportEmail:', error);
    throw error;
  }
};

/* ═══════════════════════════════════════════════════════════════════════════
   EXPORTS POUR INTÉGRATION
   
   Composants et fonctions prêts à intégrer dans App() :
   - EmailGate : afficher après buildReportData()
   - ReportScreen : afficher après email validé
   - exportPDF : bouton dans ReportScreen
   - sendReportEmail : appel après email validé

   ═══════════════════════════════════════════════════════════════════════════ */

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>

<html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagTertiaire - Performance √ânerg√©tique Tertiaire</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin="" src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      /* Global & Reset */
      body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; color: #374151; -webkit-font-smoothing: antialiased; }

      /* Custom Range Slider */
      input[type=range] { -webkit-appearance: none; appearance: none; background: transparent; }
      input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #1E3A5F; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
      input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E5E7EB; border-radius: 2px; }
      input[type=range]:focus { outline: none; }

      /* Print Styles */
      @media print {
          .no-print { display: none !important; }
          .print-only { display: block !important; }
          body { background: white; }
          .shadow-lg, .shadow-md, .shadow-sm, .shadow-xl { box-shadow: none !important; }
          .break-inside-avoid { break-inside: avoid; }
          .bg-slate-50 { background-color: white !important; }
          nav { display: none; }
      }

      /* Animations */
      .fade-in { animation: fadeIn 0.4s ease-out forwards; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .blur-overlay { filter: blur(5px); pointer-events: none; user-select: none; }
    </style>
  </head>
  <body class="antialiased text-[#374151] bg-[#F8F9FA]">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useRef } = React;
      const RechartsObj = window.Recharts || {};
      const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, LabelList } = RechartsObj;

      /* --- CONSTANTS & DATA --- */
      const ACTIVITIES = [
          { id: 'office', label: 'Bureaux', icon: 'solar:buildings-2-linear', refKwh: 180 },
          { id: 'retail', label: 'Commerce / Retail', icon: 'solar:shop-linear', refKwh: 350 },
          { id: 'hotel', label: 'H√¥tel', icon: 'solar:bed-linear', refKwh: 280 },
          { id: 'health', label: 'Sant√©', icon: 'solar:heart-pulse-linear', refKwh: 320 },
          { id: 'education', label: 'Enseignement', icon: 'solar:book-linear', refKwh: 150 },
          { id: 'warehouse', label: 'Entrep√¥t', icon: 'solar:box-linear', refKwh: 90 },
          { id: 'mixed', label: 'Usage mixte', icon: 'solar:transfer-horizontal-linear', refKwh: 220 },
      ];

      const YEARS = [
          { id: 'pre1975', label: 'Avant 1975', sub: 'Isolation souvent absente', coef: 1.45 },
          { id: '1975-1990', label: '1975 ‚Äì 1990', sub: 'Premi√®res r√©glementations', coef: 1.28 },
          { id: '1990-2005', label: '1990 ‚Äì 2005', sub: 'Isolation partielle', coef: 1.12 },
          { id: '2005-2012', label: '2005 ‚Äì 2012', sub: 'RT 2005', coef: 1.05 },
          { id: 'post2012', label: 'Apr√®s 2012', sub: 'RT 2012 ou RE 2020', coef: 1.0 },
      ];

      const HEATING = [
          { id: 'gas', label: 'Chaudi√®re gaz', icon: 'solar:flame-linear' },
          { id: 'elec', label: '√âlectrique', icon: 'solar:bolt-linear' },
          { id: 'pac', label: 'Pompe √† chaleur', icon: 'solar:water-drops-linear' },
          { id: 'oil', label: 'Fioul', icon: 'solar:fuel-linear' },
          { id: 'ac', label: 'Climatisation r√©v.', icon: 'solar:snowflake-linear' },
          { id: 'unknown', label: 'Je ne sais pas', icon: 'solar:question-circle-linear' },
      ];

      const OCCUPATION_OPTS = [
          { id: 'semaine', label: 'Semaine uniquement', sub: 'Lun‚ÄìVen, ~45h/semaine', icon: 'solar:calendar-linear' },
          { id: '6j', label: '6 jours sur 7', sub: 'Lundi‚ÄìSamedi', icon: 'solar:calendar-add-linear' },
          { id: '7j', label: '7 jours sur 7', sub: 'Occupation continue', icon: 'solar:refresh-circle-linear' },
          { id: 'etendu', label: 'Horaires √©tendus', sub: 'Soirs et weekends inclus', icon: 'solar:moon-linear' }
      ];

      const WORKS_LIST = [
          { id: 'roof', label: 'Isolation toiture' },
          { id: 'walls', label: 'Isolation des murs' },
          { id: 'windows', label: 'Remplacement fen√™tres' },
          { id: 'heating', label: 'Nouveau syst√®me chauffage' },
          { id: 'led', label: 'Passage LED complet' },
          { id: 'regulation', label: 'R√©gulation / programmation' },
      ];

      const ECS_SYSTEMS = [
          { id: 'elec_ecs', label: 'Chauffe-eau √©lectrique', icon: 'solar:bolt-linear' },
          { id: 'gas_ecs', label: 'Chaudi√®re gaz', icon: 'solar:flame-linear' },
          { id: 'pac_ecs', label: 'PAC eau chaude', icon: 'solar:water-drops-linear' },
          { id: 'solar_ecs', label: 'Solaire thermique', icon: 'solar:sun-linear' },
          { id: 'unknown_ecs', label: 'Je ne sais pas', icon: 'solar:question-circle-linear' },
      ];

      const DEFAULT_FORM = {
          address: '',
          activity: '',
          activityMixPct: 50,
          year: '',
          surface: 300,
          levels: 1,
          heating: '',
          heatingAge: '',
          occupation: '',
          consumptionMode: 'kwh',
          elecKwh: '',
          gasKwh: '',
          elecEuro: '',
          gasEuro: '',
          noData: false,
          works: [],
          hasWorks: 'no',
          ecsSystem: '',
          firstName: '',
          email: '',
          phone: '',
          consent: false
      };

      const LS_KEY = 'diagtertiaire_v1';
      
      
      
      const CTA_CALENDLY_URL = 'https://calendly.com/TON-LIEN'; // √† remplacer
const CTA_EMAIL = 'contact@diagtertiaire.fr';

      /* --- HELPERS --- */
      const saveToLS = (data) => {
          try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch(e) {}
      };
      const loadFromLS = () => {
          try {
              const d = localStorage.getItem(LS_KEY);
              return d ? JSON.parse(d) : null;
          } catch(e) { return null; }
      };
      const clearLS = () => {
          try { localStorage.removeItem(LS_KEY); } catch(e) {}
      };

      /* --- UI COMPONENTS --- */
      const Icon = ({ icon, className = "" }) => (
          <iconify-icon icon={icon} class={`${className} text-2xl`} style={{ strokeWidth: '1.5' }}></iconify-icon>
      );

      const Button = ({ children, onClick, disabled, variant = 'primary', className = '', type = 'button' }) => {
          const base = "px-6 py-3 rounded-lg font-semibold text-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center gap-2";
          const styles = {
              primary: "bg-[#1E3A5F] text-white hover:bg-[#162B47] focus:ring-[#1E3A5F] disabled:opacity-50 disabled:cursor-not-allowed shadow-sm",
              secondary: "bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 focus:ring-slate-200",
              ghost: "text-slate-500 hover:text-[#1E3A5F]",
              green: "bg-[#2ECC71] text-white hover:bg-[#27AE60] focus:ring-[#2ECC71] shadow-sm"
          };
          return (
              <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className}`}>
                  {children}
              </button>
          );
      };

      const CardSelect = ({ selected, onClick, icon, label, sub }) => (
          <div
              onClick={onClick}
              className={`cursor-pointer border rounded-xl p-4 transition-all duration-200 flex flex-col items-center text-center gap-3 h-full relative group
              ${selected ? 'bg-[#EEF2FF] border-[#1E3A5F] border-[2px] shadow-sm' : 'bg-white border-slate-200 hover:border-[#1E3A5F]/50 hover:shadow-sm'}`}
          >
              <div className={`p-2 rounded-full transition-colors ${selected ? 'bg-[#1E3A5F] text-white' : 'bg-slate-100 text-slate-400 group-hover:text-slate-600'}`}>
                  <Icon icon={icon} />
              </div>
              <div>
                  <div className={`text-sm ${selected ? 'font-semibold text-[#1E3A5F]' : 'font-medium text-slate-600'}`}>{label}</div>
                  {sub && <div className="text-xs text-slate-400 mt-1 leading-tight">{sub}</div>}
              </div>
          </div>
      );

      const RadioFull = ({ selected, onClick, label, sub }) => (
          <div onClick={onClick} className={`cursor-pointer border rounded-lg p-3 flex items-center justify-between transition-all ${selected ? 'border-[#1E3A5F] bg-[#EEF2FF] border-[2px]' : 'border-slate-200 bg-white hover:bg-slate-50'}`}>
              <div className="flex flex-col">
                  <span className={`text-sm ${selected ? 'font-semibold text-[#1E3A5F]' : 'font-medium text-slate-700'}`}>{label}</span>
                  <span className="text-xs text-slate-400 italic">{sub}</span>
              </div>
              <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${selected ? 'border-[#1E3A5F]' : 'border-slate-300'}`}>
                  {selected && <div className="w-2.5 h-2.5 rounded-full bg-[#1E3A5F]"></div>}
              </div>
          </div>
      );

      const SectionCard = ({ children, className = "" }) => (
          <div className={`bg-white rounded-xl shadow-md border border-slate-100 p-4 md:p-8 ${className}`}>
              {children}
          </div>
      );

      const Input = ({ type = "text", value, onChange, placeholder, label, suffix, min, max, note }) => (
          <div className="flex flex-col gap-2 w-full">
              {label && <label className="text-sm font-medium text-[#374151]">{label}</label>}
              <div className="relative">
                  <input
                      type={type} value={value} onChange={onChange} placeholder={placeholder} min={min} max={max}
                      className="w-full border border-slate-300 rounded-lg px-4 py-2.5 text-sm focus:border-[#1E3A5F] focus:ring-1 focus:ring-[#1E3A5F] outline-none transition-colors text-[#1E3A5F]"
                  />
                  {suffix && <span className="absolute right-4 top-2.5 text-sm text-slate-400">{suffix}</span>}
              </div>
              {note && <p className="text-sm text-[#9CA3AF] italic">{note}</p>}
          </div>
      );

      const Stepper = ({ currentStep }) => {
          const steps = [
              { id: 1, label: 'B√¢timent', pct: 25 },
              { id: 2, label: '√ânergie', pct: 50 },
              { id: 3, label: 'Contact', pct: 75 },
              { id: 4, label: 'Rapport', pct: 100 }
          ];
          const progressPercentage = steps.find(s => s.id === currentStep)?.pct || 25;

          return (
              <div className="mb-8 no-print w-full max-w-2xl mx-auto">
                  <div className="flex justify-between mb-3 px-1">
                      {steps.map((s) => (
                          <div key={s.id} className={`text-xs font-semibold tracking-wide transition-colors ${s.id <= currentStep ? 'text-[#1E3A5F]' : 'text-slate-300'}`}>
                              {s.label.toUpperCase()}
                          </div>
                      ))}
                  </div>
                  <div className="h-1 bg-[#E5E7EB] rounded-full w-full overflow-hidden">
                      <div
                          className="h-full bg-[#1E3A5F] transition-all duration-500 ease-out rounded-full"
                          style={{ width: `${progressPercentage}%` }}
                      ></div>
                  </div>
              </div>
          );
      };

      const FormHeader = ({ title, subtitle }) => (
          <div className="bg-white border-b border-slate-100 pb-6 mb-6 text-center">
              <h2 className="text-2xl tracking-tight font-semibold text-[#1E3A5F] mb-2">{title}</h2>
              <p className="text-[#6B7280]">{subtitle}</p>
          </div>
      );

      const SectionTitle = ({ children, sub }) => (
          <div className="text-center mb-10">
              <h2 className="text-2xl md:text-3xl tracking-tight font-semibold text-[#1E3A5F] mb-2">{children}</h2>
              {sub && <p className="text-[#6B7280] text-sm">{sub}</p>}
          </div>
      );

      /* --- CHART ERROR BOUNDARY --- */
      class ChartErrorBoundary extends React.Component {
          constructor(props) { super(props); this.state = { hasError: false }; }
          static getDerivedStateFromError(error) { return { hasError: true }; }
          render() {
              if (this.state.hasError) {
                  return (
                      <div className="h-64 flex flex-col items-center justify-center bg-slate-50 rounded-xl border border-slate-200 text-center p-6">
                          <Icon icon="solar:chart-2-linear" className="text-slate-300 mb-3" />
                          <p className="text-slate-500 font-medium text-sm mb-2">Graphique indisponible</p>
                          <p className="text-slate-400 text-xs">Valeurs disponibles en texte ci-dessous</p>
                          {this.props.fallbackData && (
                              <div className="mt-4 flex flex-col gap-1 w-full max-w-xs">
                                  {this.props.fallbackData.map((d, i) => (
                                      <div key={i} className="flex justify-between text-xs bg-white border border-slate-100 rounded px-3 py-1.5">
                                          <span className="text-slate-600">{d.name}</span>
                                          <span className="font-semibold text-[#1E3A5F]">{d.val} kWh/m¬≤</span>
                                      </div>
                                  ))}
                              </div>
                          )}
                      </div>
                  );
              }
              return this.props.children;
          }
      }

      /* --- PDF EXPORT --- */

      

const exportPDF = (data, analysis = {}) => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4" });

  // =========================
  // Helpers
  // =========================
  const fmt = (v) => {
    const n = Number(v || 0);
    return n.toLocaleString("fr-FR");
  };

  const fmtDec = (v, digits = 1) => {
    const n = Number(v || 0);
    return n.toLocaleString("fr-FR", {
      minimumFractionDigits: digits,
      maximumFractionDigits: digits,
    });
  };

  const safe = (v, fallback = "N/A") =>
    v === undefined || v === null || v === "" ? fallback : v;

  const formatRangeEuro = (min, max) => `${fmt(min)} √† ${fmt(max)} ‚Ç¨`;

  const computeROI = (costMin, costMax, gainEuro) => {
    const gain = Number(gainEuro || 0);
    if (!gain || gain <= 0 || (!costMin && !costMax)) return "√Ä estimer";
    const roiMin = Math.round((costMin / gain) * 10) / 10;
    const roiMax = Math.round((costMax / gain) * 10) / 10;
    return `${fmtDec(roiMin)} √† ${fmtDec(roiMax)} ans`;
  };

  const getConfidenceLevel = (d) => {
    let score = 0;
    if (d.elecKwh || d.gasKwh || d.elecEuro || d.gasEuro) score += 40;
    if (d.heatingAge && d.heatingAge !== "Je ne sais pas") score += 20;
    if (d.occupation) score += 15;
    if (d.year) score += 15;
    if (d.works && Array.isArray(d.works) && d.works.length > 0) score += 10;

    if (score >= 70) return { label: "√âlev√©e", color: [46, 204, 113] };
    if (score >= 40) return { label: "Moyenne", color: [243, 156, 18] };
    return { label: "Faible", color: [231, 76, 60] };
  };

  const drawSectionTitle = (title, x, y) => {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(30, 58, 95);
    doc.text(title, x, y);
  };

  const drawDPEGauge = (x, y, dpeLabel, kwhPerM2) => {
    const dpeData = [
      { label: "A", color: [26, 158, 92], width: 30 },
      { label: "B", color: [76, 184, 76], width: 40 },
      { label: "C", color: [178, 210, 79], width: 50 },
      { label: "D", color: [245, 229, 74], width: 60 },
      { label: "E", color: [245, 165, 35], width: 70 },
      { label: "F", color: [232, 98, 42], width: 80 },
      { label: "G", color: [212, 37, 42], width: 90 },
    ];

    dpeData.forEach((dpe, i) => {
      const yPos = y + i * 10;

      // Barre color√©e avec ombre
      doc.setFillColor(...dpe.color);
      doc.roundedRect(x, yPos, dpe.width, 8, 2, 2, "F");

      // Lettre blanche en gras
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(11);
      doc.text(dpe.label, x + 4, yPos + 5.5);

      // Si classe active : fl√®che + valeur
      if (dpe.label === dpeLabel) {
        // Fond blanc pour la valeur
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(x + dpe.width + 5, yPos - 1, 55, 10, 2, 2, "F");
        doc.setDrawColor(30, 58, 95);
        doc.roundedRect(x + dpe.width + 5, yPos - 1, 55, 10, 2, 2, "S");

        // Fl√®che
        doc.setDrawColor(30, 58, 95);
        doc.setLineWidth(1.2);
        const arrowX = x + dpe.width + 8;
        doc.line(arrowX, yPos + 4, arrowX + 5, yPos + 4);
        
        // Triangle
        doc.setFillColor(30, 58, 95);
        doc.triangle(
          arrowX + 5, yPos + 2,
          arrowX + 5, yPos + 6,
          arrowX + 9, yPos + 4,
          "F"
        );

        // Valeur kWh/m¬≤
        doc.setTextColor(30, 58, 95);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text(`${fmt(kwhPerM2)} kWh/m¬≤/an`, arrowX + 12, yPos + 5.5);
      }
    });
  };

  const drawComparisonBars = (x, y, kwhPerM2, refBase, activityLabel) => {
    const targetVal = Math.round(refBase * 0.8);
    const maxVal = Math.max(kwhPerM2 || 1, refBase || 1, targetVal || 1);
    const barMaxWidth = 115;

    const bars = [
      { label: "Votre b√¢timent", val: kwhPerM2, color: [231, 76, 60] },
      { label: `R√©f. ${activityLabel}`, val: refBase, color: [149, 165, 166] },
      { label: "Objectif perf.", val: targetVal, color: [46, 204, 113] },
    ];

    bars.forEach((bar, i) => {
      const yBar = y + i * 13;
      const barWidth = Math.max(5, (bar.val / maxVal) * barMaxWidth);

      // Label PLUS VISIBLE
      doc.setFont("helvetica", "bold");
      doc.setFontSize(8);
      doc.setTextColor(60, 60, 60);
      doc.text(bar.label, x, yBar + 5);

      // Barre avec ombre
      doc.setFillColor(220, 220, 220);
      doc.roundedRect(x + 58, yBar + 0.5, barWidth, 7, 2, 2, "F");
      
      doc.setFillColor(...bar.color);
      doc.roundedRect(x + 57, yBar, barWidth, 7, 2, 2, "F");

      // Valeur EN GRAS √† droite de la barre
      doc.setFont("helvetica", "bold");
      doc.setFontSize(9);
      doc.setTextColor(...bar.color);
      doc.text(`${fmt(bar.val)} kWh/m¬≤`, x + 60 + barWidth, yBar + 5);
    });

    return y + 40;
  };

  const drawActionCard = (x, y, priority, index) => {
    const cardH = 50;
    const cardW = 180;

    // Fond carte avec ombre simul√©e
    doc.setFillColor(250, 250, 250);
    doc.roundedRect(x + 0.5, y + 0.5, cardW, cardH, 3, 3, "F");
    
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(x, y, cardW, cardH, 3, 3, "F");
    doc.setDrawColor(226, 232, 240);
    doc.setLineWidth(0.5);
    doc.roundedRect(x, y, cardW, cardH, 3, 3, "S");

    // Barre color√©e gauche PLUS LARGE
    const catColors = {
      Enveloppe: [231, 76, 60],
      Pilotage: [52, 152, 219],
      "ROI rapide": [46, 204, 113],
      Confort: [243, 156, 18],
      Performance: [155, 89, 182]
    };
    const color = catColors[priority.tag] || [100, 116, 139];

    doc.setFillColor(...color);
    doc.rect(x, y, 4, cardH, "F");

    // Titre action PLUS GROS
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.setTextColor(30, 58, 95);
    doc.text(`${index}. ${priority.title}`, x + 7, y + 8);

    // Badge cat√©gorie avec fond color√©
    doc.setFillColor(...color, 30);
    doc.roundedRect(x + 7, y + 11, 32, 5.5, 1.5, 1.5, "F");
    doc.setFont("helvetica", "bold");
    doc.setFontSize(7);
    doc.setTextColor(...color);
    doc.text(priority.tag || "Action", x + 9, y + 14.5);

    const col1X = x + 7;
    const col2X = x + 98;
    let lineY = y + 21;

    // √âconomies √©nergie
    doc.setFont("helvetica", "normal");
    doc.setFontSize(7);
    doc.setTextColor(100, 116, 139);
    doc.text("√âconomies √©nergie", col1X, lineY);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(9);
    doc.setTextColor(30, 58, 95);
    doc.text(`${fmt(priority.gainKwhVal)} kWh/an`, col1X, lineY + 4.5);

    // Gain financier EN VERT
    doc.setFont("helvetica", "normal");
    doc.setFontSize(7);
    doc.setTextColor(100, 116, 139);
    doc.text("Gain financier", col2X, lineY);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(9);
    doc.setTextColor(46, 204, 113);
    doc.text(`${fmt(priority.gainEuro)} ‚Ç¨/an`, col2X, lineY + 4.5);

    lineY += 12;

    // Co√ªt (ON FORMATE ICI depuis costMin/costMax)
    doc.setFont("helvetica", "normal");
    doc.setFontSize(7);
    doc.setTextColor(100, 116, 139);
    doc.text("Co√ªt estimatif", col1X, lineY);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(8);
    doc.setTextColor(30, 58, 95);
    const costLabel = formatRangeEuro(priority.costMin, priority.costMax);
    doc.text(costLabel, col1X, lineY + 4);

    // ROI (ON CALCULE ICI depuis costMin/costMax/gainEuro)
    doc.setFont("helvetica", "normal");
    doc.setFontSize(7);
    doc.setTextColor(100, 116, 139);
    doc.text("ROI (hors aides)", col2X, lineY);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(8);
    doc.setTextColor(30, 58, 95);
    const roiLabel = computeROI(priority.costMin, priority.costMax, priority.gainEuro);
    doc.text(roiLabel, col2X, lineY + 4);

    // Aides avec fond jaune PLUS VISIBLE
    lineY += 11;
    doc.setFillColor(255, 249, 219);
    doc.roundedRect(x + 7, lineY - 2, cardW - 14, 11, 2, 2, "F");
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(7);
    doc.setTextColor(146, 64, 14);
    doc.text("üí∏ Aides indicatives", x + 9, lineY + 1);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(6.5);
    const ceeLabel = priority.aids?.cee?.label?.replace(/^CEE\s*:\s*/i, "") || "√Ä estimer";
    const mprLabel = priority.aids?.mpr?.label?.replace(/^MaPrimeR√©nov'\s*:\s*/i, "") || "√Ä v√©rifier";
    doc.text(`‚Ä¢ CEE : ${ceeLabel}`, x + 9, lineY + 5);
    doc.text(`‚Ä¢ MaPrimeR√©nov' : ${mprLabel}`, x + 9, lineY + 8.5);

    return y + cardH + 5;
  };

  const ensurePageSpace = (y, needed, marginBottom = 15) => {
    if (y + needed > 297 - marginBottom) {
      doc.addPage();
      return 15;
    }
    return y;
  };

  // =========================
  // Donn√©es source
  // =========================
  const margin = 12;
  const contentW = 210 - margin * 2;

  const buildingName = safe(data.buildingName, "B√¢timent tertiaire");
  const activityLabel = safe(analysis?.activityRef?.label || data.activityLabel || data.activity, "Tertiaire");
  const heating = safe(analysis?.heatingLabel || data.heating, "Non renseign√©");
  const surface = Number(data.surface || data.surfaceM2 || 0);
  const year = safe(data.year, "Non renseign√©e");

  const kwhPerM2 = Number(analysis.kwhPerM2 ?? data.kwhPerM2 ?? 0);
  const refBase = Number(analysis.refBase ?? data.refBase ?? 250);
  const targetVal = Math.round(refBase * 0.8);
  const dpeLabel = safe(analysis?.dpe?.l || data.dpeLabel, "D");

  const avgPrice = Number(analysis.avgPrice) || Number(data.avgPrice) || (String(heating).toLowerCase().includes("gaz") ? 0.12 : 0.25);

  let priorities = Array.isArray(analysis.priorities) ? [...analysis.priorities] : [];

  if (!priorities.length) {
    priorities = [
      {
        title: "Optimisation r√©gulation / programmation",
        tag: "Pilotage",
        gainKwhVal: 8000,
        gainEuro: 2013,
        costMin: 1500,
        costMax: 8000,
        aids: { cee: { label: "1 000 √† 4 000 ‚Ç¨" }, mpr: { label: "√Ä v√©rifier" } }
      }
    ];
  }

  // Logique conditionnelle de coh√©rence
  const diffRatio = refBase > 0 ? (kwhPerM2 - refBase) / refBase : 0;

  let performanceMessage = "";
  let performanceColor = [30, 58, 95];

  if (kwhPerM2 > 0 && diffRatio < 0) {
    performanceMessage = `Votre b√¢timent est plus performant que la r√©f√©rence (${fmt(Math.abs(Math.round(diffRatio * 100)))}% de moins).`;
    performanceColor = [46, 204, 113];
    priorities = priorities.filter((p) => ["Pilotage", "ROI rapide", "Confort"].includes(p.tag)).slice(0, 3);
  } else if (Math.abs(diffRatio) <= 0.15) {
    performanceMessage = "Votre b√¢timent est proche de la r√©f√©rence sectorielle. Des optimisations cibl√©es peuvent am√©liorer le rendement.";
    performanceColor = [243, 156, 18];
  } else {
    performanceMessage = `Votre b√¢timent semble au-dessus de la r√©f√©rence (+${fmt(Math.round(diffRatio * 100))}%). Prioriser les actions √† fort impact.`;
    performanceColor = [231, 76, 60];
  }

  // =========================
  // PAGE 1
  // =========================
  let y = 14;

  // Header
  doc.setFillColor(30, 58, 95);
  doc.roundedRect(margin, y, contentW, 18, 3, 3, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(15);
  doc.text("Rapport DiagTertiaire", margin + 5, y + 7);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.text("Diagnostic √©nerg√©tique simplifi√© - Rapport d'aide √† la d√©cision", margin + 5, y + 12.5);

  y += 24;

  // Infos b√¢timent
  doc.setFillColor(247, 250, 252);
  doc.roundedRect(margin, y, contentW, 24, 2, 2, "F");
  doc.setDrawColor(226, 232, 240);
  doc.roundedRect(margin, y, contentW, 24, 2, 2, "S");

  doc.setFont("helvetica", "bold");
  doc.setTextColor(30, 58, 95);
  doc.setFontSize(10);
  doc.text(buildingName, margin + 4, y + 6);

  doc.setFont("helvetica", "normal");
  doc.setTextColor(80, 80, 80);
  doc.setFontSize(8);
  doc.text(`Activit√© : ${activityLabel}`, margin + 4, y + 11);
  doc.text(`Surface : ${surface ? `${fmt(surface)} m¬≤` : "Non renseign√©e"}`, margin + 4, y + 16);
  doc.text(`Ann√©e : ${year}`, margin + 70, y + 11);
  doc.text(`Chauffage : ${heating}`, margin + 70, y + 16);

  y += 30;

  // Bloc synth√®se + DPE
  drawSectionTitle("Synth√®se de performance", margin, y);
  y += 4;

  doc.setFillColor(255, 255, 255);
  doc.roundedRect(margin, y, contentW, 58, 2, 2, "S");

  // DPE gauge
  drawDPEGauge(margin + 4, y + 4, dpeLabel, kwhPerM2);

  // KPIs √† droite
  const kpiX = margin + 108;
  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.setTextColor(100, 116, 139);
  doc.text("R√©f√©rence sectorielle", kpiX, y + 10);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.setTextColor(30, 58, 95);
  doc.text(`${fmt(refBase)} kWh/m¬≤/an`, kpiX, y + 16);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.setTextColor(100, 116, 139);
  doc.text("Objectif de performance", kpiX, y + 25);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.setTextColor(46, 204, 113);
  doc.text(`${fmt(targetVal)} kWh/m¬≤/an`, kpiX, y + 31);

  doc.setTextColor(...performanceColor);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(8);
  const perfLines = doc.splitTextToSize(performanceMessage, 82);
  doc.text(perfLines, kpiX, y + 39);

  y += 64;

  // Comparaison barres
  drawSectionTitle("Comparaison visuelle", margin, y);
  y += 4;
  doc.roundedRect(margin, y, contentW, 44, 2, 2, "S");
  y = drawComparisonBars(margin + 4, y + 4, kwhPerM2, refBase, activityLabel) + 4;

  // Niveau de confiance
  y = ensurePageSpace(y, 18);
  drawSectionTitle("Niveau de confiance", margin, y);
  y += 5;

  const confidence = getConfidenceLevel(data);
  doc.setTextColor(...confidence.color);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(9);
  doc.text(`Confiance estimation : ${confidence.label}`, margin, y);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(7);
  doc.setTextColor(120, 120, 120);
  doc.text(
    `(bas√©e sur ${data.noData ? "r√©f√©rences sectorielles" : "vos donn√©es d√©clar√©es"})`,
    margin,
    y + 4
  );
  y += 10;

  // Hypoth√®ses de calcul
  y = ensurePageSpace(y, 35);
  drawSectionTitle("Hypoth√®ses de calcul", margin, y);
  y += 5;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(7.5);
  doc.setTextColor(80, 80, 80);

  const hypotheses = [
    `Prix √©nergie (TTC) utilis√© : ${String(heating).toLowerCase().includes("gaz") ? "Gaz" : "√âlectricit√©"} = ${avgPrice.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚Ç¨/kWh`,
    `R√©f√©rence sectorielle : ${activityLabel} = ${fmt(refBase)} kWh/m¬≤/an (source ADEME / benchmarks tertiaires)`,
    `Objectif performance : 80% de la r√©f√©rence sectorielle`,
    `Fourchettes de co√ªts : base standard march√© 2026 (ordre de grandeur)`,
    `Marge d'incertitude indicative : ¬±30%`,
  ];

  hypotheses.forEach((h) => {
    doc.text(`‚Ä¢ ${h}`, margin + 2, y);
    y += 4.5;
  });

  // =========================
  // PAGE 2 - Actions
  // =========================
  doc.addPage();
  y = 14;

  // Header page 2
  doc.setFillColor(30, 58, 95);
  doc.roundedRect(margin, y, contentW, 14, 3, 3, "F");
  doc.setTextColor(255, 255, 255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Plan d'actions prioris√©", margin + 5, y + 9);
  y += 20;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(8);
  doc.setTextColor(100, 116, 139);
  doc.text("Recommandations indicatives √† confirmer par visite technique / audit.", margin, y);
  y += 6;

  priorities.slice(0, 3).forEach((p, idx) => {
    y = ensurePageSpace(y, 56);
    y = drawActionCard(margin, y, p, idx + 1);
  });

  // CTA
  y += 3;
  y = ensurePageSpace(y, 38);

  doc.setFillColor(30, 58, 95);
  doc.roundedRect(margin, y, contentW, 35, 3, 3, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text("PROCHAINE √âTAPE : VALIDATION AVEC UN EXPERT", margin + 5, y + 8);

  doc.setFont("helvetica", "normal");
  doc.setFontSize(7.5);
  doc.text("15 minutes offertes pour analyser votre rapport ensemble :", margin + 5, y + 14);
  doc.text("‚Ä¢ Valider les priorit√©s adapt√©es √† votre situation", margin + 8, y + 19);
  doc.text("‚Ä¢ Estimer les aides pr√©cises selon votre profil", margin + 8, y + 23);
  doc.text("‚Ä¢ Vous orienter vers les bons interlocuteurs (si souhait√©)", margin + 8, y + 27);

  doc.setFont("helvetica", "bold");
  doc.text("R√©server : diagtertiaire.fr/rdv  |  contact@diagtertiaire.fr", margin + 5, y + 32);

  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setDrawColor(230, 230, 230);
    doc.line(margin, 287, 210 - margin, 287);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(7);
    doc.setTextColor(120, 120, 120);
    doc.text(`DiagTertiaire - Rapport g√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")}`, margin, 291);
    doc.text(`Page ${i}/${pageCount}`, 210 - margin - 15, 291);
  }

  // Nom de fichier
  const fileName = `DiagTertiaire_rapport_${(buildingName || "batiment")
    .toString()
    .toLowerCase()
    .replace(/[^a-z0-9]+/gi, "_")
    .replace(/^_+|_+$/g, "")}_${new Date().toISOString().slice(0, 10)}.pdf`;

  doc.save(fileName);
};

   

      const MiniDPEGauge = ({ kwhPerM2, dpeLabel, dpeColor }) => (
          <div className="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
              <div className="flex items-center justify-between mb-4">
                  <span className="text-sm font-semibold text-[#1E3A5F]">Classe √©nerg√©tique estim√©e</span>
                  <span className="text-xs text-slate-400 italic">ordre de grandeur</span>
              </div>
              <div className="flex gap-1.5 items-end mb-3">
                  {['A','B','C','D','E','F','G'].map((l, i) => {
                      const colors = ['#1A9E5C','#4CB84C','#B2D24F','#F5E54A','#F5A623','#E8622A','#D4252A'];
                      const heights = ['h-4','h-6','h-8','h-10','h-12','h-14','h-16'];
                      const isActive = l === dpeLabel;
                      return (
                          <div key={l}
                              className={`flex-1 ${heights[i]} rounded-sm flex items-center justify-center text-xs font-semibold transition-all ${isActive ? 'ring-2 ring-offset-1 ring-[#1E3A5F] scale-110' : 'opacity-60'}`}
                              style={{ backgroundColor: colors[i], color: i < 3 ? '#1a1a1a' : '#fff' }}
                          >
                              {l}
                          </div>
                      );
                  })}
              </div>
              <div className="text-center">
                  <span className="text-2xl tracking-tight font-semibold" style={{ color: dpeColor }}>{dpeLabel}</span>
                  <span className="text-slate-500 text-sm ml-2">‚Ä¢ {kwhPerM2} kWh/m¬≤/an</span>
              </div>
          </div>
      );
const StepBuilding = ({ data, update, onNext }) => {
  const isValid = data.activity && data.year && Number(data.surface) > 0;

  return (
    <div className="fade-in max-w-3xl mx-auto">
      <SectionCard>
        <FormHeader
          title="D√©crivez votre b√¢timent"
          subtitle="Quelques informations suffisent pour une premi√®re estimation"
        />

        <div className="space-y-8">
          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">Type d'activit√©</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {ACTIVITIES.map((a) => (
                <CardSelect
                  key={a.id}
                  selected={data.activity === a.id}
                  onClick={() => update('activity', a.id)}
                  icon={a.icon}
                  label={a.label}
                />
              ))}
            </div>

            {data.activity === 'mixed' && (
              <div className="mt-4 bg-slate-50 border border-slate-200 rounded-xl p-4">
                <div className="flex items-center justify-between mb-2">
                  <label className="text-sm font-medium text-slate-700">
                    R√©partition Bureaux / Commerce
                  </label>
                  <span className="text-xs text-slate-500">
                    Bureaux {data.activityMixPct}% ‚Ä¢ Commerce {100 - (data.activityMixPct || 0)}%
                  </span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={data.activityMixPct ?? 50}
                  onChange={(e) => update('activityMixPct', Number(e.target.value))}
                  className="w-full"
                />
              </div>
            )}
          </div>

          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">P√©riode de construction</h3>
            <div className="grid md:grid-cols-2 gap-3">
              {YEARS.map((y) => (
                <RadioFull
                  key={y.id}
                  selected={data.year === y.id}
                  onClick={() => update('year', y.id)}
                  label={y.label}
                  sub={y.sub}
                />
              ))}
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <Input
              type="number"
              label="Surface totale"
              suffix="m¬≤"
              min={1}
              value={data.surface}
              onChange={(e) => update('surface', Number(e.target.value || 0))}
              placeholder="Ex: 300"
            />
            <Input
              type="number"
              label="Nombre de niveaux"
              min={1}
              value={data.levels}
              onChange={(e) => update('levels', Number(e.target.value || 1))}
              placeholder="Ex: 1"
            />
          </div>

          <div className="flex justify-end">
            <Button onClick={onNext} disabled={!isValid}>
              Continuer ‚Üí
            </Button>
          </div>
        </div>
      </SectionCard>
    </div>
  );
};

const StepEnergy = ({ data, update, onNext, onBack }) => {
  const hasEnergyData =
    data.noData ||
    (data.consumptionMode === 'kwh'
      ? (Number(data.elecKwh || 0) + Number(data.gasKwh || 0) > 0)
      : (Number(data.elecEuro || 0) + Number(data.gasEuro || 0) > 0));

  const isValid =
    data.heating &&
    data.heatingAge &&
    data.occupation &&
    data.hasWorks &&
    (data.noData || hasEnergyData);

  const toggleWork = (workId) => {
    const current = Array.isArray(data.works) ? data.works : [];
    if (current.includes(workId)) {
      update('works', current.filter((id) => id !== workId));
    } else {
      update('works', [...current, workId]);
    }
  };

  return (
    <div className="fade-in max-w-3xl mx-auto">
      <SectionCard>
        <FormHeader
          title="Vos √©quipements et consommations"
          subtitle="On affine l‚Äôestimation √©nerg√©tique et les priorit√©s d‚Äôaction"
        />

        <div className="space-y-8">
          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">Syst√®me de chauffage principal</h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {HEATING.map((h) => (
                <CardSelect
                  key={h.id}
                  selected={data.heating === h.id}
                  onClick={() => update('heating', h.id)}
                  icon={h.icon}
                  label={h.label}
                />
              ))}
            </div>
          </div>

          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">√Çge du syst√®me de chauffage</h3>
            <div className="grid md:grid-cols-3 gap-3">
              {['< 5 ans', '5 √† 15 ans', '> 15 ans'].map((age) => (
                <RadioFull
                  key={age}
                  selected={data.heatingAge === age}
                  onClick={() => update('heatingAge', age)}
                  label={age}
                  sub={age === '> 15 ans' ? 'Souvent moins performant' : ' '}
                />
              ))}
            </div>
          </div>

          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">Occupation du b√¢timent</h3>
            <div className="grid md:grid-cols-2 gap-3">
              {OCCUPATION_OPTS.map((o) => (
                <CardSelect
                  key={o.id}
                  selected={data.occupation === o.id}
                  onClick={() => update('occupation', o.id)}
                  icon={o.icon}
                  label={o.label}
                  sub={o.sub}
                />
              ))}
            </div>
          </div>

          <div className="border border-slate-200 rounded-xl p-4 bg-slate-50">
            <div className="flex items-center justify-between gap-3 mb-3">
              <h3 className="text-sm font-semibold text-[#1E3A5F]">Consommation annuelle</h3>
              <label className="flex items-center gap-2 text-xs text-slate-600 cursor-pointer">
                <input
                  type="checkbox"
                  checked={!!data.noData}
                  onChange={(e) => update('noData', e.target.checked)}
                />
                Je n‚Äôai pas mes donn√©es (estimation automatique)
              </label>
            </div>

            {!data.noData && (
              <>
                <div className="flex gap-2 mb-4">
                  <button
                    type="button"
                    onClick={() => update('consumptionMode', 'kwh')}
                    className={`px-3 py-1.5 rounded-lg text-xs font-semibold border ${
                      data.consumptionMode === 'kwh'
                        ? 'bg-[#1E3A5F] text-white border-[#1E3A5F]'
                        : 'bg-white text-slate-600 border-slate-300'
                    }`}
                  >
                    En kWh
                  </button>
                  <button
                    type="button"
                    onClick={() => update('consumptionMode', 'euro')}
                    className={`px-3 py-1.5 rounded-lg text-xs font-semibold border ${
                      data.consumptionMode === 'euro'
                        ? 'bg-[#1E3A5F] text-white border-[#1E3A5F]'
                        : 'bg-white text-slate-600 border-slate-300'
                    }`}
                  >
                    En ‚Ç¨
                  </button>
                </div>

                {data.consumptionMode === 'kwh' ? (
                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      type="number"
                      label="√âlectricit√©"
                      suffix="kWh/an"
                      value={data.elecKwh}
                      onChange={(e) => update('elecKwh', e.target.value)}
                      placeholder="Ex: 45000"
                    />
                    <Input
                      type="number"
                      label="Gaz"
                      suffix="kWh/an"
                      value={data.gasKwh}
                      onChange={(e) => update('gasKwh', e.target.value)}
                      placeholder="Ex: 120000"
                    />
                  </div>
                ) : (
                  <div className="grid md:grid-cols-2 gap-4">
                    <Input
                      type="number"
                      label="Facture √©lectricit√©"
                      suffix="‚Ç¨/an"
                      value={data.elecEuro}
                      onChange={(e) => update('elecEuro', e.target.value)}
                      placeholder="Ex: 12000"
                    />
                    <Input
                      type="number"
                      label="Facture gaz"
                      suffix="‚Ç¨/an"
                      value={data.gasEuro}
                      onChange={(e) => update('gasEuro', e.target.value)}
                      placeholder="Ex: 8000"
                    />
                  </div>
                )}
              </>
            )}
          </div>

          <div>
            <h3 className="text-sm font-semibold text-[#1E3A5F] mb-3">Des travaux ont-ils d√©j√† √©t√© r√©alis√©s ?</h3>
            <div className="grid md:grid-cols-2 gap-3 mb-3">
              <RadioFull
                selected={data.hasWorks === 'no'}
                onClick={() => {
                  update('hasWorks', 'no');
                  update('works', []);
                }}
                label="Non"
                sub="Aucun poste significatif r√©cemment"
              />
              <RadioFull
                selected={data.hasWorks === 'yes'}
                onClick={() => update('hasWorks', 'yes')}
                label="Oui"
                sub="Je s√©lectionne les postes d√©j√† trait√©s"
              />
            </div>

            {data.hasWorks === 'yes' && (
              <div className="grid md:grid-cols-2 gap-2">
                {WORKS_LIST.map((w) => {
                  const checked = (data.works || []).includes(w.id);
                  return (
                    <label
                      key={w.id}
                      className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-colors ${
                        checked
                          ? 'bg-[#EEF2FF] border-[#1E3A5F]'
                          : 'bg-white border-slate-200 hover:bg-slate-50'
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={checked}
                        onChange={() => toggleWork(w.id)}
                      />
                      <span className="text-sm text-slate-700">{w.label}</span>
                    </label>
                  );
                })}
              </div>
            )}
          </div>

          <div className="flex items-center justify-between pt-2">
            <button
              type="button"
              onClick={onBack}
              className="text-slate-500 hover:text-slate-700 text-sm font-medium"
            >
              ‚Üê Retour
            </button>

            <Button onClick={onNext} disabled={!isValid}>
              Continuer ‚Üí
            </Button>
          </div>
        </div>
      </SectionCard>
    </div>
  );
};
      const StepLead = ({ data, update, onNext, onBack }) => {
          const isValid = data.firstName && data.email && data.consent;

          const activityRef = ACTIVITIES.find(a => a.id === data.activity) || ACTIVITIES[0];
          const yearRef = YEARS.find(y => y.id === data.year) || YEARS[0];
          const getMixedRef = (pct) => Math.round((180 * pct / 100) + (350 * (100 - pct) / 100));
          const refBase = data.activity === 'mixed' ? getMixedRef(data.activityMixPct) : activityRef.refKwh;

          const sysCoef = data.heatingAge === '> 15 ans' ? 1.15 : data.heatingAge === '5 √† 15 ans' ? 1.05 : 1.1;
          let consumptionTotalKwh = 0;

          if (data.noData) {
              consumptionTotalKwh = refBase * data.surface * yearRef.coef * sysCoef;
          } else {
              consumptionTotalKwh = data.consumptionMode === 'kwh'
                  ? (parseFloat(data.elecKwh)||0) + (parseFloat(data.gasKwh)||0)
                  : ((parseFloat(data.elecEuro)||0)/0.25) + ((parseFloat(data.gasEuro)||0)/0.12);
              if (consumptionTotalKwh === 0) consumptionTotalKwh = refBase * data.surface * yearRef.coef * sysCoef;
          }

        const kwhPerM2 = Math.round(consumptionTotalKwh / data.surface);
const dpe = getDPE(kwhPerM2);

          return (
              <div className="fade-in max-w-lg mx-auto space-y-6">
                  <div className="space-y-3">
                      <MiniDPEGauge kwhPerM2={kwhPerM2} dpeLabel={dpe.l} dpeColor={dpe.c} />

                      <div className="relative rounded-xl overflow-hidden border border-slate-100 shadow-sm">
                          <div className="blur-overlay bg-white p-5 space-y-3">
                              {[1,2,3].map(i => (
                                  <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
                                      <div className="w-8 h-8 rounded-full bg-[#1E3A5F]/20 flex-shrink-0"></div>
                                      <div className="space-y-1.5 flex-1">
                                          <div className="h-3 bg-slate-200 rounded w-3/4"></div>
                                          <div className="h-2.5 bg-slate-100 rounded w-1/2"></div>
                                      </div>
                                      <div className="h-6 w-16 bg-green-100 rounded"></div>
                                  </div>
                              ))}
                          </div>
                          <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/60 backdrop-blur-sm">
                              <div className="bg-[#1E3A5F] text-white rounded-xl px-5 py-4 text-center shadow-lg max-w-xs mx-4">
                                  <Icon icon="solar:lock-keyhole-linear" className="mb-2 block mx-auto text-3xl" />
                                  <p className="font-semibold text-sm mb-1">D√©bloquez vos 3 priorit√©s</p>
                                  <p className="text-xs text-blue-200">Entrez votre email ci-dessous pour acc√©der au rapport complet et au plan d'action personnalis√©.</p>
                              </div>
                          </div>
                      </div>
                  </div>

                  <SectionCard>
                      <div className="text-center space-y-2 mb-6">
                          <div className="w-16 h-16 bg-[#2ECC71]/10 rounded-full flex items-center justify-center mx-auto mb-4 text-[#2ECC71]">
                              <Icon icon="solar:document-check-linear" className="text-4xl" />
                          </div>
                          <h2 className="text-2xl tracking-tight font-semibold text-[#1E3A5F]">Votre estimation est pr√™te</h2>
                          <p className="text-[#6B7280]">Entrez votre email pour acc√©der √† votre rapport complet et recevoir un plan d'action concret.</p>
                      </div>

                      <div className="space-y-5">
                          <Input label="Pr√©nom" placeholder="Votre pr√©nom" value={data.firstName} onChange={(e) => update('firstName', e.target.value)} />
                          <Input type="email" label="Email professionnel" placeholder="vous@entreprise.com" value={data.email} onChange={(e) => update('email', e.target.value)} />
                          <Input type="tel" label="T√©l√©phone (optionnel)" placeholder="06 XX XX XX XX" value={data.phone} onChange={(e) => update('phone', e.target.value)} note="Pour √™tre recontact√© si vous le souhaitez" />

                          <label className="flex gap-3 items-start cursor-pointer group p-3 border border-transparent hover:bg-slate-50 rounded-lg transition-colors">
                              <div className="relative flex items-center mt-0.5">
                                  <input
                                      type="checkbox" checked={data.consent} onChange={(e) => update('consent', e.target.checked)}
                                      className="peer h-4 w-4 cursor-pointer appearance-none rounded border border-slate-300 bg-white checked:border-[#1E3A5F] checked:bg-[#1E3A5F] transition-all"
                                  />
                                  <Icon icon="solar:check-linear" className="absolute left-0 top-0 text-white opacity-0 peer-checked:opacity-100 pointer-events-none text-xs" />
                              </div>
                              <span className="text-xs text-slate-500 leading-relaxed group-hover:text-slate-700">
                                  J'accepte de recevoir mon rapport et des recommandations sur la r√©novation √©nerg√©tique. D√©sabonnement en 1 clic.
                              </span>
                          </label>

                          <Button onClick={onNext} disabled={!isValid} className="w-full justify-center text-base py-4 shadow-lg shadow-[#1E3A5F]/20">
                              Acc√©der √† mon rapport ‚Üí
                          </Button>
                      </div>
                  </SectionCard>

                  <div className="flex justify-center">
                      <button type="button" onClick={onBack} className="text-slate-400 text-sm hover:text-slate-600 font-medium">Retour</button>
                  </div>
              </div>
          );
      };
      /* --- REPORT ENGINE (source unique de calculs rapport √©cran + PDF) --- */

const ENERGY_PRICES = {
  elec: 0.25,        // Prix TTC r√©aliste 2026
  gas: 0.12,         // Prix TTC r√©aliste 2026 (corrig√©)
  oil: 0.13,
  pac: 0.10,
  ac: 0.18,
  unknown: 0.18
};

const formatInt = (v) => Math.round(Number(v || 0)).toLocaleString('fr-FR');
const formatEuro = (v) => `${formatInt(v)} ‚Ç¨`;
const formatRangeEuro = (min, max) => `${formatInt(min)} - ${formatInt(max)} ‚Ç¨`;

const formatRoiYears = (cost, annualSaving) => {
  const c = Number(cost || 0);
  const s = Number(annualSaving || 0);

  if (s <= 0) return 'Non calculable';

  const roi = c / s;
  if (roi < 0.1) return '< 0,1 an';
  if (roi < 2) return `${roi.toFixed(1).replace('.', ',')} an`;
  return `${roi.toFixed(1).replace('.', ',')} ans`;
};

const getEnergyPrice = (heatingId) => {
  return ENERGY_PRICES[heatingId] ?? ENERGY_PRICES.unknown;
};

const getHeatingLabel = (heatingId) => {
  const h = HEATING.find(x => x.id === heatingId);
  return h ? h.label : 'Non pr√©cis√©';
};

const getOccupationLabel = (occId) => {
  const o = OCCUPATION_OPTS.find(x => x.id === occId);
  return o ? o.label : 'Non pr√©cis√©';
};

const getMixedRef = (pct = 50) => {
  // Conserv√© volontairement simple (bureaux + retail)
  return Math.round((180 * pct / 100) + (350 * (100 - pct) / 100));
};

const parseCostRange = (costStr) => {
  if (!costStr || typeof costStr !== 'string') return { min: 0, max: 0 };

  // Exemples g√©r√©s :
  // "6 000 - 25 000 ‚Ç¨"
  // "6 000 √† 25 000 ‚Ç¨"
  // "1500-8000 ‚Ç¨"
  const nums = String(costStr)
    .replace(/[‚Ç¨]/g, '')
    .replace(/√†/gi, ' ')
    .replace(/[‚Äì-]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .match(/\d+/g);

  if (!nums || nums.length === 0) return { min: 0, max: 0 };

  const values = nums.map(Number);

  // Cas "6 000 25 000" -> [6,000,25,000]
  if (values.length === 4 && values[1] < 1000 && values[3] < 1000) {
    return {
      min: values[0] * 1000 + values[1],
      max: values[2] * 1000 + values[3]
    };
  }

  if (values.length >= 2) {
    return {
      min: Math.min(...values),
      max: Math.max(...values)
    };
  }

  return { min: values[0], max: values[0] };
};

const estimateAidRanges = (priorityId, surface, isDecretEligible) => {
  // Fourchettes prudentes et g√©n√©riques (non contractuelles)
  let cee = null;
  let mpr = null;
  let decret = null;

  if (priorityId === 'roof') {
    cee = {
      min: surface * 8,
      max: surface * 22,
      label: `CEE : ${formatRangeEuro(surface * 8, surface * 22)}`
    };
    mpr = {
      label: `MaPrimeR√©nov' : montant variable selon statut et √©ligibilit√©`
    };
  }

  if (priorityId === 'windows') {
    cee = {
      min: surface * 4,
      max: surface * 12,
      label: `CEE : ${formatRangeEuro(surface * 4, surface * 12)}`
    };
    mpr = {
      label: `MaPrimeR√©nov' : montant variable selon statut et √©ligibilit√©`
    };
  }

  if (priorityId === 'heating') {
    cee = {
      min: 1500,
      max: 8000,
      label: `CEE : ${formatRangeEuro(1500, 8000)}`
    };
    mpr = {
      label: `MaPrimeR√©nov' : montant variable selon statut et √©ligibilit√©`
    };
  }

  if (priorityId === 'regulation' || priorityId === 'gtb') {
    cee = {
      min: 800,
      max: 4000,
      label: `CEE : ${formatRangeEuro(800, 4000)}`
    };
    mpr = {
      label: `MaPrimeR√©nov' : g√©n√©ralement non prioritaire / √† v√©rifier`
    };
  }

  if (priorityId === 'led') {
    cee = {
      min: 500,
      max: 2500,
      label: `CEE : ${formatRangeEuro(500, 2500)}`
    };
    mpr = {
      label: `MaPrimeR√©nov' : g√©n√©ralement non applicable`
    };
  }

  if (isDecretEligible) {
    decret = {
      label: `B√¢timent potentiellement soumis au D√©cret Tertiaire (analyse de conformit√© √† pr√©voir)`
    };
  }

  return { cee, mpr, decret };
};
const getDPE = (val) => {
  if (val <= 70) return { l: 'A', c: '#1A9E5C', w: '40%' };
  if (val <= 110) return { l: 'B', c: '#4CB84C', w: '48%' };
  if (val <= 180) return { l: 'C', c: '#B2D24F', w: '56%' };
  if (val <= 250) return { l: 'D', c: '#F5E54A', w: '64%' };
  if (val <= 330) return { l: 'E', c: '#F5A623', w: '72%' };
  if (val <= 420) return { l: 'F', c: '#E8622A', w: '80%' };
  return { l: 'G', c: '#D4252A', w: '88%' };
};
const buildReportData = (data) => {
  const activityRef = ACTIVITIES.find(a => a.id === data.activity) || ACTIVITIES[0];
  const yearRef = YEARS.find(y => y.id === data.year) || YEARS[0];

  const refBase = data.activity === 'mixed'
    ? getMixedRef(data.activityMixPct || 50)
    : activityRef.refKwh;

  const heatingLabel = getHeatingLabel(data.heating);
  const occupationLabel = getOccupationLabel(data.occupation);

  // Prix √©nergie (corrig√©)
  const avgPrice = getEnergyPrice(data.heating);

  // Calcul consommation totale
  let sysCoef = data.heatingAge === '> 15 ans' ? 1.15 : data.heatingAge === '5 √† 15 ans' ? 1.05 : 1.0;

  let consumptionTotalKwh = 0;
  if (data.noData) {
    consumptionTotalKwh = Math.round((refBase * yearRef.coef * sysCoef) * Number(data.surface || 0));
  } else {
    if (data.consumptionMode === 'euro') {
      const elecEuro = Number(data.elecEuro || 0);
      const gasEuro = Number(data.gasEuro || 0);
      const elecKwhFromEuro = elecEuro / 0.25;
      const gasKwhFromEuro = gasEuro / 0.12;
      consumptionTotalKwh = elecKwhFromEuro + gasKwhFromEuro;
    } else {
      const elec = Number(data.elecKwh || 0);
      const gas = Number(data.gasKwh || 0);
      consumptionTotalKwh = elec + gas;
    }

    if (!consumptionTotalKwh || consumptionTotalKwh <= 0) {
      consumptionTotalKwh = Math.round((refBase * yearRef.coef * sysCoef) * Number(data.surface || 0));
    }
  }

  const surface = Math.max(1, Number(data.surface || 1));
  const kwhPerM2 = Math.round(consumptionTotalKwh / surface);

  const dpe = typeof getDPE === 'function' ? getDPE(kwhPerM2) : { l: 'D', c: '#F59E0B', w: '70%' };

  const refTotal = refBase * surface;
  const diffPctRaw = ((kwhPerM2 - refBase) / refBase) * 100;
  const diffPct = Math.round(diffPctRaw);

  const totalCost = Math.round(consumptionTotalKwh * avgPrice);
  const wasteKwh = Math.max(0, consumptionTotalKwh - refTotal);
  const wasteEuro = Math.round(wasteKwh * avgPrice);

  const isDecretEligible = surface >= 1000;

  // Priorit√©s - NE PAS FORMATER LES CO√õTS ICI (on le fera dans le PDF)
  const potentialPriorities = [
    { id: 'roof', tag: 'Enveloppe', title: "Isolation toiture / combles", gainPct: 0.18, costMin: 6000, costMax: 25000 },
    { id: 'regulation', tag: 'Pilotage', title: "R√©gulation / programmation", gainPct: 0.10, costMin: 1500, costMax: 8000 },
    { id: 'windows', tag: 'Confort', title: "Menuiseries / √©tanch√©it√©", gainPct: 0.08, costMin: 5000, costMax: 30000 },
    { id: 'heating', tag: 'Performance', title: "Remplacement chauffage", gainPct: 0.20, costMin: 12000, costMax: 30000 },
    { id: 'led', tag: 'ROI rapide', title: "Relamping LED complet", gainPct: 0.12, costMin: 3000, costMax: 12000 }
  ];

  let selectedIds = [];
  if (data.year === 'pre1975' || data.year === '1975-1990') {
    selectedIds = ['roof', 'regulation', 'windows'];
  } else {
    selectedIds = ['regulation', 'led', 'roof'];
  }

  if (data.heatingAge === '> 15 ans') {
    selectedIds[2] = 'heating';
  }

  const doneWorks = Array.isArray(data.works) ? data.works : [];
  const priorities = selectedIds
    .filter(id => !doneWorks.includes(id))
    .slice(0, 3)
    .map((id) => {
      const p = potentialPriorities.find(x => x.id === id);
      if (!p) return null;

      const gainKwhVal = Math.round(consumptionTotalKwh * p.gainPct);
      const gainEuro = Math.round(gainKwhVal * avgPrice);

      const aids = estimateAidRanges(p.id, surface, isDecretEligible);

      return {
        ...p,
        gainKwhVal,        // NOMBRE PUR (pas de formatage)
        gainKwhPct: `${Math.round(p.gainPct * 100)}%`,
        gainEuro,          // NOMBRE PUR (pas de formatage)
        aids
      };
    })
    .filter(Boolean);

  const annualSavingsIfTop3 = priorities.reduce((sum, p) => sum + p.gainEuro, 0);
  const projection5Y = annualSavingsIfTop3 * 5;
  const projection10Y = annualSavingsIfTop3 * 10;

  const timeline = [
    { step: 1, title: "Audit / visite technique", desc: "Valider les postes prioritaires et les hypoth√®ses de consommation." },
    { step: 2, title: "Chiffrage et aides", desc: "Confirmer les devis et l'√©ligibilit√© r√©elle aux aides." },
    { step: 3, title: "Planification travaux", desc: "Prioriser les actions selon budget, usage et contraintes d'exploitation." },
    { step: 4, title: isDecretEligible ? "Suivi conformit√© D√©cret Tertiaire" : "Suivi des gains", desc: isDecretEligible ? "Structurer la trajectoire 2030/2040/2050." : "V√©rifier les √©conomies apr√®s travaux." }
  ];

  return {
    activityRef,
    yearRef,
    heatingLabel,
    occupationLabel,
    surface,
    refBase,
    refTotal,
    consumptionTotalKwh,
    kwhPerM2,
    dpe,
    avgPrice,
    totalCost,
    diffPct,
    diffPctRaw,
    wasteKwh,
    wasteEuro,
    isDecretEligible,
    priorities,
    annualSavingsIfTop3,
    projection5Y,
    projection10Y,
    timeline,
    disclaimer: {
      precision: "Ordre de grandeur (¬±30%)",
      legalShort: "Estimation directionnelle bas√©e sur donn√©es d√©claratives et r√©f√©rences sectorielles. Non contractuel."
    }
  };
};

    const StepReport = ({ data }) => {
  const [rechartsReady, setRechartsReady] = useState(false);

 const report = buildReportData(data);

  const {
    activityRef,
    yearRef,
    refBase,
    kwhPerM2,
    dpe,
    isDecretEligible,
    priorities
  } = report;

  useEffect(() => {
    const checkRecharts = () => {
      if (window.Recharts && window.Recharts.BarChart) setRechartsReady(true);
      else setTimeout(checkRecharts, 100);
    };
    checkRecharts();
  }, []);

  const targetVal = isDecretEligible ? Math.round(refBase * 0.6) : Math.round(refBase * 0.8);

  const chartData = [
    { name: 'Votre b√¢timent', val: kwhPerM2, fill: '#1E3A5F' },
    { name: `R√©f√©rence ${activityRef.label}`, val: refBase, fill: '#95A5A6' },
    { name: isDecretEligible ? 'Objectif 2030' : 'Objectif perf.', val: targetVal, fill: '#2ECC71' },
  ];

  const handleExportPDF = (e) => {
    e.preventDefault();
    exportPDF(data, report);
  };

  return (
    <div className="fade-in pb-20 max-w-4xl mx-auto w-full">
      <div className="mb-6 bg-amber-50 border border-amber-200 rounded-xl p-3 flex gap-2 items-start text-amber-800 text-xs">
        <Icon icon="solar:info-circle-linear" className="shrink-0 mt-0.5 text-amber-600" />
        <span><strong>Estimation directionnelle</strong> : ce rapport est un ordre de grandeur bas√© sur des valeurs sectorielles. Il ne remplace pas un audit r√©glementaire.</span>
      </div>

      <div className="bg-[#1E3A5F] rounded-t-xl p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4 shadow-lg">
        <div className="flex items-center gap-2">
          <Icon icon="solar:buildings-2-linear" className="text-2xl" />
          <span className="font-semibold text-lg">DiagTertiaire</span>
        </div>
        <div className="text-xs opacity-80">Rapport g√©n√©r√© le {new Date().toLocaleDateString()}</div>
      </div>

      <div className="bg-white p-4 rounded-b-xl shadow-md mb-8 flex flex-wrap justify-center gap-3 border border-t-0 border-slate-200">
        <span className="px-3 py-1 bg-slate-100 rounded-full text-xs font-semibold text-slate-600">{activityRef.label}</span>
        <span className="px-3 py-1 bg-slate-100 rounded-full text-xs font-semibold text-slate-600">{data.surface} m¬≤</span>
        <span className="px-3 py-1 bg-slate-100 rounded-full text-xs font-semibold text-slate-600">{yearRef.label}</span>
      </div>

      <SectionCard className="mb-8">
        <h2 className="text-xl tracking-tight font-semibold text-[#1E3A5F] mb-6">Performance √©nerg√©tique estim√©e</h2>

        <div className="flex flex-col gap-1 mb-4 relative">
          {['A','B','C','D','E','F','G'].map((l, i) => {
            const info = getDPE(i === 0 ? 0 : i === 1 ? 71 : i === 2 ? 111 : i === 3 ? 181 : i === 4 ? 251 : i === 5 ? 331 : 421);
            return (
              <div
                key={l}
                className="relative h-8 flex items-center rounded-r-md transition-all"
                style={{ width: info.w, backgroundColor: info.c }}
              >
                <div className="w-8 flex justify-center font-semibold text-white pl-2 drop-shadow-md">{l}</div>

                {dpe.l === l && (
                  <div className="hidden md:flex absolute top-0 right-0 h-full items-center translate-x-full pl-2 z-10">
                    <div className="w-0 h-0 border-y-[6px] border-y-transparent border-r-[8px] border-r-[#1E3A5F] mr-2 rotate-180"></div>
                    <span className="text-lg tracking-tight font-semibold text-[#1E3A5F] whitespace-nowrap">
                      {kwhPerM2} kWh/m¬≤/an
                    </span>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </SectionCard>

      <SectionCard className="mb-8">
        <h2 className="text-xl tracking-tight font-semibold text-[#1E3A5F] mb-1">Consommation vs R√©f√©rence</h2>
        <p className="text-xs text-slate-400 italic mb-4">Valeurs indicatives bas√©es sur des moyennes sectorielles</p>

        <ChartErrorBoundary fallbackData={chartData}>
          <div className="h-64 w-full">
            {rechartsReady ? (
              <ResponsiveContainer width="100%" height="100%">
                <BarChart layout="vertical" data={chartData} margin={{ top: 0, right: 60, left: 0, bottom: 0 }}>
                  <XAxis type="number" hide />
                  <YAxis dataKey="name" type="category" width={140} tick={{ fontSize: 12, fill: '#374151', fontWeight: 500 }} />
                  <Tooltip cursor={{ fill: 'transparent' }} />
                  <Bar dataKey="val" radius={[0, 4, 4, 0]} barSize={24}>
                    {chartData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.fill} />
                    ))}
                    <LabelList
                      dataKey="val"
                      position="right"
                      fill="#374151"
                      fontSize={12}
                      fontWeight="600"
                      formatter={(val) => `${val} kWh/m¬≤`}
                    />
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-full flex items-center justify-center text-slate-400">Chargement...</div>
            )}
          </div>
        </ChartErrorBoundary>
      </SectionCard>

      {priorities.length === 0 && (
        <div className="bg-white rounded-xl border border-slate-200 p-4 text-sm text-slate-600 mb-4">
          Vous avez d√©j√† r√©alis√© plusieurs actions pertinentes. Le rapport complet peut √™tre affin√© avec un audit pour identifier les optimisations restantes (r√©glages, pilotage, maintenance, usages).
        </div>
      )}

      <div className="mb-8">
        <h2 className="text-xl tracking-tight font-semibold text-[#1E3A5F] mb-4">Vos 3 priorit√©s d'action</h2>

        <div className="grid md:grid-cols-3 gap-6">
          {priorities.map((p, i) => (
            <div key={i} className="bg-white rounded-xl shadow-md border border-slate-100 overflow-hidden flex flex-col h-full">
              <div className="p-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                <span className="text-xs font-semibold text-slate-400">PRIORIT√â #{i + 1}</span>
                <span className="text-xs font-semibold px-2 py-1 rounded bg-white shadow-sm text-[#1E3A5F]">{p.tag}</span>
              </div>

              <div className="p-5 flex-1 flex flex-col">
                <h3 className="font-semibold text-[#1E3A5F] text-lg mb-4 leading-tight">{p.title}</h3>

                <div className="space-y-3 text-sm flex-1">
                  <div className="flex items-start gap-2 text-slate-600">
                    <Icon icon="solar:bolt-linear" className="text-base" />
                    <span>{p.gainKwhVal.toLocaleString('fr-FR')} kWh/an</span>
                  </div>

                  <div className="flex items-start gap-2 text-[#2ECC71]">
                    <Icon icon="solar:wallet-money-linear" className="text-base" />
                    <span className="font-semibold">Gain est. : {p.gainEuro.toLocaleString('fr-FR')} ‚Ç¨/an</span>
                  </div>

                <div className="flex items-start gap-2 text-slate-600">
  <Icon icon="solar:hammer-linear" className="text-base" />
  <span>Co√ªt : {p.costMin.toLocaleString('fr-FR')} √† {p.costMax.toLocaleString('fr-FR')} ‚Ç¨</span>
</div>

                  <div className="mt-3 pt-3 border-t border-slate-100 space-y-1">
                    <p className="text-[11px] font-semibold text-slate-500 uppercase tracking-wide">Aides indicatives</p>

                    {p.aids?.cee?.label && <p className="text-xs text-slate-600">‚Ä¢ {p.aids.cee.label}</p>}
                    {p.aids?.mpr?.label && <p className="text-xs text-slate-600">‚Ä¢ {p.aids.mpr.label}</p>}
                    {p.aids?.decret?.label && <p className="text-xs text-slate-600">‚Ä¢ {p.aids.decret.label}</p>}
                  </div>
                </div>

                <div className="mt-6 pt-4 border-t border-slate-100 flex justify-between items-center">
  <span className="text-xs text-slate-500">ROI indicatif</span>
  <span className="font-semibold text-[#1E3A5F] text-xs">
    {(() => {
      const gain = p.gainEuro || 0;
      if (!gain || gain <= 0) return "√Ä estimer";
      const roiMin = Math.round((p.costMin / gain) * 10) / 10;
      const roiMax = Math.round((p.costMax / gain) * 10) / 10;
      return `${roiMin.toLocaleString('fr-FR')} √† ${roiMax.toLocaleString('fr-FR')} ans`;
    })()}
  </span>
</div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-[#1E3A5F] rounded-2xl p-8 shadow-xl text-white mb-8 break-inside-avoid">
        <div className="grid md:grid-cols-2 gap-8 items-center">
          <div className="bg-slate-700 aspect-video rounded-lg flex flex-col items-center justify-center relative cursor-pointer group border border-white/10">
            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm group-hover:scale-110 transition-transform">
              <Icon icon="solar:play-linear" className="text-white text-2xl" />
            </div>
            <div className="absolute bottom-3 left-0 w-full text-center text-xs font-medium text-slate-300">
              Yannis ‚Ä¢ Consultant √ânergie
              <br />
              <span className="opacity-70">‚è± 2 minutes</span>
            </div>
          </div>

          <div className="space-y-4">
            <h3 className="text-xl tracking-tight font-semibold">Votre rapport soul√®ve des points importants</h3>
            <p className="text-slate-300 text-sm leading-relaxed">
              15 minutes pour analyser ensemble vos options et identifier les interlocuteurs qualifi√©s pour votre projet.
            </p>

            <a
              href={CTA_CALENDLY_URL}
              target="_blank"
              rel="noopener noreferrer"
              className="block w-full bg-white text-[#1E3A5F] font-semibold text-center py-3 rounded-lg hover:bg-slate-100 transition-colors"
            >
              üìÖ R√©server mon rendez-vous ‚Üí
            </a>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          type="button"
          onClick={handleExportPDF}
          className="bg-white border border-[#1E3A5F] text-[#1E3A5F] py-3 rounded-lg font-semibold hover:bg-slate-50 transition-colors flex items-center justify-center gap-2"
        >
          <Icon icon="solar:file-download-linear" /> T√©l√©charger en PDF
        </button>

        <a
          href={CTA_CALENDLY_URL}
          target="_blank"
          rel="noopener noreferrer"
          className="bg-[#1E3A5F] text-white py-3 rounded-lg font-semibold hover:bg-[#162B47] transition-colors flex items-center justify-center gap-2"
        >
          <Icon icon="solar:calendar-linear" /> R√©server mon rendez-vous
        </a>
      </div>
    </div>
  );
};
      /* --- PAGES --- */
      const PageHome = ({ navigate }) => (
          <div className="fade-in">
              {/* SECTION 1 - HERO */}
              <section className="bg-gradient-to-b from-[#F8F9FA] to-white py-16 lg:py-24">
                  <div className="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-12 items-center">
                      <div>
                          <div className="inline-flex items-center gap-2 bg-[#2ECC71]/10 border border-[#2ECC71]/30 rounded-full px-4 py-1.5 text-sm font-semibold text-[#2ECC71] mb-6">
                              <Icon icon="solar:clock-circle-bold" className="text-base" />
                              Gratuit ‚Ä¢ 3 minutes ‚Ä¢ R√©sultat imm√©diat
                          </div>
                          <h1 className="text-4xl lg:text-5xl tracking-tight font-semibold text-slate-900 leading-[1.1] mb-6">
                              Votre b√¢timent tertiaire vous co√ªte-t-il trop cher en √©nergie ? test1
                          </h1>
                          <p className="text-lg text-[#6B7280] leading-relaxed mb-8">
                              Le premier diagnostic gratuit con√ßu pour les b√¢timents tertiaires. Comparez-vous aux bonnes r√©f√©rences sectorielles, pas au logement.
                          </p>

                          <div className="grid sm:grid-cols-2 gap-6 mb-8">
                              <div className="space-y-3">
                                  <p className="text-sm font-semibold text-[#1E3A5F] uppercase tracking-wide">Propri√©taires</p>
                                  {['√âvaluez la performance de votre patrimoine','Identifiez les postes les plus co√ªteux','Estimez le ROI de vos travaux'].map((t, i) => (
                                      <div key={i} className="flex items-start gap-2">
                                          <iconify-icon icon="solar:check-circle-bold" style={{color:'#2ECC71', fontSize:'18px', flexShrink:0, marginTop:'2px'}}></iconify-icon>
                                          <span className="text-sm text-slate-600">{t}</span>
                                      </div>
                                  ))}
                              </div>
                              <div className="space-y-3">
                                  <p className="text-sm font-semibold text-[#1E3A5F] uppercase tracking-wide">Locataires</p>
                                  {['Objectivez vos demandes de r√©novation','N√©gociez avec des chiffres concrets','Anticipez vos futures factures'].map((t, i) => (
                                      <div key={i} className="flex items-start gap-2">
                                          <iconify-icon icon="solar:check-circle-bold" style={{color:'#2ECC71', fontSize:'18px', flexShrink:0, marginTop:'2px'}}></iconify-icon>
                                          <span className="text-sm text-slate-600">{t}</span>
                                      </div>
                                  ))}
                              </div>
                          </div>

                          <button type="button" onClick={() => navigate('diagnostic')} className="bg-[#1E3A5F] text-white px-8 py-4 rounded-xl text-base font-semibold hover:bg-[#162B47] shadow-lg transition-all flex items-center gap-2">
                              Obtenir mon diagnostic gratuit (3 min) <Icon icon="solar:arrow-right-linear" className="text-base" />
                          </button>
                          <div className="flex items-center gap-4 text-xs text-slate-500 mt-4">
                              <span className="flex items-center gap-1"><iconify-icon icon="solar:check-read-linear" style={{fontSize:'14px', color:'#2ECC71'}}></iconify-icon> Aucune expertise requise</span>
                              <span className="flex items-center gap-1"><iconify-icon icon="solar:check-read-linear" style={{fontSize:'14px', color:'#2ECC71'}}></iconify-icon> R√©sultat imm√©diat</span>
                              <span className="flex items-center gap-1"><iconify-icon icon="solar:check-read-linear" style={{fontSize:'14px', color:'#2ECC71'}}></iconify-icon> Aucun engagement</span>
                          </div>
                      </div>

                      <div className="hidden md:block">
                          <div className="bg-white rounded-2xl shadow-2xl p-6 border border-slate-100 relative">
                              <div className="flex items-center gap-3 mb-4">
                                  <div className="w-16 h-16 rounded-xl flex items-center justify-center text-3xl font-semibold" style={{backgroundColor:'#FFCC00'}}>
                                      <span style={{color:'#1E3A5F'}}>D</span>
                                  </div>
                                  <div>
                                      <div className="text-sm font-semibold text-slate-900">Classe estim√©e : D</div>
                                      <div className="text-xs text-slate-400">245 kWh/m¬≤/an</div>
                                  </div>
                              </div>
                              <div className="space-y-2 mb-4">
                                  {[{l:'Isolation toiture', c:'#F39C12', g:'2 100 ‚Ç¨/an'},{l:'R√©gulation / GTB', c:'#0891B2', g:'1 500 ‚Ç¨/an'}].map((p, i) => (
                                      <div key={i} className="bg-slate-50 rounded-lg p-3">
                                          <div className="flex items-center gap-2 mb-1">
                                              <div className="w-2 h-2 rounded-full" style={{backgroundColor:p.c}} />
                                              <span className="text-xs font-medium text-slate-700">{p.l}</span>
                                          </div>
                                          <span className="text-xs font-semibold text-[#2ECC71]">√âconomie : {p.g}</span>
                                      </div>
                                  ))}
                              </div>
                              <div className="absolute -top-3 -right-3 bg-[#2ECC71] text-white text-xs font-semibold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
                                  <iconify-icon icon="solar:bolt-linear" style={{fontSize:'14px'}}></iconify-icon> Rapport en 3 min
                              </div>
                          </div>
                      </div>
                  </div>
              </section>

              {/* SECTION 2 - SOCIAL PROOF */}
              <section className="bg-white py-8 border-y border-slate-100">
                  <div className="max-w-6xl mx-auto px-4">
                      <p className="text-center text-sm text-slate-500 mb-4">Utilis√© par 1 247 propri√©taires et gestionnaires de patrimoine</p>
                      <div className="flex flex-wrap justify-center items-center gap-8">
                          <div className="flex items-center gap-2 text-sm text-slate-600">
                              <iconify-icon icon="solar:buildings-2-linear" style={{fontSize:'20px', color:'#1E3A5F'}}></iconify-icon>
                              <span><strong className="font-semibold text-slate-900">847</strong> diagnostics ce mois</span>
                          </div>
                          <div className="flex items-center gap-2 text-sm text-slate-600">
                              <iconify-icon icon="solar:wallet-money-linear" style={{fontSize:'20px', color:'#2ECC71'}}></iconify-icon>
                              <span><strong className="font-semibold text-slate-900">4,2M‚Ç¨</strong> d'√©conomies identifi√©es</span>
                          </div>
                          <div className="flex items-center gap-2 text-sm text-slate-600">
                              <iconify-icon icon="solar:star-bold" style={{fontSize:'20px', color:'#FFC107'}}></iconify-icon>
                              <span><strong className="font-semibold text-slate-900">4.8/5</strong> sur 127 avis</span>
                          </div>
                      </div>
                  </div>
              </section>

              {/* SECTION 3 - PROBL√àME */}
              <section className="bg-[#F8F9FA] py-16">
                  <div className="max-w-6xl mx-auto px-4">
                      <SectionTitle sub="Sans diagnostic, vous perdez de l'argent chaque jour">Le co√ªt cach√© de l'inaction</SectionTitle>
                      <div className="grid md:grid-cols-3 gap-6">
                          {[
                              {icon:'solar:bill-list-linear', color:'#E74C3C', title:'Des factures qui explosent', desc:"En 3 ans, le prix de l'√©nergie a augment√© de 45% en moyenne. Sans diagnostic, impossible de savoir si vous payez 2 000 ‚Ç¨ ou 20 000 ‚Ç¨ de trop chaque ann√©e.", stat:'15 √† 35% de surco√ªt √©nerg√©tique sur les b√¢timents non optimis√©s'},
                              {icon:'solar:hourglass-linear', color:'#F39C12', title:'Aucun outil adapt√©', desc:"Les simulateurs en ligne sont con√ßus pour le logement. Un commerce qui consomme 350 kWh/m¬≤/an y serait class√© G ‚Äî alors que c'est normal. R√©sultat : impossible de savoir si vous √™tes bon ou mauvais.", stat:"Les r√©f√©rences r√©sidentielles faussent l'analyse de 40 √† 60%"},
                              {icon:'solar:wallet-linear', color:'#7B3F9E', title:'Des aides qui disparaissent', desc:"MaPrimeR√©nov', CEE, subventions ADEME : les enveloppes se vident. Les propri√©taires qui attendent perdent jusqu'√† 40% du budget travaux.", stat:'9 000 ‚Ç¨ en moyenne d\'aides non optimis√©es'},
                          ].map((c, i) => (
                              <div key={i} className="bg-white rounded-xl p-6 border border-slate-100 hover:shadow-lg transition-shadow">
                                  <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4" style={{backgroundColor:c.color+'15'}}>
                                      <iconify-icon icon={c.icon} style={{fontSize:'24px', color:c.color}}></iconify-icon>
                                  </div>
                                  <h3 className="text-base font-semibold text-slate-900 mb-3">{c.title}</h3>
                                  <p className="text-sm text-slate-600 leading-relaxed mb-4">{c.desc}</p>
                                  <div className="bg-slate-50 rounded-lg p-3 border-l-4" style={{borderColor:c.color}}>
                                      <p className="text-xs font-semibold text-slate-700">{c.stat}</p>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
              </section>

              {/* SECTION 4 - SOLUTION */}
              <section className="bg-white py-16">
                  <div className="max-w-6xl mx-auto px-4">
                      <SectionTitle sub="Enfin un outil adapt√© au tertiaire">Un diagnostic en 3 minutes qui change tout</SectionTitle>
                      <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-10">
                          {[
                              {icon:'solar:clock-circle-linear', color:'#2ECC71', title:'3 minutes top chrono', desc:'Quelques clics suffisent. Pas de rendez-vous, pas de visite, pas de paperasse.'},
                              {icon:'solar:target-linear', color:'#0891B2', title:'Estimation sur-mesure', desc:'Algorithme bas√© sur 12 000+ b√¢timents tertiaires. Prend en compte votre activit√©, surface, ann√©e.'},
                              {icon:'solar:calculator-linear', color:'#F39C12', title:'Chiffrage imm√©diat', desc:'Classe √©nerg√©tique + 3 priorit√©s avec co√ªts, gains et ROI. Vous savez exactement o√π vous en √™tes.'},
                              {icon:'solar:shield-check-linear', color:'#1E3A5F', title:'100% gratuit et neutre', desc:"Aucun engagement. Aucune revente de donn√©es. Aucun d√©marchage commercial."},
                          ].map((b, i) => (
                              <div key={i} className="text-center">
                                  <div className="w-14 h-14 rounded-xl flex items-center justify-center mx-auto mb-3" style={{backgroundColor:b.color+'15'}}>
                                      <iconify-icon icon={b.icon} style={{fontSize:'28px', color:b.color}}></iconify-icon>
                                  </div>
                                  <h3 className="text-sm font-semibold text-slate-900 mb-2">{b.title}</h3>
                                  <p className="text-xs text-slate-600 leading-relaxed">{b.desc}</p>
                              </div>
                          ))}
                      </div>

                      <div className="bg-gradient-to-br from-[#EEF2FF] to-[#E0F2FE] rounded-2xl p-6 border border-[#1E3A5F]/20">
                          <div className="flex items-start gap-4">
                              <iconify-icon icon="solar:chat-round-line-linear" style={{fontSize:'32px', color:'#1E3A5F', flexShrink:0}} />
                              <div>
                                  <p className="text-sm text-slate-700 italic leading-relaxed mb-2">
                                      "Je pensais que mon h√¥tel √©tait un gouffre √©nerg√©tique. Les simulateurs classiques me mettaient en classe F. Avec DiagTertiaire, j'ai d√©couvert que 280 kWh/m¬≤/an, c'est la norme pour un h√¥tel. √áa m'a rassur√© et permis de cibler les vrais probl√®mes : la r√©gulation et l'ECS. J'ai √©conomis√© 3 200 ‚Ç¨/an avec 5 000 ‚Ç¨ de travaux."
                                  </p>
                                  <p className="text-xs text-slate-500 font-medium">Sophie M., propri√©taire h√¥tel 45 chambres</p>
                              </div>
                          </div>
                      </div>

                      <div className="text-center mt-8">
                          <button type="button" onClick={() => navigate('exemple')} className="text-sm text-[#1E3A5F] hover:underline font-medium">
                              ‚Üí Voir un exemple de rapport complet
                          </button>
                      </div>
                  </div>
              </section>

              {/* SECTION 5 - COMMENT √áA MARCHE */}
              <section className="bg-gradient-to-b from-[#F8F9FA] to-white py-16">
                  <div className="max-w-6xl mx-auto px-4">
                      <SectionTitle sub="Un processus simple et transparent">Comment √ßa marche ? Suivez le guide.</SectionTitle>
                      <div className="grid md:grid-cols-4 gap-8 relative">
                          {[
                              {n:'01', icon:'solar:buildings-2-linear', color:'#1E3A5F', time:'30 sec', title:'Votre b√¢timent', items:['Activit√© (bureau/commerce/h√¥tel)','Surface et ann√©e de construction']},
                              {n:'02', icon:'solar:bolt-linear', color:'#2ECC71', time:'1 min', title:'Vos √©quipements', items:['Chauffage et consommation','Travaux d√©j√† r√©alis√©s']},
                              {n:'03', icon:'solar:inbox-linear', color:'#F39C12', time:'15 sec', title:'Votre email', items:['Pour recevoir le rapport complet','Donn√©es prot√©g√©es, jamais revendues']},
                              {n:'04', icon:'solar:document-text-linear', color:'#7B3F9E', time:'Instantan√©', title:'Votre diagnostic', items:['Classe √©nerg√©tique estim√©e','3 priorit√©s chiffr√©es','Aides mobilisables']},
                          ].map((s, i) => (
                              <div key={i} className="relative">
                                  {i < 3 && (
                                      <div className="hidden md:block absolute top-8 -right-4 z-0">
                                          <iconify-icon icon="solar:arrow-right-linear" style={{fontSize:'24px', color:'#CBD5E1'}}></iconify-icon>
                                      </div>
                                  )}
                                  <div className="relative z-10">
                                      <div className="text-5xl font-semibold text-slate-100 mb-3">{s.n}</div>
                                      <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-3" style={{backgroundColor:s.color+'15'}}>
                                          <iconify-icon icon={s.icon} style={{fontSize:'24px', color:s.color}}></iconify-icon>
                                      </div>
                                      <div className="inline-block bg-white border border-slate-200 rounded-full px-3 py-1 text-xs font-semibold text-slate-600 mb-3">{s.time}</div>
                                      <h3 className="text-sm font-semibold text-slate-900 mb-2">{s.title}</h3>
                                      <ul className="space-y-1">
                                          {s.items.map((item, j) => (
                                              <li key={j} className="text-xs text-slate-600 flex items-start gap-1.5">
                                                  <iconify-icon icon="solar:arrow-right-linear" style={{fontSize:'14px', color:s.color, flexShrink:0, marginTop:'2px'}}></iconify-icon>
                                                  {item}
                                              </li>
                                          ))}
                                      </ul>
                                  </div>
                              </div>
                          ))}
                      </div>
                      <div className="text-center mt-10">
                          <button type="button" onClick={() => navigate('diagnostic')} className="bg-[#1E3A5F] text-white px-8 py-4 rounded-xl text-base font-semibold hover:bg-[#162B47] shadow-lg transition-all inline-flex items-center gap-2">
                              Lancer mon diagnostic (√ßa prend 3 min) <Icon icon="solar:arrow-right-linear" className="text-base" />
                          </button>
                      </div>
                  </div>
              </section>

              {/* SECTION 6 - CE QUE VOUS RECEVEZ */}
              <section className="bg-white py-16">
                  <div className="max-w-6xl mx-auto px-4">
                      <SectionTitle sub="Voici exactement ce que contient votre rapport gratuit">Ce que vous recevez</SectionTitle>
                      <div className="grid md:grid-cols-2 gap-6">
                          {[
                              {title:'Votre classe √©nerg√©tique estim√©e', desc:'Jauge A √† G avec votre position et comparaison vs r√©f√©rence sectorielle'},
                              {title:'Vos 3 actions prioritaires', desc:'Pour chaque action : gain annuel en ‚Ç¨, co√ªt des travaux, ROI en ann√©es, aides mobilisables'},
                              {title:"Votre plan d'action sur 3 mois", desc:'√âtapes concr√®tes pour passer du diagnostic √† la r√©alisation'},
                              {title:'√âconomies estim√©es sur 5 et 10 ans', desc:'Projection financi√®re avec et sans travaux pour arbitrer vos investissements'},
                          ].map((r, i) => (
                              <div key={i} className="flex items-start gap-4 p-5 rounded-xl border border-slate-200 hover:border-[#1E3A5F]/30 hover:shadow-md transition-all">
                                  <div className="w-12 h-12 rounded-lg bg-[#1E3A5F]/10 flex items-center justify-center flex-shrink-0">
                                      <iconify-icon icon="solar:document-text-linear" style={{fontSize:'24px', color:'#1E3A5F'}}></iconify-icon>
                                  </div>
                                  <div>
                                      <h3 className="text-sm font-semibold text-slate-900 mb-1">{r.title}</h3>
                                      <p className="text-xs text-slate-600 leading-relaxed">{r.desc}</p>
                                  </div>
                              </div>
                          ))}
                      </div>

                      <div className="mt-8 bg-amber-50 border border-amber-200 rounded-xl p-5 flex items-start gap-3">
                          <iconify-icon icon="solar:lightbulb-linear" style={{fontSize:'24px', color:'#F39C12', flexShrink:0}} />
                          <div>
                              <p className="text-sm font-bold text-amber-900 mb-1">Sachez si √ßa vaut le coup</p>
                              <p className="text-xs text-amber-700">Avant d'investir 800 √† 1 500 ‚Ç¨ dans un audit complet, notre diagnostic vous donne les cl√©s pour d√©cider en connaissance de cause.</p>
                          </div>
                      </div>

                      <div className="text-center mt-8">
                          <button type="button" onClick={() => navigate('diagnostic')} className="bg-[#1E3A5F] text-white px-8 py-4 rounded-xl text-base font-semibold hover:bg-[#162B47] shadow-lg transition-all inline-flex items-center gap-2">
                              Je veux mon rapport gratuit <Icon icon="solar:arrow-right-linear" className="text-base" />
                          </button>
                      </div>
                  </div>
              </section>

              {/* SECTION 7 - CAS D'USAGE */}
              <section className="bg-[#F8F9FA] py-16">
                  <div className="max-w-6xl mx-auto px-4">
                      <SectionTitle sub="Des propri√©taires et locataires comme vous">Qui utilise DiagTertiaire ?</SectionTitle>

                      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
                          {[
                              {profile:'Petit propri√©taire tertiaire', icon:'solar:buildings-linear', color:'#E74C3C', quote:'J\'ai un local commercial de 180m¬≤. Tous les simulateurs en ligne m\'orientaient vers du r√©sidentiel. R√©sultat : des recommandations absurdes. Ici, en 3 min, j\'ai eu une estimation coh√©rente avec mon activit√©.', usage:'Absence d\'outil adapt√©'},
                              {profile:'Propri√©taire exploitant', icon:'solar:user-linear', color:'#2ECC71', quote:'Je voulais savoir si mes factures √©taient normales. En 3 min j\'ai su que mon b√¢timent consommait 28% de plus que la r√©f√©rence. J\'ai lanc√© un audit complet et divis√© ma facture par 2 en 18 mois.', usage:'√âvaluation patrimoine'},
                              {profile:'Gestionnaire de parc', icon:'solar:case-round-minimalistic-linear', color:'#0891B2', quote:'Je g√®re 12 b√¢timents. Impossible de tout auditer. Ce diagnostic m\'a permis d\'identifier les 3 pires consommateurs et de prioriser mes budgets.', usage:'Priorisation investissements'},
                              {profile:'Locataire bureau', icon:'solar:briefcase-linear', color:'#F39C12', quote:'Ma facture avait doubl√© en 2 ans. Gr√¢ce au rapport, j\'ai pu n√©gocier avec mon propri√©taire des travaux d\'isolation. R√©sultat : -40% sur ma facture.', usage:'N√©gociation bail vert'},
                              {profile:'Expert-comptable', icon:'solar:calculator-linear', color:'#7B3F9E', quote:'Je conseille 40 PME. Quand un client me montre ses factures √©nergie, je peux maintenant lui proposer ce diagnostic en 2 clics. √áa positionne mon cabinet comme proactif et √ßa cr√©e de la valeur ajout√©e.', usage:'Service client additionnel'},
                              {profile:'Agent immobilier', icon:'solar:home-smile-angle-linear', color:'#0891B2', quote:'Avant une mise en vente, je propose syst√©matiquement ce diagnostic. √áa me permet d\'anticiper les objections sur la performance √©nerg√©tique et de valoriser le bien si les r√©sultats sont bons.', usage:'Valorisation avant cession'},
                          ].map((c, i) => (
                              <div key={i} className="bg-white rounded-xl p-6 border border-slate-100 hover:border-[#1E3A5F]/30 hover:shadow-lg transition-all duration-300 hover:-translate-y-1 group">
                                  <div className="flex items-center gap-3 mb-4">
                                      <div className="w-12 h-12 rounded-full flex items-center justify-center transition-transform group-hover:scale-110" style={{backgroundColor:c.color+'15'}}>
                                          <iconify-icon icon={c.icon} style={{fontSize:'24px', color:c.color}} />
                                      </div>
                                      <div>
                                          <p className="text-sm font-bold text-slate-900">{c.profile}</p>
                                          <p className="text-xs text-slate-500">{c.usage}</p>
                                      </div>
                                  </div>
                                  <p className="text-sm text-slate-600 italic leading-relaxed">"{c.quote}"</p>
                              </div>
                          ))}
                      </div>
                  </div>
              </section>

              {/* SECTION 8 - FAQ */}
              <section className="bg-white py-16">
                  <div className="max-w-4xl mx-auto px-4">
                      <SectionTitle>Questions fr√©quentes</SectionTitle>
                      <div className="space-y-3">
                          {[
                              {q:'C\'est vraiment gratuit ?', r:'Oui, totalement gratuit pour vous. Aucun paiement requis. L\'outil est accessible √† tous sans condition.'},
                              {q:'Pourquoi me demander mon email ?', r:'Pour vous envoyer le rapport complet en PDF et, si vous le souhaitez, des ressources utiles pour vous accompagner dans votre r√©flexion. D√©sinscription possible √† tout moment.'},
                              {q:'Est-ce aussi pr√©cis qu\'un audit RGE ?', r:'Non. C\'est une estimation directionnelle bas√©e sur des valeurs de r√©f√©rence sectorielles. Pour un diagnostic r√©glementaire, un audit certifi√© est n√©cessaire.'},
                              {q:'Je n\'ai pas mes factures sous la main', r:'Pas grave. L\'outil peut estimer votre consommation selon votre activit√© et surface.'},
                              {q:'Combien de temps le diagnostic prend-il ?', r:'Environ 3 minutes. Si vous avez vos donn√©es de consommation √† port√©e de main, c\'est encore plus rapide.'},
                              {q:'Et apr√®s le diagnostic, que se passe-t-il ?', r:'Vous recevez le rapport par email. C\'est tout. Si vous voulez aller plus loin, vous pouvez prendre RDV (optionnel).'},
                              {q:'Je suis locataire, √ßa m\'int√©resse vraiment ?', r:'Absolument. Le rapport vous donne des arguments chiffr√©s pour demander des travaux au propri√©taire ou ren√©gocier votre bail.'},
                          ].map((faq, i) => (
                              <details key={i} className="group border border-slate-200 rounded-xl overflow-hidden">
                                  <summary className="cursor-pointer px-5 py-4 bg-white hover:bg-slate-50 flex items-center justify-between font-medium text-sm text-slate-900">
                                      {faq.q}
                                      <iconify-icon icon="solar:alt-arrow-down-linear" className="group-open:rotate-180 transition-transform" style={{fontSize:'18px', color:'#94A3B8'}} />
                                  </summary>
                                  <div className="px-5 py-4 bg-slate-50 border-t border-slate-100">
                                      <p className="text-sm text-slate-600 leading-relaxed">{faq.r}</p>
                                  </div>
                              </details>
                          ))}
                      </div>
                  </div>
              </section>

              {/* SECTION 9 - URGENCE */}
              <section className="bg-gradient-to-r from-[#1E3A5F] to-[#162B47] py-12">
                  <div className="max-w-4xl mx-auto px-4 text-center">
                      <div className="inline-flex items-center gap-2 bg-amber-500/20 border border-amber-400/30 rounded-full px-4 py-1.5 text-sm font-semibold text-amber-300 mb-4">
                          <iconify-icon icon="solar:lightbulb-linear" style={{fontSize:'16px'}}></iconify-icon>
                          Le probl√®me que personne ne r√©sout
                      </div>
                      <h2 className="text-2xl tracking-tight font-semibold text-white mb-2">Les simulateurs r√©sidentiels ne fonctionnent pas pour le tertiaire</h2>
                      <p className="text-slate-300 text-sm mb-6 max-w-2xl mx-auto">
                          Un h√¥tel qui consomme 280 kWh/m¬≤/an serait class√© F en r√©sidentiel ‚Äî alors que c'est la norme.
                          Un bureau √† 180 kWh/m¬≤/an serait consid√©r√© comme mauvais ‚Äî alors que c'est performant.
                          <strong className="text-white"> Impossible de s'y retrouver sans r√©f√©rence sectorielle.</strong>
                      </p>
                      <button type="button" onClick={() => navigate('diagnostic')} className="bg-[#2ECC71] text-white px-8 py-4 rounded-xl text-base font-semibold hover:bg-[#27AE60] shadow-lg transition-all inline-flex items-center gap-2">
                          Comparer avec la bonne r√©f√©rence (3 min) <iconify-icon icon="solar:arrow-right-linear" style={{fontSize:'18px'}}></iconify-icon>
                      </button>
                      <p className="text-xs text-slate-400 mt-3">Gratuit ‚Ä¢ Adapt√© √† votre activit√© ‚Ä¢ R√©sultat imm√©diat</p>
                  </div>
              </section>

              {/* SECTION 10 - GARANTIES */}
              <section className="bg-white py-12">
                  <div className="max-w-6xl mx-auto px-4">
                      <h3 className="text-lg font-semibold text-center text-slate-900 mb-8">Nos engagements</h3>
                      <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
                          {[
                          {icon:'solar:database-linear', color:'#0891B2', title:'Bas√© sur donn√©es publiques', desc:'Sources ADEME et observatoires r√©gionaux. R√©f√©rences sectorielles v√©rifiables et mises √† jour r√©guli√®rement.'},
                          {icon:'solar:bolt-circle-linear', color:'#F39C12', title:'R√©sultat imm√©diat', desc:"Pas de rendez-vous. Pas d'attente. Rapport PDF t√©l√©chargeable en 3 minutes."},
                          {icon:'solar:hand-shake-linear', color:'#2ECC71', title:'Gratuit et sans engagement', desc:'Aucun paiement. Aucune obligation. Vous d√©cidez si vous voulez aller plus loin.'},
                          {icon:'solar:user-check-linear', color:'#1E3A5F', title:'Utilisation claire des donn√©es', desc:'Vos donn√©es peuvent √™tre partag√©es avec des partenaires qualifi√©s si vous le souhaitez. Contr√¥le total sur vos choix.'}
                        ].map((g, i) => (
                              <div key={i} className="text-center p-5 rounded-xl border border-slate-100 hover:border-slate-200 transition-colors">
                                  <div className="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style={{backgroundColor:g.color+'15'}}>
                                      <iconify-icon icon={g.icon} style={{fontSize:'24px', color:g.color}}></iconify-icon>
                                  </div>
                                  <h4 className="text-sm font-semibold text-slate-900 mb-1">{g.title}</h4>
                                  <p className="text-xs text-slate-600 leading-relaxed">{g.desc}</p>
                              </div>
                          ))}
                      </div>
                  </div>
              </section>

              {/* SECTION 11 - CTA FINAL */}
              <section className="bg-gradient-to-br from-[#2ECC71] to-[#27AE60] py-16">
                  <div className="max-w-4xl mx-auto px-4 text-center">
                      <h2 className="text-3xl tracking-tight font-semibold text-white mb-3">Pr√™t √† savoir combien vous pourriez √©conomiser chaque ann√©e ?</h2>
                      <p className="text-lg text-white/90 mb-8">3 minutes. Gratuit. Sans engagement.</p>
                      <button type="button" onClick={() => navigate('diagnostic')} className="bg-white text-[#2ECC71] font-semibold px-12 py-4 rounded-xl hover:bg-slate-50 transition-all shadow-xl text-base inline-flex items-center gap-2">
                          Lancer mon diagnostic √©nerg√©tique <iconify-icon icon="solar:arrow-right-linear" style={{fontSize:'20px'}}></iconify-icon>
                      </button>
                      <div className="flex flex-wrap justify-center gap-6 text-sm text-white/80 mt-6">
                          <span className="flex items-center gap-1"><iconify-icon icon="solar:check-circle-bold" style={{fontSize:'16px'}}></iconify-icon> 1 247 diagnostics ce mois</span>
                          <span className="flex items-center gap-1"><iconify-icon icon="solar:check-circle-bold" style={{fontSize:'16px'}}></iconify-icon> Note moyenne 4.8/5</span>
                          <span className="flex items-center gap-1"><iconify-icon icon="solar:check-circle-bold" style={{fontSize:'16px'}}></iconify-icon> D√©j√† 4,2M‚Ç¨ identifi√©s</span>
                      </div>
                      <p className="text-xs text-white/60 mt-4">En continuant, vous acceptez notre politique de confidentialit√©. D√©sinscription en 1 clic.</p>
                  </div>
              </section>
          </div>
      );

      const PageMethod = ({ navigate }) => (
          <div className="fade-in">
              <section className="bg-[#F8F9FA] py-16 text-center px-4">
                  <div className="inline-flex items-center gap-2 bg-[#EEF2FF] text-[#1E3A5F] px-3 py-1 rounded-full text-xs font-semibold mb-4">
                      <Icon icon="solar:shield-check-linear" /> Notre d√©marche
                  </div>
                  <h1 className="text-3xl md:text-4xl tracking-tight font-semibold text-[#1E3A5F] mb-4">Un constat de terrain.<br/>Une r√©ponse accessible.</h1>
                  <p className="text-[#6B7280] max-w-2xl mx-auto">
                      DiagTertiaire aide les propri√©taires de PME √† cadrer leurs enjeux √©nerg√©tiques avant d'investir dans un audit complet.
                  </p>
              </section>
          </div>
      );

      const PageExample = ({ navigate }) => {
          const FAKE_DATA = {
              activity: 'office', activityMixPct: 0, year: 'pre1975', surface: 450, levels: 2,
              heating: 'gas', heatingAge: '> 15 ans', occupation: 'semaine',
              consumptionMode: 'kwh', elecKwh: 45000, gasKwh: 146700,
              noData: false, works: [], hasWorks: 'no', ecsSystem: '',
              firstName: 'Jean', email: 'jean@exemple.com', consent: true
          };

          return (
              <div className="fade-in bg-[#F8F9FA] min-h-screen">
                  <div className="py-12 text-center px-4">
                      <h1 className="text-3xl tracking-tight font-semibold text-[#1E3A5F] mb-2">√Ä quoi ressemble votre rapport ?</h1>
                      <p className="text-[#6B7280]">Exemple pour un bureau de 450m¬≤ construit avant 1975.</p>
                  </div>
                  <div className="max-w-4xl mx-auto px-4 pb-12">
                      <StepReport data={FAKE_DATA} />
                  </div>
              </div>
          );
      };

      const PagePro = ({ navigate }) => (
          <div className="fade-in">
              <section className="bg-[#1E3A5F] py-20 text-center text-white px-4">
                  <h1 className="text-4xl tracking-tight font-semibold mb-4">Pour les professionnels du chiffre</h1>
                  <p className="text-lg text-blue-200 max-w-2xl mx-auto mb-8">
                      Proposez un outil de cadrage √©nerg√©tique √† vos clients tertiaires (comptables, notaires, assureurs).
                  </p>
                  <a
  href={CTA_CALENDLY_URL}
  target="_blank"
  rel="noopener noreferrer"
  className="block w-full bg-white text-[#1E3A5F] font-semibold text-center py-3 rounded-lg hover:bg-slate-100 transition-colors"
>
  üìÖ R√©server mon rendez-vous ‚Üí
</a>
              </section>
          </div>
      );

      const RestoreBanner = ({ onDismiss, onRestart }) => (
          <div className="w-full bg-[#EEF2FF] border-b border-[#1E3A5F]/20 px-4 py-2.5 flex items-center justify-between gap-4 no-print">
              <div className="flex items-center gap-2 text-[#1E3A5F] text-sm">
                  <Icon icon="solar:history-linear" className="shrink-0 text-base" />
                  <span className="font-medium">Reprendre votre estimation en cours ?</span>
              </div>
              <div className="flex items-center gap-3">
                  <button type="button" onClick={onRestart} className="text-xs font-semibold text-red-600 hover:text-red-800 underline">Effacer</button>
                  <button type="button" onClick={onDismiss} className="text-slate-400 hover:text-slate-600">
                      <Icon icon="solar:close-circle-linear" className="text-base" />
                  </button>
              </div>
          </div>
      );

      /* --- APP ROOT --- */
      const App = () => {
          const [currentPage, setCurrentPage] = useState('home');
          const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
          const [diagStep, setDiagStep] = useState(1);
          const [showRestoreBanner, setShowRestoreBanner] = useState(false);

          const [formData, setFormData] = useState(() => {
              const saved = loadFromLS();
              return (saved && saved._hasData) ? { ...DEFAULT_FORM, ...saved } : { ...DEFAULT_FORM };
          });

          useEffect(() => {
              const saved = loadFromLS();
              if (saved && saved._hasData) setShowRestoreBanner(true);
          }, []);

          const saveTimeout = useRef(null);
          useEffect(() => {
              if (saveTimeout.current) clearTimeout(saveTimeout.current);
              saveTimeout.current = setTimeout(() => {
                  const hasData = !!(formData.address || formData.activity || formData.year);
                  if (hasData) saveToLS({ ...formData, _hasData: true });
              }, 600);
              return () => { if (saveTimeout.current) clearTimeout(saveTimeout.current); };
          }, [formData]);

          const updateForm = useCallback((field, value) => {
              setFormData(prev => ({ ...prev, [field]: value }));
          }, []);

          const handleRestart = () => {
              clearLS();
              setFormData({ ...DEFAULT_FORM });
              setDiagStep(1);
              setShowRestoreBanner(false);
          };

          const navigate = (page) => {
              setCurrentPage(page);
              setIsMobileMenuOpen(false);
              window.scrollTo(0, 0);
          };

          const NavLink = ({ page, label }) => (
              <button type="button"
                  onClick={() => navigate(page)}
                  className={`text-sm font-medium transition-colors ${currentPage === page ? 'text-[#1E3A5F] font-semibold border-b-2 border-[#1E3A5F]' : 'text-[#6B7280] hover:text-[#1E3A5F]'}`}
              >
                  {label}
              </button>
          );

          return (
              <div className="min-h-screen flex flex-col">
                  {showRestoreBanner && <RestoreBanner onDismiss={() => setShowRestoreBanner(false)} onRestart={handleRestart} />}

                  <nav className="bg-white border-b border-slate-200 sticky top-0 z-50">
                      <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                          <div className="flex items-center gap-2 text-[#1E3A5F] cursor-pointer" onClick={() => navigate('home')}>
                              <Icon icon="solar:buildings-2-linear" />
                              <span className="font-semibold text-lg">DiagTertiaire</span>
                          </div>

                          <div className="hidden md:flex gap-8">
                              <NavLink page="home" label="Accueil" />
                              <NavLink page="methode" label="Approche" />
                              <NavLink page="exemple" label="Rapport" />
                              <NavLink page="pro" label="Espace Pro" />
                          </div>

                          <div className="hidden md:block">
                              <button type="button" onClick={() => navigate('diagnostic')} className="bg-[#1E3A5F] text-white px-4 py-2 rounded-lg text-xs font-semibold hover:bg-[#162B47]">
                                  D√©marrer ‚Üí
                              </button>
                          </div>

                          <button type="button" className="md:hidden text-[#1E3A5F]" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
                              <Icon icon={isMobileMenuOpen ? "solar:close-square-linear" : "solar:hamburger-menu-linear"} />
                          </button>
                      </div>

                      {isMobileMenuOpen && (
                          <div className="md:hidden bg-white border-t border-slate-100 p-4 flex flex-col gap-4">
                              <NavLink page="home" label="Accueil" />
                              <NavLink page="methode" label="Notre approche" />
                              <NavLink page="exemple" label="Exemple de rapport" />
                              <NavLink page="pro" label="Espace Pro" />
                          </div>
                      )}
                  </nav>

                  <main className="flex-1">
                      {currentPage === 'home' && <PageHome navigate={navigate} />}

                      {currentPage === 'diagnostic' && (
                          <div className="max-w-4xl mx-auto px-4 py-8">
                              {diagStep < 4 && <Stepper currentStep={diagStep} />}

                              {diagStep === 1 && <StepBuilding data={formData} update={updateForm} onNext={() => setDiagStep(2)} />}
                              {diagStep === 2 && <StepEnergy data={formData} update={updateForm} onNext={() => setDiagStep(3)} onBack={() => setDiagStep(1)} />}
                              {diagStep === 3 && <StepLead data={formData} update={updateForm} onNext={() => setDiagStep(4)} onBack={() => setDiagStep(2)} />}
                              {diagStep === 4 && <StepReport data={formData} />}
                          </div>
                      )}

                      {currentPage === 'methode' && <PageMethod navigate={navigate} />}
                      {currentPage === 'exemple' && <PageExample navigate={navigate} />}
                      {currentPage === 'pro' && <PagePro navigate={navigate} />}
                  </main>

                  {currentPage !== 'diagnostic' && (
                      <footer className="bg-[#1E3A5F] py-12">
          <div className="max-w-6xl mx-auto px-4">
            <div className="grid md:grid-cols-4 gap-8 mb-8">
              
              <div>
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                    <iconify-icon icon="solar:buildings-2-linear" style={{color:'white', fontSize:'18px'}} />
                  </div>
                  <span className="font-bold text-white">DiagTertiaire</span>
                </div>
                <p className="text-sm text-slate-400 leading-relaxed mb-4">Estimation directionnelle bas√©e sur valeurs de r√©f√©rence sectorielles</p>
                <div className="space-y-2">
                  <button type="button" onClick={() => navigate('home')} className="block text-sm text-slate-300 hover:text-white transition-colors">√Ä propos</button>
                  <button type="button" className="block text-sm text-slate-300 hover:text-white transition-colors">Notre m√©thodologie</button>
                  <a href="mailto:contact@diagtertiaire.fr" className="block text-sm text-slate-300 hover:text-white transition-colors">Contact</a>
                </div>
              </div>

              <div>
                <h4 className="text-sm font-bold text-white mb-3">Ressources</h4>
                <ul className="space-y-2">
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Guide du d√©cret tertiaire</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">R√©f√©rences ADEME</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Blog</button></li>
                  <li><button type="button" onClick={() => navigate('exemple')} className="text-sm text-slate-300 hover:text-white transition-colors">Exemple de rapport</button></li>
                </ul>
              </div>

              <div>
                <h4 className="text-sm font-bold text-white mb-3">L√©gal</h4>
                <ul className="space-y-2">
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Mentions l√©gales</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Politique de confidentialit√©</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">CGU</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Gestion des cookies</button></li>
                </ul>
              </div>

              <div>
                <h4 className="text-sm font-bold text-white mb-3">Professionnel</h4>
                <ul className="space-y-2">
                  <li><button type="button" onClick={() => navigate('pro')} className="text-sm text-slate-300 hover:text-white transition-colors">Espace pro</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">Devenir partenaire</button></li>
                  <li><button type="button" className="text-sm text-slate-300 hover:text-white transition-colors">API & Int√©grations</button></li>
                </ul>
              </div>
            </div>

            <div className="pt-6 border-t border-white/10 flex flex-wrap justify-between items-center gap-4">
              <p className="text-xs text-slate-400">¬© 2026 DiagTertiaire ‚Ä¢ Estimations bas√©es sur donn√©es ADEME</p>
              <div className="flex items-center gap-3">
                {['SSL','RGPD','üá´üá∑ FR'].map((b, i) => (
                  <span key={i} className="text-xs text-slate-400 bg-white/5 px-2 py-1 rounded">{b}</span>
                ))}
              </div>
            </div>
          </div>
        </footer>
                  )}
              </div>
          );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  
</body></html>
  